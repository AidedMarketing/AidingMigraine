<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aiding Migraine</title>

    <!-- PWA Configuration -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#7ba68a">
    <meta name="description" content="Track and manage your migraine symptoms with ease">

    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AidMigraine">
    <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="16x16" href="./icons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512x512.png">

    <style>
        /* ============================================
           AIDING MIGRAINE v1.6.0 - WEEK 3 POLISH
           ============================================ */

        /* === ROOT VARIABLES (DARK - DEFAULT) === */
        :root {
            --bg-primary: #1a1d24;
            --bg-secondary: #252930;
            --bg-tertiary: #2f3339;
            --text-primary: #e8e6e3;
            --text-secondary: #c7c3bb;
            --border-color: #3a3f47;
            --accent-green: #7ba68a;
            --accent-red: #c96868;
            --accent-blue: #6b8bb8;
            --pain-mild: #7ba68a;
            --pain-moderate: #d4a574;
            --pain-severe: #c96868;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --radius: 12px;
            --transition: all 0.2s ease;
        }

        /* === LIGHT THEME OVERRIDE === */
        :root[data-theme="light"] {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8e8e8;
            --text-primary: #2a2a2a;
            --text-secondary: #666666;
            --border-color: #d0d0d0;
            --accent-green: #4a7c59;
            --accent-red: #b85050;
            --accent-blue: #4a6b9e;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* === BASE STYLES === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding-bottom: 80px;
            transition: var(--transition);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 24px;
            font-weight: 600;
            text-align: center;
            position: relative;
        }

        .help-icon {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--accent-green);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            text-decoration: none;
        }

        .help-icon:hover {
            transform: scale(1.1);
            background: #6b9177;
        }

        h2 {
            font-size: 1.3rem;
            margin-bottom: 16px;
            font-weight: 500;
            text-align: center;
        }

        .section-card {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .active-episode-card {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 2px solid var(--accent-green);
        }

        .active-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .pulse-indicator {
            font-size: 1.5rem;
            animation: pulse 3.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.75; }  /* Gentler fade - less jarring */
        }

        .active-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent-green);
        }

        .active-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .relief-quick-btn:hover {
            background: var(--bg-primary) !important;
            border-color: var(--accent-green) !important;
            transform: scale(1.02);
        }

        .relief-quick-btn:active {
            transform: scale(0.98);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            text-align: center;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: var(--transition);
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .pain-scale {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }

        .pain-btn {
            padding: 12px 8px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pain-btn:hover {
            background: var(--bg-secondary);
            transform: translateY(-2px);
        }

        .pain-btn.selected {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: white;
        }

        .pain-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .optional-details {
            margin: 20px 0;
        }

        .toggle-details-btn {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-details-btn:hover {
            background: var(--bg-secondary);
        }

        #details-arrow {
            transition: transform 0.2s ease;
        }

        #details-arrow.rotated {
            transform: rotate(-90deg);
        }

        .optional-details-content {
            padding-top: 16px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
        }

        .btn-primary {
            background: var(--accent-green);
            color: white;
        }

        .btn-primary:hover {
            background: #6a957a;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
        }

        .stat-box {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-green);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .stat-comparison {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .calendar-nav-btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .calendar-nav-btn:hover {
            background: var(--bg-secondary);
        }

        .analytics-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
            margin-top: 16px;
        }

        /* Weather Correlation Styles */
        .correlation-summary {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .correlation-stat {
            text-align: center;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .correlation-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .correlation-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-green);
            margin-bottom: 4px;
        }

        .correlation-desc {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .correlation-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .detail-row span {
            color: var(--text-secondary);
        }

        .detail-row strong {
            color: var(--text-primary);
        }

        /* Compact monthly stats for calendar */
        .monthly-stats-compact {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            margin-top: 16px;
            border: 1px solid var(--border-color);
        }

        .stat-line {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .stat-line:last-child {
            margin-bottom: 0;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-text {
            font-size: 1rem;
            color: var(--text-primary);
            margin-left: 4px;
        }

        .stat-trend {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 2px 10px;
            border-radius: 12px;
            margin-left: 8px;
        }

        .stat-trend.positive {
            background: rgba(255, 107, 107, 0.15);
            color: var(--pain-severe);
        }

        .stat-trend.negative {
            background: rgba(76, 175, 80, 0.15);
            color: var(--accent-green);
        }

        .stat-trend.neutral {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .stat-label-text {
            font-weight: 600;
            color: var(--text-secondary);
            margin-right: 6px;
        }

        .stat-status {
            font-weight: 600;
        }

        /* Analytics page stat cards */
        .stat-card {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 16px;
            display: inline-block;
        }

        .stat-change.positive {
            background: rgba(255, 107, 107, 0.15);
            color: var(--pain-severe);
        }

        .stat-change.negative {
            background: rgba(76, 175, 80, 0.15);
            color: var(--accent-green);
        }

        .stat-change.neutral {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--bg-secondary);
        }

        .calendar-day.empty {
            background: transparent;
            cursor: default;
        }

        .calendar-day.today {
            border-color: var(--accent-blue);
        }

        .calendar-day.has-episode {
            font-weight: 600;
        }

        .calendar-day.mild {
            background: var(--pain-mild);
            color: white;
        }

        .calendar-day.moderate {
            background: var(--pain-moderate);
            color: white;
        }

        .calendar-day.severe {
            background: var(--pain-severe);
            color: white;
        }

        .calendar-day.mild-continuation {
            background: rgba(123, 166, 138, 0.35);
            color: white;
        }

        .calendar-day.moderate-continuation {
            background: rgba(212, 165, 116, 0.35);
            color: white;
        }

        .calendar-day.severe-continuation {
            background: rgba(201, 104, 104, 0.35);
            color: white;
        }

        .calendar-day.active-indicator::after {
            content: '‚ö°';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.7rem;
        }

        .pressure-indicator {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 0.65rem;
            font-weight: 700;
            opacity: 0.8;
        }

        .calendar-legend {
            display: flex;
            gap: 16px;
            justify-content: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .legend-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .legend-dot.mild {
            background: var(--pain-mild);
        }

        .legend-dot.moderate {
            background: var(--pain-moderate);
        }

        .legend-dot.severe {
            background: var(--pain-severe);
        }

        #history-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .history-item {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .history-item:hover {
            border-color: var(--accent-green);
            transform: translateX(4px);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .history-date {
            font-size: 1rem;
            font-weight: 600;
        }

        .history-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .history-details {
            display: flex;
            gap: 20px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .history-detail {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-green);
        }

        .history-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .history-actions button {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .settings-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .info-label {
            color: var(--text-secondary);
        }

        .info-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .settings-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .settings-btn {
            width: 100%;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .settings-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-green);
        }

        .settings-btn.danger {
            border-color: var(--accent-red);
        }

        .settings-btn.danger:hover {
            background: rgba(201, 104, 104, 0.1);
        }

        .btn-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-label {
            display: block;
            margin-bottom: 12px;
            font-weight: 500;
            text-align: center;
        }

        .theme-options {
            display: flex;
            gap: 12px;
        }

        .theme-btn {
            flex: 1;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .theme-btn:hover {
            background: var(--bg-secondary);
        }

        .theme-btn.active {
            border-color: var(--accent-green);
            background: var(--bg-secondary);
        }

        .theme-btn span:first-child {
            font-size: 1.5rem;
        }

        .theme-btn span:last-child {
            font-size: 0.9rem;
        }

        /* === TOGGLE SWITCH === */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--accent-green);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .app-info {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .nav-btn:hover {
            color: var(--text-primary);
        }

        .nav-btn.active {
            color: var(--accent-green);
        }

        .nav-icon {
            font-size: 1.5rem;
        }

        .nav-label {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.3rem;
            text-align: left;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
            line-height: 1.8;
        }

        .modal-body h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--accent-green);
        }

        .modal-body p {
            margin-bottom: 12px;
        }

        .modal-body ul {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .modal-actions {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-actions .btn {
            width: auto;
            min-width: 100px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 16px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .pain-scale {
                gap: 6px;
            }

            .pain-btn {
                min-height: 44px;
                font-size: 0.95rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .theme-options {
                flex-direction: column;
            }

            .theme-btn {
                flex-direction: row;
                justify-content: flex-start;
            }
        }

        /* Update Banner */
        .update-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .update-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            max-width: 600px;
            margin: 0 auto;
        }

        .update-icon {
            font-size: 1.2rem;
        }

        .update-text {
            font-weight: 600;
            flex: 1;
            text-align: left;
        }

        .update-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .update-btn:hover {
            transform: scale(1.05);
        }

        .update-btn:active {
            transform: scale(0.95);
        }

        .dismiss-update-btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 8px;
            line-height: 1;
            opacity: 0.8;
        }

        .dismiss-update-btn:hover {
            opacity: 1;
        }

        /* Push content down when banner is visible */
        .container {
            transition: margin-top 0.3s ease;
        }

        .container.with-update-banner {
            margin-top: 60px;
        }

        /* ============================================
           ACCESSIBILITY: REDUCED MOTION SUPPORT
           ============================================ */

        /* Respect user's motion preferences - critical for migraine sufferers */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }

            /* Completely disable the pulse animation */
            .pulse-indicator {
                animation: none !important;
                opacity: 1 !important;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Update Available Banner -->
    <div id="update-banner" class="update-banner" style="display: none;">
        <div class="update-content">
            <span class="update-icon">‚ú®</span>
            <span class="update-text">New version available!</span>
            <button id="update-btn" class="update-btn">Update Now</button>
            <button id="dismiss-update-btn" class="dismiss-update-btn">√ó</button>
        </div>
    </div>

    <div class="container">
        <div id="log-page" class="page active">
            <h1>
                Aiding Migraine
                <a href="./help/index.html" class="help-icon" title="Help & Documentation">?</a>
            </h1>
            
            <div id="active-episode-section" style="display: none;">
                <div class="active-episode-card">
                    <div class="active-header">
                        <span class="pulse-indicator">‚ö°</span>
                        <h2>Active Episode</h2>
                    </div>
                    <div class="active-stats">
                        <div class="stat-item">
                            <span class="stat-label">Duration</span>
                            <span id="active-duration" class="stat-value">0h 0m</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Pain Level</span>
                            <span id="active-pain-display" class="stat-value">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Category</span>
                            <span id="active-category" class="stat-value">-</span>
                        </div>
                    </div>

                    <!-- Relief Methods Timeline -->
                    <div id="active-relief-timeline" style="display: none; margin: 20px 0; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 0.85rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 12px;">Relief Methods</div>
                        <div id="relief-timeline-entries" style="display: flex; flex-direction: column; gap: 8px;">
                            <!-- Timeline entries will be added here -->
                        </div>
                    </div>

                    <!-- Add Relief Method Section -->
                    <div id="add-relief-section" style="margin: 20px 0;">
                        <button id="add-relief-btn" class="btn btn-secondary" style="width: 100%; margin-bottom: 12px;">
                            <span>‚ûï Add Relief Method</span>
                        </button>

                        <!-- Expandable Relief Method Input -->
                        <div id="relief-input-section" style="display: none; padding: 16px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 12px;">
                            <div style="font-size: 0.9rem; font-weight: 500; margin-bottom: 12px;">Quick Add:</div>

                            <!-- Quick Action Buttons -->
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px;">
                                <button class="relief-quick-btn" data-relief="Medication" style="padding: 14px; background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 0.95rem; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 1.3rem;">üíä</span>
                                    <span>Medication</span>
                                </button>
                                <button class="relief-quick-btn" data-relief="Ice/Cold Therapy" style="padding: 14px; background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 0.95rem; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 1.3rem;">üßä</span>
                                    <span>Ice/Cold</span>
                                </button>
                                <button class="relief-quick-btn" data-relief="Hydration/Electrolytes" style="padding: 14px; background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 0.95rem; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 1.3rem;">üíß</span>
                                    <span>Hydration</span>
                                </button>
                                <button class="relief-quick-btn" data-relief="Dark/Quiet Room" style="padding: 14px; background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 0.95rem; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 1.3rem;">üåë</span>
                                    <span>Dark/Quiet</span>
                                </button>
                                <button class="relief-quick-btn" data-relief="Rest/Sleep" style="padding: 14px; background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 0.95rem; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 1.3rem;">üò¥</span>
                                    <span>Rest/Sleep</span>
                                </button>
                                <button class="relief-quick-btn" data-relief="Caffeine" style="padding: 14px; background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 0.95rem; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 1.3rem;">‚òï</span>
                                    <span>Caffeine</span>
                                </button>
                            </div>

                            <div style="font-size: 0.9rem; font-weight: 500; margin-bottom: 8px;">Or add custom note:</div>
                            <input type="text" id="custom-relief-input" placeholder="e.g., Sumatriptan 100mg, warm shower, etc." style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; margin-bottom: 12px;">

                            <div style="display: flex; gap: 10px;">
                                <button id="save-relief-btn" class="btn btn-primary" style="flex: 1;">Save</button>
                                <button id="cancel-relief-btn" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div class="active-actions">
                        <button id="update-pain-btn" class="btn btn-secondary">Update Pain Level</button>
                        <button id="end-episode-btn" class="btn btn-primary">End Episode</button>
                    </div>
                </div>
            </div>

            <div id="logging-section">
                <div class="section-card">
                    <h2>Log New Episode</h2>

                    <!-- Weather Forecast Indicator -->
                    <div id="weather-forecast-indicator" style="display: none; margin-bottom: 20px;">
                        <!-- Clear Day State -->
                        <div id="weather-clear" class="weather-forecast-box" style="display: none; background: rgba(123, 166, 138, 0.1); border-left: 4px solid var(--accent-green); padding: 12px 16px; border-radius: 0 8px 8px 0;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.2rem;">‚úÖ</span>
                                <div>
                                    <div style="font-size: 0.9rem; font-weight: 500; color: var(--accent-green);">Clear Conditions</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px;">No significant pressure changes</div>
                                </div>
                            </div>
                        </div>
                        <!-- Pressure Warning State -->
                        <div id="weather-warning" class="weather-forecast-box" style="display: none; background: rgba(212, 165, 116, 0.12); border-left: 4px solid #d4a574; padding: 12px 16px; border-radius: 0 8px 8px 0;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.2rem;">üå¶Ô∏è</span>
                                <div>
                                    <div style="font-size: 0.9rem; font-weight: 500; color: #d4a574;">Weather May Be a Factor</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px;" id="weather-warning-detail">Significant pressure change in last 24h</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Pain Intensity</label>
                        <div class="pain-scale">
                            <button class="pain-btn" data-pain="0">0</button>
                            <button class="pain-btn" data-pain="1">1</button>
                            <button class="pain-btn" data-pain="2">2</button>
                            <button class="pain-btn" data-pain="3">3</button>
                            <button class="pain-btn" data-pain="4">4</button>
                            <button class="pain-btn" data-pain="5">5</button>
                            <button class="pain-btn" data-pain="6">6</button>
                            <button class="pain-btn" data-pain="7">7</button>
                            <button class="pain-btn" data-pain="8">8</button>
                            <button class="pain-btn" data-pain="9">9</button>
                            <button class="pain-btn" data-pain="10">10</button>
                        </div>
                        <div class="pain-labels">
                            <span>No Pain</span>
                            <span>Worst Pain</span>
                        </div>
                    </div>

                    <div class="optional-details">
                        <button id="toggle-details-btn" class="toggle-details-btn">
                            <span id="details-arrow">‚ñº</span> Optional Details
                        </button>
                        <div id="optional-details-content" class="optional-details-content" style="display: none;">
                            <div class="form-group">
                                <label>üíä Medication Taken (optional)</label>
                                <div id="medications-list" style="margin-bottom: 12px;"></div>
                                <button type="button" id="add-medication-btn" class="btn btn-secondary" style="width: 100%; padding: 10px;">
                                    + Add Medication
                                </button>
                            </div>

                            <div class="form-group">
                                <label>Quick Notes (optional)</label>
                                <textarea id="notes-input" placeholder="Add any notes about this episode..." rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button id="clear-btn" class="btn btn-secondary">Clear</button>
                        <button id="log-btn" class="btn btn-primary">Log Episode</button>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h2>Your Stats</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-number" id="total-episodes">0</div>
                        <div class="stat-label">Episodes</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="avg-pain">0</div>
                        <div class="stat-label">Avg Pain</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="week-count">0</div>
                        <div class="stat-label">This Week</div>
                        <div class="stat-comparison" id="week-comparison"></div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="last-episode">-</div>
                        <div class="stat-label">Last Episode</div>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h2>Calendar View</h2>
                <div class="calendar-header">
                    <button id="prev-month" class="calendar-nav-btn">‚Üê</button>
                    <h3 id="current-month"></h3>
                    <button id="next-month" class="calendar-nav-btn">‚Üí</button>
                </div>

                <!-- Monthly Stats Summary -->
                <div id="monthly-stats" class="monthly-stats-compact">
                    <div class="stat-line">
                        <span id="current-month-days" class="stat-number">-</span>
                        <span class="stat-text">migraine days</span>
                        <span id="month-trend" class="stat-trend"></span>
                    </div>
                    <div class="stat-line">
                        <span class="stat-label-text">Status:</span>
                        <span id="current-month-status" class="stat-status">-</span>
                    </div>
                </div>

                <div id="calendar-grid" class="calendar-grid"></div>
                <div class="calendar-legend">
                    <span><span class="legend-dot severe"></span> Attack Start</span>
                    <span style="opacity: 0.5;">Faded = Continuation Days</span>
                </div>
            </div>
        </div>

        <div id="history-page" class="page">
            <h1>
                Episode History
                <a href="./help/index.html" class="help-icon" title="Help & Documentation">?</a>
            </h1>
            <div id="history-list"></div>
        </div>

        <div id="analytics-page" class="page">
            <h1>
                Analytics & Insights
                <a href="./help/analytics.html" class="help-icon" title="Understanding Your Analytics">?</a>
            </h1>

            <!-- Date Range Selector -->
            <div class="section-card">
                <label for="analytics-range" style="display: block; margin-bottom: 8px; font-weight: 600;">Time Period</label>
                <select id="analytics-range" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                    <option value="90">Last 3 Months</option>
                    <option value="180" selected>Last 6 Months</option>
                    <option value="365">Last Year</option>
                    <option value="all">All Time</option>
                </select>
            </div>

            <!-- Key Metrics Grid -->
            <div class="analytics-metrics">
                <div class="stat-card">
                    <div class="stat-value" id="analytics-total-days">-</div>
                    <div class="stat-label">Total Migraine Days</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="analytics-avg-month">-</div>
                    <div class="stat-label">Average Per Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="analytics-avg-pain">-</div>
                    <div class="stat-label">Average Pain Level</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="analytics-avg-duration">-</div>
                    <div class="stat-label">Average Duration</div>
                </div>
            </div>

            <!-- Frequency Trend Chart -->
            <div class="section-card">
                <h2>Migraine Frequency Trend</h2>
                <p style="color: var(--text-secondary); margin-bottom: 16px;">Migraine days per month over time</p>
                <canvas id="frequency-chart"></canvas>
            </div>

            <!-- Pain Level Distribution -->
            <div class="section-card">
                <h2>Pain Level Distribution</h2>
                <p style="color: var(--text-secondary); margin-bottom: 16px;">Breakdown of pain severity</p>
                <canvas id="pain-chart"></canvas>
            </div>

            <!-- Time of Day Patterns -->
            <div class="section-card">
                <h2>Time of Day Patterns</h2>
                <p style="color: var(--text-secondary); margin-bottom: 16px;">When migraines typically start</p>
                <canvas id="time-chart"></canvas>
            </div>

            <!-- Day of Week Patterns -->
            <div class="section-card">
                <h2>Day of Week Patterns</h2>
                <p style="color: var(--text-secondary); margin-bottom: 16px;">Which days have the most migraines</p>
                <canvas id="dow-chart"></canvas>
            </div>

            <!-- Weather Correlation (if enabled) -->
            <div id="weather-correlation-card" class="section-card" style="display: none;">
                <h2>‚òÅÔ∏è Weather Correlation</h2>
                <p style="color: var(--text-secondary); margin-bottom: 16px;">Relationship between barometric pressure changes and migraines</p>

                <div class="correlation-summary">
                    <div class="correlation-stat">
                        <div class="correlation-label">Correlation Strength</div>
                        <div id="correlation-strength" class="correlation-value">-</div>
                        <div id="correlation-description" class="correlation-desc">-</div>
                    </div>
                    <div class="correlation-details">
                        <div class="detail-row">
                            <span>Significant pressure changes:</span>
                            <strong id="correlation-changes">-</strong>
                        </div>
                        <div class="detail-row">
                            <span>Migraines on change days:</span>
                            <strong id="correlation-migraines">-</strong>
                        </div>
                        <div class="detail-row">
                            <span>Correlation percentage:</span>
                            <strong id="correlation-percent">-</strong>
                        </div>
                    </div>
                </div>

                <div class="info-box" style="margin-top: 16px; font-size: 0.9rem;">
                    <strong>Understanding correlation:</strong> Clinically validated thresholds: >5 hPa in 24 hours (slow changes) or >5 hPa in 6 hours (rapid changes).
                    Research shows 50% of migraines occur when pressure is 1003-1007 hPa (Okuma 2015).
                    <strong>Strong correlation (‚â•70%)</strong> suggests high weather sensitivity.
                    <strong>Moderate (40-70%)</strong> suggests possible sensitivity.
                    <strong>Weak (<40%)</strong> suggests low weather sensitivity.
                </div>
            </div>

            <!-- Pressure Trend Chart (if enabled) -->
            <div id="pressure-chart-card" class="section-card" style="display: none;">
                <h2>Barometric Pressure Trends</h2>
                <p style="color: var(--text-secondary); margin-bottom: 16px;">Pressure changes and migraine occurrences</p>
                <canvas id="pressure-chart"></canvas>
                <div style="margin-top: 12px; font-size: 0.85rem; color: var(--text-secondary); text-align: center;">
                    Red vertical bars indicate migraine days ‚Ä¢ Dotted line shows clinical threshold (¬±5 hPa change)
                </div>
            </div>

            <!-- Medication Effectiveness -->
            <div id="medication-effectiveness-card" class="section-card" style="display: none;">
                <h2>üíä Medication Effectiveness</h2>
                <p style="color: var(--text-secondary); margin-bottom: 16px;">Average effectiveness ratings for each medication</p>
                <div id="medication-effectiveness-content"></div>
            </div>

            <!-- Medication Usage & MOH Warning -->
            <div id="medication-usage-card" class="section-card" style="display: none;">
                <h2>üíä Medication Usage</h2>
                <p style="color: var(--text-secondary); margin-bottom: 16px;">Tracking medication usage frequency</p>
                <div id="moh-warning" style="display: none; margin-bottom: 24px; padding: 20px; background: rgba(220, 38, 38, 0.15); border-left: 4px solid #dc2626; border-radius: 8px;">
                    <h3 style="color: #dc2626; margin-bottom: 12px;">‚ö†Ô∏è MEDICATION OVERUSE WARNING</h3>
                    <p style="margin-bottom: 12px;">
                        You've used abortive medication on <strong id="moh-days-this-month">0</strong> days this month.
                    </p>
                    <p style="margin-bottom: 12px; color: var(--text-secondary);">
                        Using medication >10 days/month for >3 months can cause Medication Overuse Headache (MOH), making migraines worse.
                    </p>
                    <div style="margin: 16px 0; padding: 12px; background: var(--bg-tertiary); border-radius: 6px;">
                        <strong>üìÖ Usage Last 3 Months:</strong>
                        <div id="moh-three-months" style="margin-top: 8px;"></div>
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 6px;">
                        <strong>üìû Action Required:</strong>
                        <ul style="margin: 8px 0 0 20px; color: var(--text-secondary);">
                            <li>Consult your doctor immediately</li>
                            <li>Discuss preventive medication options</li>
                            <li>Don't stop medications suddenly</li>
                        </ul>
                    </div>
                </div>
                <div id="medication-usage-content"></div>
            </div>
        </div>

        <div id="settings-page" class="page">
            <h1>
                Settings
                <a href="./help/index.html" class="help-icon" title="Help & Documentation">?</a>
            </h1>

            <div class="section-card">
                <h2>üìä Storage & Backup</h2>
                <div class="settings-info">
                    <div class="info-row">
                        <span class="info-label">Episodes:</span>
                        <span class="info-value" id="storage-episodes">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Storage Used:</span>
                        <span class="info-value" id="storage-size">0 KB</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">In Trash:</span>
                        <span class="info-value" id="trash-count">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Last Backup:</span>
                        <span class="info-value" id="last-backup">Never</span>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h2>üóëÔ∏è Recently Deleted</h2>
                <div class="settings-info" style="margin-bottom: 16px;">
                    <p style="text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                        Deleted episodes are kept for 30 days before being permanently removed.
                    </p>
                </div>
                <div class="settings-actions">
                    <button class="settings-btn" id="view-trash-btn">
                        <span>üóëÔ∏è View Trash</span>
                        <span class="btn-subtitle" id="trash-subtitle">0 items</span>
                    </button>
                </div>
            </div>

            <div class="section-card" id="data-management-section">
                <h2>üíæ Data Management</h2>
                <div class="settings-actions">
                    <button class="settings-btn" id="export-json-btn">
                        <span>üì§ Export as JSON</span>
                        <span class="btn-subtitle">Full backup</span>
                    </button>
                    <button class="settings-btn" id="export-csv-btn">
                        <span>üìä Export as CSV</span>
                        <span class="btn-subtitle">Excel/Sheets compatible</span>
                    </button>
                    <button class="settings-btn" id="export-pdf-btn">
                        <span>üìÑ Export as PDF</span>
                        <span class="btn-subtitle">Doctor report</span>
                    </button>
                    <button class="settings-btn" id="import-json-btn">
                        <span>üì• Import from JSON</span>
                        <span class="btn-subtitle">Restore backup</span>
                    </button>
                    <button class="settings-btn" id="import-csv-btn">
                        <span>üì• Import from CSV</span>
                        <span class="btn-subtitle">Migrate from other apps</span>
                    </button>
                </div>
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
                <input type="file" id="import-csv-input" accept=".csv" style="display: none;">
            </div>

            <div class="section-card">
                <h2>üé® Appearance</h2>
                <div class="settings-group">
                    <label class="settings-label">Theme</label>
                    <div class="theme-options">
                        <button class="theme-btn" data-theme="auto">
                            <span>üåì</span>
                            <span>Auto</span>
                        </button>
                        <button class="theme-btn active" data-theme="dark">
                            <span>üåô</span>
                            <span>Dark</span>
                        </button>
                        <button class="theme-btn" data-theme="light">
                            <span>‚òÄÔ∏è</span>
                            <span>Light</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="section-card" id="notification-section">
                <h2>üîî Notifications</h2>
                <div class="settings-info" style="margin-bottom: 16px;">
                    <div id="notification-status" class="info-banner" style="padding: 12px; border-radius: 8px; margin-bottom: 12px; background: var(--bg-tertiary); text-align: center;">
                        <span id="notification-status-text">Loading...</span>
                    </div>
                </div>

                <div id="notification-settings-content">
                    <!-- iOS Installation Prompt (hidden by default) -->
                    <div id="ios-install-prompt" style="display: none; padding: 16px; border-radius: 8px; background: var(--accent-blue); color: white; margin-bottom: 16px;">
                        <p style="margin-bottom: 12px; font-weight: 600;">üì± Installation Required</p>
                        <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 12px;">
                            To receive notifications on iOS:
                        </p>
                        <ol style="font-size: 0.9rem; line-height: 1.8; margin-left: 20px;">
                            <li>Tap the Share button <span style="font-size: 1.2rem;">‚éã</span></li>
                            <li>Scroll down and tap "Add to Home Screen"</li>
                            <li>Tap "Add" in the top right</li>
                            <li>Open the app from your home screen</li>
                            <li>Return here to enable notifications</li>
                        </ol>
                    </div>

                    <!-- Permission Request Section -->
                    <div id="notification-enable-section" style="display: none;">
                        <div class="settings-actions">
                            <button class="settings-btn" id="enable-notifications-btn" style="background: var(--accent-green); color: white;">
                                <span>üîî Enable Notifications</span>
                                <span class="btn-subtitle">Tap to request permission</span>
                            </button>
                        </div>
                    </div>

                    <!-- Notification Settings (shown when enabled) -->
                    <div id="notification-preferences" style="display: none;">
                        <!-- Daily Check-in -->
                        <div class="settings-group" style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                            <label class="settings-label" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <span>üìÖ Daily Check-in</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="daily-checkin-enabled" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </label>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">
                                Daily reminder to log your migraine status
                            </p>
                            <div id="daily-checkin-settings">
                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.9rem;">Reminder Time</label>
                                    <input type="time" id="daily-checkin-time" value="19:00" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary); font-size: 1rem;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.9rem;">Frequency</label>
                                    <select id="daily-checkin-frequency" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary); font-size: 1rem;">
                                        <option value="daily">Every day</option>
                                        <option value="every-other-day">Every other day</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Active Attack Check-in -->
                        <div class="settings-group" style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                            <label class="settings-label" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <span>‚ö° Active Attack Check-in</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="active-checkin-enabled" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </label>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">
                                Reminder during an ongoing attack to update pain level or end episode
                            </p>
                            <div id="active-checkin-settings">
                                <div>
                                    <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.9rem;">Check-in After</label>
                                    <select id="active-checkin-delay" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary); font-size: 1rem;">
                                        <option value="1">1 hour</option>
                                        <option value="2" selected>2 hours</option>
                                        <option value="3">3 hours</option>
                                        <option value="4">4 hours</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Post-Attack Follow-up -->
                        <div class="settings-group" style="margin-bottom: 20px;">
                            <label class="settings-label" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <span>‚è∞ Post-Attack Follow-up</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="followup-enabled" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </label>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">
                                Reminder to update status after logging an attack
                            </p>
                            <div id="followup-settings">
                                <div>
                                    <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.9rem;">Check-in After</label>
                                    <select id="followup-delay" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary); font-size: 1rem;">
                                        <option value="2">2 hours</option>
                                        <option value="3">3 hours</option>
                                        <option value="4">4 hours</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Test Notifications -->
                        <div class="settings-actions">
                            <button class="settings-btn" id="test-notification-btn">
                                <span>üß™ Send Test Notification</span>
                                <span class="btn-subtitle">Verify notifications are working</span>
                            </button>
                            <button class="settings-btn danger" id="disable-notifications-btn">
                                <span>üîï Disable Notifications</span>
                                <span class="btn-subtitle">Unsubscribe from all notifications</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h2>‚òÅÔ∏è Weather Tracking (Optional)</h2>
                <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.95rem;">
                    Track barometric pressure to identify weather-related migraine patterns.
                    Research shows ~15-20% of migraine sufferers are sensitive to pressure changes.
                </p>

                <!-- Weather Tracking Toggle -->
                <label class="settings-label" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                    <span style="font-weight: 500;">Enable Weather Tracking</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="weather-tracking-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                </label>

                <!-- Weather Settings (shown when enabled) -->
                <div id="weather-settings" style="display: none;">
                    <!-- Location Entry -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">üìç Your Location</label>
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 10px;">
                            Enter your ZIP/postal code or city name to fetch local weather data.
                        </p>
                        <div style="display: flex; gap: 10px; align-items: stretch;">
                            <input
                                type="text"
                                id="weather-location-input"
                                placeholder="e.g., 10001 or New York, NY"
                                style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary); font-size: 1rem;"
                            >
                            <button
                                id="weather-location-save"
                                class="btn btn-primary"
                                style="padding: 12px; width: 70px; white-space: nowrap; font-size: 0.9rem;"
                            >
                                Save
                            </button>
                        </div>
                        <div id="weather-location-status" style="margin-top: 8px; font-size: 0.85rem;"></div>
                    </div>

                    <!-- Current Weather Display -->
                    <div id="weather-current-display" style="display: none; background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">Current Location</div>
                                <div id="weather-location-display" style="font-weight: 500; margin-top: 4px;">-</div>
                            </div>
                            <button id="weather-refresh-btn" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9rem;">
                                üîÑ Refresh
                            </button>
                        </div>
                        <div style="border-top: 1px solid var(--border-color); padding-top: 12px;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;">Barometric Pressure</div>
                            <div style="font-size: 1.8rem; font-weight: 600; color: var(--accent-green);" id="weather-current-pressure">
                                -
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 4px;" id="weather-pressure-change">
                                -
                            </div>
                        </div>
                        <div style="margin-top: 12px; font-size: 0.8rem; color: var(--text-secondary);" id="weather-last-updated">
                            Last updated: Never
                        </div>
                    </div>

                    <!-- Privacy Notice -->
                    <div class="info-box" style="margin-bottom: 16px; background: var(--bg-tertiary); border-left: 4px solid var(--accent-blue); padding: 12px 16px; border-radius: 0 8px 8px 0;">
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <span style="font-size: 1.2rem;">üîí</span>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                <strong style="color: var(--text-primary);">Privacy First:</strong> Your location stays on your device.
                                We never send it to our servers. Weather data is fetched directly from a free public API.
                            </div>
                        </div>
                    </div>

                    <!-- How It Works -->
                    <details style="margin-bottom: 16px; background: var(--bg-tertiary); padding: 12px 16px; border-radius: 8px;">
                        <summary style="cursor: pointer; font-weight: 500; color: var(--text-primary);">
                            ‚ÑπÔ∏è How does this work?
                        </summary>
                        <div style="margin-top: 12px; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6;">
                            <p style="margin-bottom: 8px;">
                                When enabled, the app fetches barometric pressure data from Open-Meteo
                                (a free, privacy-friendly weather API) twice per day.
                            </p>
                            <p style="margin-bottom: 8px;">
                                <strong>Clinical threshold:</strong> Pressure changes >5 hPa (millibars) in 24 hours
                                are considered significant based on migraine research.
                            </p>
                            <p>
                                The app analyzes your migraine patterns alongside pressure data to help identify
                                if weather is a trigger for you. This information can be valuable for your doctor.
                            </p>
                        </div>
                    </details>
                </div>
            </div>

            <div class="section-card">
                <h2>‚ÑπÔ∏è Information</h2>
                <div class="settings-actions">
                    <button class="settings-btn" id="tour-btn">
                        <span>üéØ Take a Tour</span>
                        <span class="btn-subtitle">Interactive walkthrough</span>
                    </button>
                    <button class="settings-btn" id="how-to-btn">
                        <span>üìñ How to Use</span>
                    </button>
                    <button class="settings-btn" id="about-btn">
                        <span>üì± About This App</span>
                    </button>
                    <button class="settings-btn" id="privacy-btn">
                        <span>üîí Privacy & Your Data</span>
                    </button>
                </div>
            </div>

            <div class="section-card">
                <h2>üìö Help & Resources</h2>
                <div class="settings-actions">
                    <a href="./help/quick-start.html" class="settings-btn" style="text-decoration: none; display: block;">
                        <span>üöÄ Quick Start Guide</span>
                        <span class="btn-subtitle">Get started in minutes</span>
                    </a>
                    <a href="./help/notifications-ios.html" class="settings-btn" style="text-decoration: none; display: block;">
                        <span>üîî iOS Notification Setup</span>
                        <span class="btn-subtitle">Fix notification issues</span>
                    </a>
                    <a href="./help/analytics.html" class="settings-btn" style="text-decoration: none; display: block;">
                        <span>üìä Understanding Analytics</span>
                        <span class="btn-subtitle">Interpret your charts</span>
                    </a>
                    <a href="./help/faq.html" class="settings-btn" style="text-decoration: none; display: block;">
                        <span>üí° FAQ</span>
                        <span class="btn-subtitle">Common questions</span>
                    </a>
                    <a href="./help/privacy.html" class="settings-btn" style="text-decoration: none; display: block;">
                        <span>üîí Privacy Policy</span>
                        <span class="btn-subtitle">How we protect your data</span>
                    </a>
                </div>
            </div>

            <div class="section-card">
                <h2>‚ö†Ô∏è Advanced</h2>
                <div class="settings-actions">
                    <button class="settings-btn danger" id="clear-all-btn">
                        <span>üóëÔ∏è Clear All Data</span>
                        <span class="btn-subtitle">Cannot be undone</span>
                    </button>
                </div>
            </div>

            <div class="app-info">
                <p>Aiding Migraine v1.6.0</p>
                <p>Built with care for migraine sufferers</p>
            </div>
        </div>

        <nav class="bottom-nav">
            <button class="nav-btn active" data-page="log">
                <span class="nav-icon">üìù</span>
                <span class="nav-label">Log</span>
            </button>
            <button class="nav-btn" data-page="analytics">
                <span class="nav-icon">üìà</span>
                <span class="nav-label">Analytics</span>
            </button>
            <button class="nav-btn" data-page="history">
                <span class="nav-icon">üìã</span>
                <span class="nav-label">History</span>
            </button>
            <button class="nav-btn" data-page="settings">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-label">Settings</span>
            </button>
        </nav>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-actions" id="modal-actions"></div>
        </div>
    </div>

    <script>
        let migraines = [];
        let selectedPain = null;
        let activeMigraine = null;
        let durationInterval = null;
        let currentMonth = new Date();
        let currentPage = 'log';

        // Medication Library
        let medicationLibrary = [];
        let userMedications = [];
        let currentEpisodeMedications = []; // Temporary storage for medications being logged

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            purgeOldDeletedEpisodes();
            initializeMedicationLibrary();
            initializeTheme();
            initializeNavigation();
            initializePainScale();
            initializeLogging();
            initializeHistory();
            initializeCalendar();
            initializeSettings();
            initializeNotifications();
            initWeatherTracking();
            initializeReliefMethods();
            checkActiveMigraine();
            updateDashboard();
            renderHistory();
            renderCalendar();
            checkFirstTimeUser();
        });

        function loadData() {
            const stored = localStorage.getItem('migraines');
            if (stored) {
                migraines = JSON.parse(stored);
            }
            const active = localStorage.getItem('activeMigraine');
            if (active) {
                activeMigraine = JSON.parse(active);
            }
        }

        function saveData() {
            localStorage.setItem('migraines', JSON.stringify(migraines));
            if (activeMigraine) {
                localStorage.setItem('activeMigraine', JSON.stringify(activeMigraine));
            } else {
                localStorage.removeItem('activeMigraine');
            }
        }

        // ============================================
        // MEDICATION LIBRARY SYSTEM
        // ============================================

        function initializeMedicationLibrary() {
            // Load user-added medications
            const stored = localStorage.getItem('userMedications');
            if (stored) {
                userMedications = JSON.parse(stored);
            }

            // Pre-populated medication library (common migraine medications)
            medicationLibrary = [
                // Triptans (Abortive)
                { name: "Sumatriptan", type: "abortive", category: "triptan", dosages: ["25mg", "50mg", "100mg"], forms: ["tablet", "nasal spray", "injection"] },
                { name: "Rizatriptan", type: "abortive", category: "triptan", dosages: ["5mg", "10mg"], forms: ["tablet", "disintegrating tablet"] },
                { name: "Eletriptan", type: "abortive", category: "triptan", dosages: ["20mg", "40mg"], forms: ["tablet"] },
                { name: "Zolmitriptan", type: "abortive", category: "triptan", dosages: ["2.5mg", "5mg"], forms: ["tablet", "nasal spray"] },
                { name: "Almotriptan", type: "abortive", category: "triptan", dosages: ["6.25mg", "12.5mg"], forms: ["tablet"] },
                { name: "Naratriptan", type: "abortive", category: "triptan", dosages: ["1mg", "2.5mg"], forms: ["tablet"] },

                // NSAIDs (Abortive)
                { name: "Ibuprofen", type: "abortive", category: "nsaid", dosages: ["200mg", "400mg", "600mg", "800mg"], forms: ["tablet", "liquid gel"] },
                { name: "Naproxen", type: "abortive", category: "nsaid", dosages: ["220mg", "375mg", "500mg"], forms: ["tablet"] },
                { name: "Aspirin", type: "abortive", category: "nsaid", dosages: ["325mg", "500mg", "650mg"], forms: ["tablet"] },
                { name: "Diclofenac", type: "abortive", category: "nsaid", dosages: ["50mg", "75mg"], forms: ["tablet"] },
                { name: "Indomethacin", type: "abortive", category: "nsaid", dosages: ["25mg", "50mg"], forms: ["capsule"] },

                // Combination Drugs (Abortive)
                { name: "Excedrin Migraine", type: "abortive", category: "combination", dosages: ["2 tablets"], forms: ["tablet"] },
                { name: "Fioricet", type: "abortive", category: "combination", dosages: ["1-2 tablets"], forms: ["tablet"] },
                { name: "Treximet", type: "abortive", category: "combination", dosages: ["85mg/500mg"], forms: ["tablet"] },

                // CGRP Antagonists (Abortive)
                { name: "Ubrogepant", type: "abortive", category: "cgrp", dosages: ["50mg", "100mg"], forms: ["tablet"] },
                { name: "Rimegepant", type: "abortive", category: "cgrp", dosages: ["75mg"], forms: ["disintegrating tablet"] },

                // Preventive - Beta Blockers
                { name: "Propranolol", type: "preventive", category: "beta-blocker", dosages: ["40mg", "80mg", "120mg"], forms: ["tablet", "extended release"] },
                { name: "Metoprolol", type: "preventive", category: "beta-blocker", dosages: ["25mg", "50mg", "100mg"], forms: ["tablet"] },
                { name: "Timolol", type: "preventive", category: "beta-blocker", dosages: ["10mg", "20mg"], forms: ["tablet"] },

                // Preventive - Antidepressants
                { name: "Amitriptyline", type: "preventive", category: "antidepressant", dosages: ["10mg", "25mg", "50mg", "75mg"], forms: ["tablet"] },
                { name: "Venlafaxine", type: "preventive", category: "antidepressant", dosages: ["37.5mg", "75mg", "150mg"], forms: ["capsule"] },
                { name: "Duloxetine", type: "preventive", category: "antidepressant", dosages: ["30mg", "60mg"], forms: ["capsule"] },

                // Preventive - Anticonvulsants
                { name: "Topiramate", type: "preventive", category: "anticonvulsant", dosages: ["25mg", "50mg", "100mg"], forms: ["tablet"] },
                { name: "Valproate", type: "preventive", category: "anticonvulsant", dosages: ["250mg", "500mg"], forms: ["tablet"] },

                // Preventive - CGRP Monoclonal Antibodies
                { name: "Erenumab (Aimovig)", type: "preventive", category: "cgrp-mab", dosages: ["70mg", "140mg"], forms: ["injection"] },
                { name: "Fremanezumab (Ajovy)", type: "preventive", category: "cgrp-mab", dosages: ["225mg"], forms: ["injection"] },
                { name: "Galcanezumab (Emgality)", type: "preventive", category: "cgrp-mab", dosages: ["120mg"], forms: ["injection"] },

                // Other
                { name: "Acetaminophen", type: "abortive", category: "other", dosages: ["325mg", "500mg", "650mg"], forms: ["tablet", "liquid"] },
                { name: "Caffeine", type: "abortive", category: "other", dosages: ["100mg", "200mg"], forms: ["tablet", "liquid"] },
                { name: "Magnesium", type: "preventive", category: "supplement", dosages: ["400mg", "500mg"], forms: ["tablet", "capsule"] },
                { name: "Riboflavin (B2)", type: "preventive", category: "supplement", dosages: ["400mg"], forms: ["tablet"] },
                { name: "CoQ10", type: "preventive", category: "supplement", dosages: ["100mg", "300mg"], forms: ["capsule"] }
            ];

            // Combine with user medications
            medicationLibrary = [...medicationLibrary, ...userMedications];
        }

        function saveMedicationLibrary() {
            localStorage.setItem('userMedications', JSON.stringify(userMedications));
        }

        function showAddMedicationModal() {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            body.innerHTML = `
                <div class="form-group">
                    <label>Search Medication</label>
                    <input type="text" id="med-search" placeholder="Type to search..." style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary); font-size: 1rem;" autofocus>
                </div>

                <div id="med-search-results" style="max-height: 300px; overflow-y: auto; margin-bottom: 16px;">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">Type to search medications...</p>
                </div>

                <div style="border-top: 1px solid var(--border-color); padding-top: 16px;">
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 8px;">Or enter custom medication:</p>
                    <input type="text" id="custom-med-name" placeholder="Medication name" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary); margin-bottom: 8px;">
                    <button class="btn btn-secondary" id="add-custom-med-btn" style="width: 100%;">Add Custom Medication</button>
                </div>
            `;

            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            `;

            document.getElementById('modal-title').textContent = 'Add Medication';
            modal.classList.add('active');

            // Search functionality
            const searchInput = document.getElementById('med-search');
            searchInput.addEventListener('input', (e) => {
                searchMedications(e.target.value);
            });

            // Custom medication
            document.getElementById('add-custom-med-btn').addEventListener('click', () => {
                const customName = document.getElementById('custom-med-name').value.trim();
                if (customName) {
                    addMedicationToEpisode({ name: customName, custom: true });
                }
            });
        }

        function searchMedications(query) {
            const resultsDiv = document.getElementById('med-search-results');

            if (!query || query.length < 2) {
                resultsDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Type at least 2 characters...</p>';
                return;
            }

            const matches = medicationLibrary.filter(med =>
                med.name.toLowerCase().includes(query.toLowerCase())
            );

            if (matches.length === 0) {
                resultsDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No medications found. Try adding a custom medication below.</p>';
                return;
            }

            resultsDiv.innerHTML = matches.slice(0, 10).map(med => `
                <div class="med-result-item" onclick="selectMedication('${med.name}')" style="padding: 12px; margin-bottom: 8px; background: var(--bg-tertiary); border-radius: 8px; cursor: pointer; border: 1px solid var(--border-color);">
                    <div style="font-weight: 600;">${med.name}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 2px;">
                        ${med.type === 'abortive' ? 'üéØ Abortive' : 'üõ°Ô∏è Preventive'} ‚Ä¢ ${med.category}
                    </div>
                </div>
            `).join('');
        }

        function selectMedication(medName) {
            const med = medicationLibrary.find(m => m.name === medName);
            if (!med) return;

            // Show dosage/form selection modal
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            body.innerHTML = `
                <h3 style="margin-bottom: 16px;">${med.name}</h3>

                <div class="form-group">
                    <label>Dosage</label>
                    <select id="med-dosage" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary);">
                        ${med.dosages ? med.dosages.map(d => `<option value="${d}">${d}</option>`).join('') : '<option value="">Not specified</option>'}
                        <option value="custom">Custom...</option>
                    </select>
                    <input type="text" id="custom-dosage" placeholder="Enter custom dosage" style="width: 100%; padding: 10px; margin-top: 8px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary); display: none;">
                </div>

                <div class="form-group">
                    <label>Form</label>
                    <select id="med-form" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary);">
                        ${med.forms ? med.forms.map(f => `<option value="${f}">${f}</option>`).join('') : '<option value="tablet">Tablet</option>'}
                    </select>
                </div>
            `;

            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="showAddMedicationModal()">Back</button>
                <button class="btn btn-primary" id="confirm-add-med">Add to Episode</button>
            `;

            // Show custom dosage input if selected
            document.getElementById('med-dosage').addEventListener('change', (e) => {
                const customInput = document.getElementById('custom-dosage');
                customInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
            });

            document.getElementById('confirm-add-med').addEventListener('click', () => {
                const dosageSelect = document.getElementById('med-dosage');
                let dosage = dosageSelect.value;
                if (dosage === 'custom') {
                    dosage = document.getElementById('custom-dosage').value.trim();
                }
                const form = document.getElementById('med-form').value;

                addMedicationToEpisode({
                    name: med.name,
                    dosage: dosage,
                    formulation: form,
                    type: med.type,
                    category: med.category
                });
            });
        }

        function addMedicationToEpisode(medData) {
            const medication = {
                name: medData.name,
                dosage: medData.dosage || null,
                formulation: medData.formulation || null,
                type: medData.type || null,
                category: medData.category || null,
                timeTaken: new Date().toISOString()
            };

            currentEpisodeMedications.push(medication);
            renderMedicationsList();
            closeModal();
        }

        function removeMedicationFromEpisode(index) {
            currentEpisodeMedications.splice(index, 1);
            renderMedicationsList();
        }

        function renderMedicationsList() {
            const listDiv = document.getElementById('medications-list');

            if (currentEpisodeMedications.length === 0) {
                listDiv.innerHTML = '';
                return;
            }

            listDiv.innerHTML = currentEpisodeMedications.map((med, index) => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--accent-blue);">
                    <div>
                        <div style="font-weight: 600;">${med.name}${med.dosage ? ` ${med.dosage}` : ''}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            ${med.formulation || 'Not specified'} ‚Ä¢ ${new Date(med.timeTaken).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </div>
                    </div>
                    <button onclick="removeMedicationFromEpisode(${index})" style="background: var(--pain-moderate); color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.85rem;">Remove</button>
                </div>
            `).join('');
        }

        function showMedicationEffectivenessModal(completedMigraine) {
            // Check if migraine has medications to rate
            if (!completedMigraine.medications || completedMigraine.medications.length === 0) {
                return false; // No medications to rate
            }

            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            let currentMedIndex = 0;
            const medications = completedMigraine.medications;

            function showMedicationRating(index) {
                if (index >= medications.length) {
                    // All medications rated, save and close
                    saveData();
                    closeModal();
                    showModal('Episode Ended', 'Your migraine episode and medication effectiveness have been saved.');
                    return;
                }

                const med = medications[index];

                document.getElementById('modal-title').textContent = 'Rate Medication Effectiveness';
                body.innerHTML = `
                    <p style="margin-bottom: 20px; color: var(--text-secondary);">
                        Medication ${index + 1} of ${medications.length}
                    </p>

                    <h3 style="margin-bottom: 24px;">${med.name}${med.dosage ? ' ' + med.dosage : ''}</h3>

                    <div class="form-group">
                        <label>How effective was this medication?</label>
                        <div id="effectiveness-stars" style="display: flex; gap: 8px; font-size: 2rem; margin-top: 8px;">
                            ${[1, 2, 3, 4, 5].map(star => `
                                <span class="star-rating" data-rating="${star}" style="cursor: pointer; color: var(--text-tertiary);">‚≠ê</span>
                            `).join('')}
                        </div>
                        <div id="effectiveness-label" style="margin-top: 8px; color: var(--text-secondary); font-size: 0.9rem; min-height: 20px;"></div>
                    </div>

                    <div class="form-group" style="margin-top: 24px;">
                        <label>Time to relief (optional)</label>
                        <select id="time-to-relief" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary);">
                            <option value="">Not sure / No relief</option>
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="60">1 hour</option>
                            <option value="120">2 hours</option>
                            <option value="240">4 hours</option>
                            <option value="480">8+ hours</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-top: 24px;">
                        <label>Any side effects? (optional)</label>
                        <div id="side-effects" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" value="nausea" style="width: 18px; height: 18px;">
                                <span>Nausea</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" value="dizziness" style="width: 18px; height: 18px;">
                                <span>Dizziness</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" value="drowsiness" style="width: 18px; height: 18px;">
                                <span>Drowsiness</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" value="fatigue" style="width: 18px; height: 18px;">
                                <span>Fatigue</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" value="chest-tightness" style="width: 18px; height: 18px;">
                                <span>Chest Tightness</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" value="dry-mouth" style="width: 18px; height: 18px;">
                                <span>Dry Mouth</span>
                            </label>
                        </div>
                    </div>
                `;

                document.getElementById('modal-actions').innerHTML = `
                    <button class="btn btn-secondary" id="skip-rating">Skip</button>
                    <button class="btn btn-primary" id="save-rating" disabled>Save & ${index < medications.length - 1 ? 'Next' : 'Finish'}</button>
                `;

                // Star rating interaction
                let selectedRating = 0;
                const stars = document.querySelectorAll('.star-rating');
                const label = document.getElementById('effectiveness-label');
                const saveBtn = document.getElementById('save-rating');

                const ratingLabels = {
                    1: '‚≠ê No relief',
                    2: '‚≠ê‚≠ê Slight relief',
                    3: '‚≠ê‚≠ê‚≠ê Moderate relief',
                    4: '‚≠ê‚≠ê‚≠ê‚≠ê Good relief',
                    5: '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Complete relief'
                };

                stars.forEach(star => {
                    star.addEventListener('click', () => {
                        selectedRating = parseInt(star.dataset.rating);

                        // Update star colors
                        stars.forEach(s => {
                            const rating = parseInt(s.dataset.rating);
                            s.style.color = rating <= selectedRating ? 'var(--accent-gold)' : 'var(--text-tertiary)';
                        });

                        // Update label
                        label.textContent = ratingLabels[selectedRating];
                        saveBtn.disabled = false;
                    });

                    // Hover effect
                    star.addEventListener('mouseenter', () => {
                        const rating = parseInt(star.dataset.rating);
                        stars.forEach(s => {
                            const r = parseInt(s.dataset.rating);
                            s.style.color = r <= rating ? 'var(--accent-gold)' : 'var(--text-tertiary)';
                        });
                    });
                });

                document.getElementById('effectiveness-stars').addEventListener('mouseleave', () => {
                    // Restore selected rating
                    stars.forEach(s => {
                        const rating = parseInt(s.dataset.rating);
                        s.style.color = rating <= selectedRating ? 'var(--accent-gold)' : 'var(--text-tertiary)';
                    });
                });

                // Skip button
                document.getElementById('skip-rating').addEventListener('click', () => {
                    currentMedIndex++;
                    showMedicationRating(currentMedIndex);
                });

                // Save button
                document.getElementById('save-rating').addEventListener('click', () => {
                    const timeToRelief = document.getElementById('time-to-relief').value;
                    const sideEffects = Array.from(document.querySelectorAll('#side-effects input:checked'))
                        .map(cb => cb.value);

                    // Save effectiveness data to medication
                    medications[index].effectiveness = selectedRating;
                    if (timeToRelief) {
                        medications[index].timeToRelief = parseInt(timeToRelief);
                    }
                    if (sideEffects.length > 0) {
                        medications[index].sideEffects = sideEffects;
                    }

                    currentMedIndex++;
                    showMedicationRating(currentMedIndex);
                });
            }

            // Start rating the first medication
            modal.classList.add('active');
            showMedicationRating(0);

            return true; // Indicates effectiveness modal was shown
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
            
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === savedTheme) {
                    btn.classList.add('active');
                }
            });

            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const theme = btn.dataset.theme;
                    applyTheme(theme);
                    localStorage.setItem('theme', theme);
                    
                    document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
        }

        function applyTheme(theme) {
            if (theme === 'auto') {
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }
        }

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            const currentTheme = localStorage.getItem('theme') || 'dark';
            if (currentTheme === 'auto') {
                applyTheme('auto');
            }
        });

        function initializeNavigation() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const page = btn.dataset.page;
                    showPage(page);
                });
            });
        }

        function showPage(pageName) {
            currentPage = pageName;
            
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`${pageName}-page`).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.page === pageName) {
                    btn.classList.add('active');
                }
            });
            
            if (pageName === 'history') {
                renderHistory();
            } else if (pageName === 'settings') {
                updateStorageInfo();
            } else if (pageName === 'log') {
                renderCalendar();
                updateLogWeatherDisplay();
            } else if (pageName === 'analytics') {
                initializeAnalytics();
            }
        }

        function initializePainScale() {
            document.querySelectorAll('.pain-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectedPain = parseInt(btn.dataset.pain);
                    document.querySelectorAll('.pain-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                });
            });
        }

        document.getElementById('toggle-details-btn')?.addEventListener('click', () => {
            const content = document.getElementById('optional-details-content');
            const arrow = document.getElementById('details-arrow');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.classList.add('rotated');
            } else {
                content.style.display = 'none';
                arrow.classList.remove('rotated');
            }
        });

        function initializeLogging() {
            document.getElementById('log-btn').addEventListener('click', logEpisode);
            document.getElementById('clear-btn').addEventListener('click', clearForm);
            document.getElementById('add-medication-btn').addEventListener('click', showAddMedicationModal);
            document.getElementById('update-pain-btn')?.addEventListener('click', updateActivePain);
            document.getElementById('end-episode-btn')?.addEventListener('click', endActiveMigraine);
            renderMedicationsList(); // Initialize empty medication list
        }

        function logEpisode() {
            if (selectedPain === null) {
                showModal('Error', 'Please select a pain level.');
                return;
            }

            if (activeMigraine) {
                showModal('Error', 'You already have an active episode. Please end it first.');
                return;
            }

            const notes = document.getElementById('notes-input').value.trim();

            const migraine = {
                id: Date.now(),
                startTime: new Date().toISOString(),
                painLevel: selectedPain,
                painHistory: [{ timestamp: new Date().toISOString(), level: selectedPain }],
                status: 'active',
                notes: notes,
                medications: currentEpisodeMedications.length > 0 ? [...currentEpisodeMedications] : null,
                // Keep old medication field for backwards compatibility
                medication: currentEpisodeMedications.length > 0
                    ? currentEpisodeMedications.map(m => `${m.name}${m.dosage ? ' ' + m.dosage : ''}`).join(', ')
                    : null,
                weather: getCurrentWeatherForEntry(),
                category: getPainCategory(selectedPain)
            };

            activeMigraine = migraine;
            saveData();
            startDurationTracking();
            checkActiveMigraine();
            clearForm();
            updateDashboard();
            renderCalendar();

            // Schedule active attack check-in notification
            scheduleActiveAttackCheckIn(migraine.id);

            // Schedule post-attack follow-up notification
            schedulePostAttackFollowUp(migraine.id);

            showModal('Episode Logged', 'Your migraine episode has been logged and is now being tracked.');
        }

        function clearForm() {
            selectedPain = null;
            document.querySelectorAll('.pain-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('notes-input').value = '';
            currentEpisodeMedications = [];
            renderMedicationsList();
        }

        function updateActivePain() {
            if (!activeMigraine) return;

            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            
            body.innerHTML = `
                <div class="form-group">
                    <label>New Pain Level</label>
                    <div class="pain-scale">
                        ${[0,1,2,3,4,5,6,7,8,9,10].map(i => 
                            `<button class="pain-btn" data-pain="${i}">${i}</button>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="confirm-pain-update">Update</button>
            `;
            
            document.getElementById('modal-title').textContent = 'Update Pain Level';
            modal.classList.add('active');
            
            body.querySelectorAll('.pain-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    body.querySelectorAll('.pain-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                });
            });
            
            document.getElementById('confirm-pain-update').addEventListener('click', () => {
                const selected = body.querySelector('.pain-btn.selected');
                if (selected) {
                    const newPain = parseInt(selected.dataset.pain);
                    activeMigraine.painHistory.push({
                        timestamp: new Date().toISOString(),
                        level: newPain
                    });
                    activeMigraine.painLevel = newPain;
                    activeMigraine.category = getPainCategory(newPain);
                    saveData();
                    updateActiveMigraineeDisplay();
                    closeModal();
                    showModal('Pain Updated', `Pain level updated to ${newPain}/10`);
                }
            });
        }

        function endActiveMigraine() {
            if (!activeMigraine) return;

            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            
            body.innerHTML = `
                <p>End this migraine episode?</p>
                <div class="form-group" style="margin-top: 16px;">
                    <label>Final Notes (optional)</label>
                    <textarea id="end-notes" placeholder="How did it resolve? What helped?" rows="3"></textarea>
                </div>
            `;
            
            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="confirm-end">End Episode</button>
            `;
            
            document.getElementById('modal-title').textContent = 'End Episode';
            modal.classList.add('active');
            
            document.getElementById('confirm-end').addEventListener('click', () => {
                const endNotes = document.getElementById('end-notes').value.trim();

                activeMigraine.endTime = new Date().toISOString();
                activeMigraine.status = 'completed';
                activeMigraine.endNotes = endNotes;
                activeMigraine.duration = Math.floor((new Date(activeMigraine.endTime) - new Date(activeMigraine.startTime)) / 1000);
                activeMigraine.endWeather = getCurrentWeatherForEntry();

                const completedMigraineId = activeMigraine.id;
                const completedMigraine = activeMigraine; // Store reference for effectiveness modal
                migraines.push(activeMigraine);
                activeMigraine = null;

                // Cancel active attack check-in notification (attack has ended)
                cancelActiveAttackCheckIn(completedMigraineId);

                stopDurationTracking();
                saveData();
                checkActiveMigraine();
                updateDashboard();
                renderHistory();
                renderCalendar();

                // Show effectiveness modal if medications were taken
                const showedEffectivenessModal = showMedicationEffectivenessModal(completedMigraine);

                // If no medications to rate, close and show success message
                if (!showedEffectivenessModal) {
                    closeModal();
                    showModal('Episode Ended', 'Your migraine episode has been saved to history.');
                }
            });
        }

        function checkActiveMigraine() {
            const section = document.getElementById('active-episode-section');
            const logging = document.getElementById('logging-section');
            
            if (activeMigraine) {
                section.style.display = 'block';
                logging.style.display = 'none';
                updateActiveMigraineeDisplay();
                startDurationTracking();
            } else {
                section.style.display = 'none';
                logging.style.display = 'block';
                stopDurationTracking();
            }
        }

        function updateActiveMigraineeDisplay() {
            if (!activeMigraine) return;

            document.getElementById('active-pain-display').textContent = `${activeMigraine.painLevel}/10`;
            document.getElementById('active-category').textContent = activeMigraine.category;
            updateDuration();
            updateReliefTimeline();
        }

        function startDurationTracking() {
            stopDurationTracking();
            updateDuration();
            durationInterval = setInterval(updateDuration, 60000);
        }

        function stopDurationTracking() {
            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }
        }

        function updateDuration() {
            if (!activeMigraine) return;

            const start = new Date(activeMigraine.startTime);
            const now = new Date();
            const diff = now - start;

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            document.getElementById('active-duration').textContent = `${hours}h ${minutes}m`;
        }

        // ============================================
        // ENTRY EDITING FUNCTIONS
        // ============================================

        function editAttack(attackId) {
            // Find the attack to edit (check both completed and active)
            let attack = migraines.find(m => m.id === attackId);
            const isActive = activeMigraine && activeMigraine.id === attackId;

            if (isActive) {
                attack = activeMigraine;
            }

            if (!attack) {
                showModal('Error', 'Episode not found.');
                return;
            }

            closeModal(); // Close the day details modal

            // Create edit modal
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            // Parse start and end times
            const startDate = new Date(attack.startTime);
            const startDateStr = startDate.toISOString().split('T')[0];
            const startTimeStr = startDate.toTimeString().slice(0, 5);

            let endDateStr = '';
            let endTimeStr = '';
            if (attack.endTime) {
                const endDate = new Date(attack.endTime);
                endDateStr = endDate.toISOString().split('T')[0];
                endTimeStr = endDate.toTimeString().slice(0, 5);
            }

            body.innerHTML = `
                <div style="max-height: 60vh; overflow-y: auto;">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Start Date & Time</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="date" id="edit-start-date" value="${startDateStr}" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary);">
                            <input type="time" id="edit-start-time" value="${startTimeStr}" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary);">
                        </div>
                    </div>

                    ${attack.status === 'completed' ? `
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">End Date & Time</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="date" id="edit-end-date" value="${endDateStr}" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary);">
                            <input type="time" id="edit-end-time" value="${endTimeStr}" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary);">
                        </div>
                    </div>
                    ` : ''}

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Pain Level</label>
                        <div class="pain-scale" style="display: grid; grid-template-columns: repeat(11, 1fr); gap: 8px;">
                            ${[0,1,2,3,4,5,6,7,8,9,10].map(i =>
                                `<button class="pain-btn ${attack.painLevel === i ? 'selected' : ''}" data-pain="${i}" style="padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); cursor: pointer; font-size: 1.1rem; font-weight: 600;">${i}</button>`
                            ).join('')}
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="edit-medication" style="display: block; margin-bottom: 8px; font-weight: 600;">Medication</label>
                        <input type="text" id="edit-medication" value="${attack.medication || ''}" placeholder="e.g., Sumatriptan 100mg" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary);">
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="edit-notes" style="display: block; margin-bottom: 8px; font-weight: 600;">Notes</label>
                        <textarea id="edit-notes" rows="4" placeholder="Any additional details..." style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary); resize: vertical;">${attack.notes || ''}</textarea>
                    </div>

                    ${attack.endNotes ? `
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="edit-end-notes" style="display: block; margin-bottom: 8px; font-weight: 600;">Resolution Notes</label>
                        <textarea id="edit-end-notes" rows="3" placeholder="How did it resolve?" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary); resize: vertical;">${attack.endNotes || ''}</textarea>
                    </div>
                    ` : ''}

                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--accent-green); font-size: 0.9rem; color: var(--text-secondary);">
                        ‚ÑπÔ∏è Weather data and attack ID will be preserved
                    </div>
                </div>
            `;

            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="save-edit-btn">Save Changes</button>
            `;

            document.getElementById('modal-title').textContent = 'Edit Migraine Episode';
            modal.classList.add('active');

            // Pain level selection
            body.querySelectorAll('.pain-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    body.querySelectorAll('.pain-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                });
            });

            // Save button handler
            document.getElementById('save-edit-btn').addEventListener('click', () => {
                saveEditedAttack(attack, isActive);
            });
        }

        function saveEditedAttack(originalAttack, isActive) {
            const startDate = document.getElementById('edit-start-date').value;
            const startTime = document.getElementById('edit-start-time').value;
            const selectedPainBtn = document.querySelector('.pain-btn.selected');
            const medication = document.getElementById('edit-medication').value.trim();
            const notes = document.getElementById('edit-notes').value.trim();

            if (!startDate || !startTime) {
                showModal('Error', 'Please provide start date and time.');
                return;
            }

            if (!selectedPainBtn) {
                showModal('Error', 'Please select a pain level.');
                return;
            }

            const painLevel = parseInt(selectedPainBtn.dataset.pain);
            const startDateTime = new Date(`${startDate}T${startTime}`);

            // Validation: can't set future dates
            if (startDateTime > new Date()) {
                showModal('Error', 'Cannot set future dates.');
                return;
            }

            // Handle end date for completed attacks
            let endDateTime = null;
            let duration = null;
            if (originalAttack.status === 'completed') {
                const endDate = document.getElementById('edit-end-date').value;
                const endTime = document.getElementById('edit-end-time').value;

                if (endDate && endTime) {
                    endDateTime = new Date(`${endDate}T${endTime}`);

                    // Validation: end must be after start
                    if (endDateTime <= startDateTime) {
                        showModal('Error', 'End time must be after start time.');
                        return;
                    }

                    duration = Math.floor((endDateTime - startDateTime) / 1000);
                }
            }

            // Get end notes if present
            const endNotesElement = document.getElementById('edit-end-notes');
            const endNotes = endNotesElement ? endNotesElement.value.trim() : originalAttack.endNotes;

            // Update the attack object
            const updatedAttack = {
                ...originalAttack,
                startTime: startDateTime.toISOString(),
                painLevel: painLevel,
                category: getPainCategory(painLevel),
                medication: medication || null,
                notes: notes,
                lastModified: new Date().toISOString(),
                editCount: (originalAttack.editCount || 0) + 1
            };

            if (endDateTime) {
                updatedAttack.endTime = endDateTime.toISOString();
                updatedAttack.duration = duration;
            }

            if (endNotes) {
                updatedAttack.endNotes = endNotes;
            }

            // Save to the appropriate location
            if (isActive) {
                activeMigraine = updatedAttack;
            } else {
                const index = migraines.findIndex(m => m.id === originalAttack.id);
                if (index !== -1) {
                    migraines[index] = updatedAttack;
                }
            }

            saveData();
            updateDashboard();
            renderCalendar();
            renderHistory();

            closeModal();
            showModal('Success', 'Episode updated successfully!');
        }

        // Relief Method Tracking Functions
        function initializeReliefMethods() {
            const addBtn = document.getElementById('add-relief-btn');
            const inputSection = document.getElementById('relief-input-section');
            const saveBtn = document.getElementById('save-relief-btn');
            const cancelBtn = document.getElementById('cancel-relief-btn');
            const quickBtns = document.querySelectorAll('.relief-quick-btn');
            const customInput = document.getElementById('custom-relief-input');

            if (!addBtn || !inputSection || !saveBtn || !cancelBtn) return;

            // Toggle relief input section
            addBtn.addEventListener('click', () => {
                inputSection.style.display = inputSection.style.display === 'none' ? 'block' : 'none';
                if (inputSection.style.display === 'block') {
                    customInput.value = '';
                    customInput.focus();
                }
            });

            // Handle quick button clicks
            quickBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const reliefMethod = btn.dataset.relief;
                    addReliefMethod(reliefMethod);
                    inputSection.style.display = 'none';
                });
            });

            // Handle save custom relief
            saveBtn.addEventListener('click', () => {
                const customRelief = customInput.value.trim();
                if (customRelief) {
                    addReliefMethod(customRelief);
                    customInput.value = '';
                    inputSection.style.display = 'none';
                } else {
                    showModal('Error', 'Please enter a relief method or use a quick-add button.');
                }
            });

            // Handle cancel
            cancelBtn.addEventListener('click', () => {
                customInput.value = '';
                inputSection.style.display = 'none';
            });

            // Allow Enter key to save
            customInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveBtn.click();
                }
            });
        }

        function addReliefMethod(method) {
            if (!activeMigraine) {
                showModal('Error', 'No active episode found.');
                return;
            }

            // Initialize reliefMethods array if it doesn't exist
            if (!activeMigraine.reliefMethods) {
                activeMigraine.reliefMethods = [];
            }

            const reliefEntry = {
                method: method,
                timestamp: new Date().toISOString()
            };

            activeMigraine.reliefMethods.push(reliefEntry);
            saveData();
            updateReliefTimeline();
        }

        function updateReliefTimeline() {
            if (!activeMigraine || !activeMigraine.reliefMethods || activeMigraine.reliefMethods.length === 0) {
                document.getElementById('active-relief-timeline').style.display = 'none';
                return;
            }

            const timeline = document.getElementById('active-relief-timeline');
            const entriesContainer = document.getElementById('relief-timeline-entries');

            timeline.style.display = 'block';
            entriesContainer.innerHTML = '';

            // Sort by timestamp (newest first)
            const sortedMethods = [...activeMigraine.reliefMethods].sort((a, b) =>
                new Date(b.timestamp) - new Date(a.timestamp)
            );

            sortedMethods.forEach((relief, index) => {
                const entry = document.createElement('div');
                entry.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--bg-secondary); border-radius: 6px; border-left: 3px solid var(--accent-green);';

                const time = formatTime(new Date(relief.timestamp));
                // Find original index in unsorted array for deletion
                const originalIndex = activeMigraine.reliefMethods.findIndex(r =>
                    r.timestamp === relief.timestamp && r.method === relief.method
                );

                entry.innerHTML = `
                    <div style="font-size: 0.85rem; color: var(--text-secondary); min-width: 60px;">${time}</div>
                    <div style="flex: 1; font-size: 0.9rem; color: var(--text-primary);">${relief.method}</div>
                    <button onclick="deleteReliefMethod(${originalIndex})"
                            style="background: none; border: none; color: var(--text-secondary);
                                   cursor: pointer; font-size: 1.1rem; padding: 4px 8px;
                                   transition: var(--transition); line-height: 1;"
                            title="Remove this entry">‚úï</button>
                `;

                entriesContainer.appendChild(entry);
            });
        }

        function deleteReliefMethod(index) {
            if (!activeMigraine || !activeMigraine.reliefMethods) return;

            // Remove the relief method at the specified index
            activeMigraine.reliefMethods.splice(index, 1);
            saveData();
            updateReliefTimeline();
        }

        function updateDashboard() {
            const activeMigraines = getActiveMigraines();
            const total = activeMigraines.length;
            const avgPain = total > 0
                ? (activeMigraines.reduce((sum, m) => sum + m.painLevel, 0) / total).toFixed(1)
                : 0;

            const now = new Date();
            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            const twoWeeksAgo = new Date(now - 14 * 24 * 60 * 60 * 1000);

            const thisWeek = activeMigraines.filter(m => new Date(m.startTime) >= weekAgo).length;
            const lastWeek = activeMigraines.filter(m => {
                const date = new Date(m.startTime);
                return date >= twoWeeksAgo && date < weekAgo;
            }).length;

            const lastEpisode = total > 0
                ? formatRelativeTime(activeMigraines[activeMigraines.length - 1].startTime)
                : '-';
            
            document.getElementById('total-episodes').textContent = total;
            document.getElementById('avg-pain').textContent = avgPain;
            document.getElementById('week-count').textContent = thisWeek;
            document.getElementById('last-episode').textContent = lastEpisode;
            
            const comparison = document.getElementById('week-comparison');
            if (lastWeek > 0) {
                const diff = thisWeek - lastWeek;
                if (diff > 0) {
                    comparison.textContent = `‚Üë +${diff} from last week`;
                    comparison.style.color = 'var(--accent-red)';
                } else if (diff < 0) {
                    comparison.textContent = `‚Üì ${diff} from last week`;
                    comparison.style.color = 'var(--accent-green)';
                } else {
                    comparison.textContent = `‚Üí Same as last week`;
                    comparison.style.color = 'var(--text-secondary)';
                }
            } else {
                comparison.textContent = '';
            }
        }

        function initializeHistory() {}

        function renderHistory() {
            const list = document.getElementById('history-list');
            const activeMigraines = getActiveMigraines();

            if (activeMigraines.length === 0) {
                list.innerHTML = `
                    <div class="section-card" style="text-align: center; padding: 40px;">
                        <h2>üìä No Episodes Yet</h2>
                        <p style="color: var(--text-secondary); margin-top: 12px;">
                            Your migraine history will appear here after you log your first episode.
                        </p>
                    </div>
                `;
                return;
            }

            const sorted = [...activeMigraines].reverse();
            
            list.innerHTML = sorted.map(m => {
                const start = new Date(m.startTime);
                const painProgress = getPainProgression(m);
                
                return `
                    <div class="history-item">
                        <div class="history-header">
                            <div>
                                <div class="history-date">${formatDate(start)}</div>
                                <div class="history-time">${formatTime(start)}</div>
                            </div>
                        </div>
                        <div class="history-details">
                            <div class="history-detail">
                                <span class="detail-label">Pain</span>
                                <span class="detail-value">${painProgress}</span>
                            </div>
                            <div class="history-detail">
                                <span class="detail-label">Duration</span>
                                <span class="detail-value">${formatDuration(m.duration)}</span>
                            </div>
                            <div class="history-detail">
                                <span class="detail-label">Category</span>
                                <span class="detail-value">${m.category}</span>
                            </div>
                        </div>
                        ${m.notes ? `<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 8px;">${m.notes}</p>` : ''}
                        <div class="history-actions">
                            <button class="btn btn-secondary" onclick="viewEpisode(${m.id})">View Details</button>
                            <button class="btn btn-secondary" onclick="editEpisode(${m.id})">Edit</button>
                            <button class="btn btn-secondary" onclick="deleteEpisode(${m.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewEpisode(id) {
            const migraine = migraines.find(m => m.id === id);
            if (!migraine) return;
            
            const start = new Date(migraine.startTime);
            const end = migraine.endTime ? new Date(migraine.endTime) : null;
            
            let content = `
                <p><strong>Started:</strong> ${formatDate(start)} at ${formatTime(start)}</p>
                ${end ? `<p><strong>Ended:</strong> ${formatDate(end)} at ${formatTime(end)}</p>` : ''}
                <p><strong>Duration:</strong> ${formatDuration(migraine.duration)}</p>
                <p><strong>Pain Level:</strong> ${migraine.painLevel}/10 (${migraine.category})</p>
                ${migraine.medication ? `<p><strong>Medication:</strong> ${migraine.medication}</p>` : ''}
            `;
            
            if (migraine.painHistory && migraine.painHistory.length > 1) {
                content += `<h3>Pain Progression</h3><ul>`;
                migraine.painHistory.forEach(p => {
                    content += `<li>${formatTime(new Date(p.timestamp))}: ${p.level}/10</li>`;
                });
                content += `</ul>`;
            }

            if (migraine.reliefMethods && migraine.reliefMethods.length > 0) {
                content += `<h3>Relief Methods</h3><ul>`;
                migraine.reliefMethods.forEach(r => {
                    content += `<li>${formatTime(new Date(r.timestamp))}: ${r.method}</li>`;
                });
                content += `</ul>`;
            }

            if (migraine.notes) {
                content += `<h3>Notes</h3><p>${migraine.notes}</p>`;
            }

            if (migraine.endNotes) {
                content += `<h3>Resolution Notes</h3><p>${migraine.endNotes}</p>`;
            }

            showModal('Episode Details', content);
        }

        // Temporary storage for relief methods being edited
        let tempReliefMethods = [];

        function editEpisode(id) {
            const migraine = migraines.find(m => m.id === id);
            if (!migraine) return;

            // Copy relief methods to temporary storage
            tempReliefMethods = migraine.reliefMethods ? [...migraine.reliefMethods] : [];

            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            body.innerHTML = `
                <div class="form-group">
                    <label>üíä Medication</label>
                    <input type="text" id="edit-medication" value="${migraine.medication || ''}"
                           placeholder="e.g. Sumatriptan 100mg"
                           style="width: 100%; padding: 12px; background: var(--bg-tertiary);
                                  border: 1px solid var(--border-color); border-radius: 8px;
                                  color: var(--text-primary); font-size: 1rem;">
                </div>
                <div class="form-group">
                    <label>üìù Notes</label>
                    <textarea id="edit-notes" rows="4" placeholder="Add any notes about this episode..."
                              style="width: 100%; padding: 12px; background: var(--bg-tertiary);
                                     border: 1px solid var(--border-color); border-radius: 8px;
                                     color: var(--text-primary); font-size: 1rem; resize: vertical; min-height: 80px;">${migraine.notes || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>üèÅ Resolution Notes</label>
                    <textarea id="edit-end-notes" rows="3" placeholder="How did it resolve? What helped?"
                              style="width: 100%; padding: 12px; background: var(--bg-tertiary);
                                     border: 1px solid var(--border-color); border-radius: 8px;
                                     color: var(--text-primary); font-size: 1rem; resize: vertical; min-height: 80px;">${migraine.endNotes || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>üíäüßä Relief Methods</label>
                    <div id="edit-relief-methods-list" style="margin-bottom: 12px;"></div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="new-relief-method" placeholder="Add relief method (e.g., Ice pack, Sumatriptan)"
                               style="flex: 1; padding: 10px; background: var(--bg-tertiary);
                                      border: 1px solid var(--border-color); border-radius: 8px;
                                      color: var(--text-primary); font-size: 0.95rem;">
                        <button onclick="addEditReliefMethod()" class="btn btn-secondary" style="white-space: nowrap;">Add</button>
                    </div>
                </div>
            `;

            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEpisodeEdit(${id})">Save Changes</button>
            `;

            document.getElementById('modal-title').textContent = 'Edit Episode';
            modal.classList.add('active');

            // Render relief methods list
            renderEditReliefMethods();

            // Allow Enter key to add relief method
            document.getElementById('new-relief-method').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addEditReliefMethod();
                }
            });
        }

        function renderEditReliefMethods() {
            const list = document.getElementById('edit-relief-methods-list');
            if (!list) return;

            if (tempReliefMethods.length === 0) {
                list.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.9rem; padding: 8px; text-align: center;">No relief methods logged</div>';
                return;
            }

            list.innerHTML = tempReliefMethods.map((relief, index) => {
                const time = formatTime(new Date(relief.timestamp));
                return `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 6px;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary); min-width: 60px;">${time}</div>
                        <input type="text" value="${relief.method}" onchange="updateEditReliefMethod(${index}, this.value)"
                               style="flex: 1; padding: 6px 10px; background: var(--bg-tertiary);
                                      border: 1px solid var(--border-color); border-radius: 6px;
                                      color: var(--text-primary); font-size: 0.9rem;">
                        <button onclick="deleteEditReliefMethod(${index})"
                                style="background: none; border: none; color: var(--text-secondary);
                                       cursor: pointer; font-size: 1.1rem; padding: 4px 8px;"
                                title="Remove">‚úï</button>
                    </div>
                `;
            }).join('');
        }

        function addEditReliefMethod() {
            const input = document.getElementById('new-relief-method');
            const method = input.value.trim();

            if (!method) return;

            tempReliefMethods.push({
                method: method,
                timestamp: new Date().toISOString()
            });

            input.value = '';
            renderEditReliefMethods();
        }

        function updateEditReliefMethod(index, newValue) {
            if (tempReliefMethods[index]) {
                tempReliefMethods[index].method = newValue;
            }
        }

        function deleteEditReliefMethod(index) {
            tempReliefMethods.splice(index, 1);
            renderEditReliefMethods();
        }

        function saveEpisodeEdit(id) {
            const migraine = migraines.find(m => m.id === id);
            if (!migraine) return;

            const medication = document.getElementById('edit-medication').value.trim();
            const notes = document.getElementById('edit-notes').value.trim();
            const endNotes = document.getElementById('edit-end-notes').value.trim();

            migraine.medication = medication || null;
            migraine.notes = notes || null;
            migraine.endNotes = endNotes || null;
            migraine.reliefMethods = tempReliefMethods.length > 0 ? tempReliefMethods : null;

            saveData();
            renderHistory();
            closeModal();
            showModal('Changes Saved', 'Episode has been updated successfully.');
        }

        function deleteEpisode(id) {
            const modal = document.getElementById('modal');
            document.getElementById('modal-title').textContent = 'Delete Episode?';
            document.getElementById('modal-body').innerHTML = '<p>This episode will be moved to trash and can be recovered within 30 days.</p>';
            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmDelete(${id})">Move to Trash</button>
            `;
            modal.classList.add('active');
        }

        function confirmDelete(id) {
            const migraine = migraines.find(m => m.id === id);
            if (migraine) {
                migraine.deleted = true;
                migraine.deletedAt = new Date().toISOString();
                saveData();
                renderHistory();
                updateDashboard();
                renderCalendar();
                closeModal();
                showModal('Moved to Trash', 'Episode moved to trash. You can restore it from Settings within 30 days.');
            }
        }

        function getActiveMigraines() {
            return migraines.filter(m => !m.deleted);
        }

        function getDeletedMigraines() {
            // Auto-purge episodes older than 30 days
            const now = new Date();
            const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);

            return migraines.filter(m => {
                if (!m.deleted) return false;
                const deletedDate = new Date(m.deletedAt);
                return deletedDate >= thirtyDaysAgo;
            });
        }

        function purgeOldDeletedEpisodes() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);

            const beforeCount = migraines.length;
            migraines = migraines.filter(m => {
                if (!m.deleted) return true;
                const deletedDate = new Date(m.deletedAt);
                return deletedDate >= thirtyDaysAgo;
            });

            const purgedCount = beforeCount - migraines.length;
            if (purgedCount > 0) {
                saveData();
            }
        }

        function viewTrash() {
            const deletedMigraines = getDeletedMigraines();

            if (deletedMigraines.length === 0) {
                showModal('Trash Empty', '<p style="text-align: center;">No recently deleted episodes.</p>');
                return;
            }

            const now = new Date();

            let content = `
                <div style="margin-bottom: 20px;">
                    <p style="text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                        Episodes are automatically deleted after 30 days.
                    </p>
                </div>
            `;

            deletedMigraines
                .sort((a, b) => new Date(b.deletedAt) - new Date(a.deletedAt))
                .forEach(m => {
                    const deletedDate = new Date(m.deletedAt);
                    const daysRemaining = Math.ceil(30 - (now - deletedDate) / (1000 * 60 * 60 * 24));
                    const startDate = new Date(m.startTime);

                    content += `
                        <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border-left: 4px solid ${
                            m.category === 'Severe' ? 'var(--pain-severe)' :
                            m.category === 'Moderate' ? 'var(--pain-moderate)' :
                            'var(--pain-mild)'
                        };">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div>
                                    <p style="font-weight: 600; margin-bottom: 4px;">${formatDate(startDate)}</p>
                                    <p style="font-size: 0.9rem; color: var(--text-secondary);">
                                        ${formatTime(startDate)} ‚Ä¢ ${m.category} (${m.painLevel}/10)
                                    </p>
                                </div>
                                <span style="font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap;">
                                    ${daysRemaining} day${daysRemaining !== 1 ? 's' : ''} left
                                </span>
                            </div>
                            ${m.medication ? `<p style="font-size: 0.9rem; margin-bottom: 4px;">üíä ${m.medication}</p>` : ''}
                            ${m.notes ? `<p style="font-size: 0.9rem; margin-bottom: 4px;">üìù ${m.notes}</p>` : ''}
                            <div style="display: flex; gap: 8px; margin-top: 12px;">
                                <button class="btn btn-primary" style="flex: 1; padding: 8px;" onclick="restoreEpisode(${m.id})">
                                    ‚ôªÔ∏è Restore
                                </button>
                                <button class="btn btn-danger" style="flex: 1; padding: 8px;" onclick="permanentlyDelete(${m.id})">
                                    üóëÔ∏è Delete Forever
                                </button>
                            </div>
                        </div>
                    `;
                });

            content += `
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                    <button class="btn btn-danger" style="width: 100%;" onclick="emptyTrash()">
                        üóëÔ∏è Empty Trash (Delete All)
                    </button>
                </div>
            `;

            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            const actions = document.getElementById('modal-actions');

            document.getElementById('modal-title').textContent = `Trash (${deletedMigraines.length})`;
            body.innerHTML = content;
            actions.innerHTML = '<button class="btn btn-secondary" onclick="closeModal()">Close</button>';
            modal.classList.add('active');
        }

        function restoreEpisode(id) {
            const migraine = migraines.find(m => m.id === id);
            if (migraine && migraine.deleted) {
                delete migraine.deleted;
                delete migraine.deletedAt;
                saveData();
                renderHistory();
                updateDashboard();
                renderCalendar();
                updateStorageInfo();
                viewTrash(); // Refresh trash view
                showModal('Episode Restored', 'The episode has been restored successfully.');
            }
        }

        function permanentlyDelete(id) {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            const actions = document.getElementById('modal-actions');

            body.innerHTML = `
                <p style="text-align: center;">Are you sure you want to permanently delete this episode?</p>
                <p style="text-align: center; color: var(--accent-red); font-weight: 600;">This action cannot be undone.</p>
            `;

            actions.innerHTML = `
                <button class="btn btn-secondary" onclick="viewTrash()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmPermanentDelete(${id})">Delete Forever</button>
            `;

            document.getElementById('modal-title').textContent = 'Confirm Permanent Deletion';
        }

        function confirmPermanentDelete(id) {
            const index = migraines.findIndex(m => m.id === id);
            if (index !== -1) {
                migraines.splice(index, 1);
                saveData();
                updateStorageInfo();
                viewTrash(); // Refresh trash view
            }
        }

        function emptyTrash() {
            const deletedCount = getDeletedMigraines().length;

            if (deletedCount === 0) {
                showModal('Trash Empty', '<p style="text-align: center;">No episodes to delete.</p>');
                return;
            }

            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            const actions = document.getElementById('modal-actions');

            body.innerHTML = `
                <p style="text-align: center;">Are you sure you want to permanently delete all ${deletedCount} episode${deletedCount !== 1 ? 's' : ''} from trash?</p>
                <p style="text-align: center; color: var(--accent-red); font-weight: 600;">This action cannot be undone.</p>
            `;

            actions.innerHTML = `
                <button class="btn btn-secondary" onclick="viewTrash()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmEmptyTrash()">Empty Trash</button>
            `;

            document.getElementById('modal-title').textContent = 'Empty Trash';
        }

        function confirmEmptyTrash() {
            migraines = migraines.filter(m => !m.deleted);
            saveData();
            renderHistory();
            updateDashboard();
            renderCalendar();
            updateStorageInfo();
            closeModal();
            showModal('Trash Emptied', 'All deleted episodes have been permanently removed.');
        }

        function initializeCalendar() {
            document.getElementById('prev-month').addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() - 1);
                renderCalendar();
            });
            
            document.getElementById('next-month').addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
                renderCalendar();
            });
        }

        // Helper function to get all calendar days a migraine spans
        function getMigraineDays(migraine) {
            const days = [];
            const startDate = new Date(migraine.startTime);

            // Calculate end date
            let endDate;
            if (migraine.endTime) {
                endDate = new Date(migraine.endTime);
            } else if (migraine.duration) {
                endDate = new Date(startDate.getTime() + migraine.duration * 60 * 1000);
            } else {
                // If still active or no end time, just count the start day
                endDate = startDate;
            }

            // Get all days between start and end (inclusive)
            const currentDate = new Date(startDate);
            currentDate.setHours(0, 0, 0, 0);
            const finalDate = new Date(endDate);
            finalDate.setHours(0, 0, 0, 0);

            while (currentDate <= finalDate) {
                days.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            return days;
        }

        function updateMonthlyStats() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            // Get migraine days for current month
            const activeMigraines = getActiveMigraines();
            const monthStart = new Date(year, month, 1);
            const monthEnd = new Date(year, month + 1, 0, 23, 59, 59);

            // Count unique days with migraines (including multi-day attacks)
            const migraineDays = new Set();
            activeMigraines.forEach(m => {
                const days = getMigraineDays(m);
                days.forEach(day => {
                    const dayDate = new Date(day + 'T00:00:00');
                    if (dayDate >= monthStart && dayDate <= monthEnd) {
                        migraineDays.add(day);
                    }
                });
            });

            const currentMonthDays = migraineDays.size;

            // Get previous month's data for comparison
            const prevMonthStart = new Date(year, month - 1, 1);
            const prevMonthEnd = new Date(year, month, 0, 23, 59, 59);
            const prevMigraineDays = new Set();
            activeMigraines.forEach(m => {
                const days = getMigraineDays(m);
                days.forEach(day => {
                    const dayDate = new Date(day + 'T00:00:00');
                    if (dayDate >= prevMonthStart && dayDate <= prevMonthEnd) {
                        prevMigraineDays.add(day);
                    }
                });
            });

            const prevMonthDays = prevMigraineDays.size;
            const difference = currentMonthDays - prevMonthDays;

            // Update display
            document.getElementById('current-month-days').textContent = currentMonthDays;

            // Determine clinical status based on research thresholds
            let status, statusColor;
            if (currentMonthDays >= 15) {
                status = 'Chronic Migraine';
                statusColor = 'var(--pain-severe)';
            } else if (currentMonthDays >= 10) {
                status = 'High-Frequency';
                statusColor = 'var(--pain-moderate)';
            } else if (currentMonthDays >= 4) {
                status = 'Episodic Migraine';
                statusColor = 'var(--accent-blue)';
            } else {
                status = 'Low-Frequency';
                statusColor = 'var(--accent-green)';
            }

            const statusEl = document.getElementById('current-month-status');
            statusEl.textContent = status;
            statusEl.style.color = statusColor;

            // Update trend indicator (compact format)
            const trendEl = document.getElementById('month-trend');
            if (difference > 0) {
                trendEl.textContent = `(‚Üë${difference})`;
                trendEl.className = 'stat-trend positive';
            } else if (difference < 0) {
                trendEl.textContent = `(‚Üì${Math.abs(difference)})`;
                trendEl.className = 'stat-trend negative';
            } else if (prevMonthDays > 0) {
                trendEl.textContent = '(same)';
                trendEl.className = 'stat-trend neutral';
            } else {
                trendEl.textContent = '';
                trendEl.className = '';
            }
        }

        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            document.getElementById('current-month').textContent =
                new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Update monthly stats
            updateMonthlyStats();

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            let html = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d =>
                `<div class="calendar-day empty" style="font-weight: 600;">${d}</div>`
            ).join('');

            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            const activeMigraines = getActiveMigraines();

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];

                // Check if any attacks started on this day
                const dayMigraines = activeMigraines.filter(m => {
                    const mDate = new Date(m.startTime).toISOString().split('T')[0];
                    return mDate === dateStr;
                });

                // Check if any attacks are ongoing on this day (but started earlier)
                const continuationMigraines = activeMigraines.filter(m => {
                    const startDate = new Date(m.startTime);
                    const endDate = m.endTime ? new Date(m.endTime) : new Date();
                    const currentDate = new Date(dateStr + 'T23:59:59'); // End of the day

                    // Check if this day falls within the attack duration but is not the start day
                    const mDate = new Date(m.startTime).toISOString().split('T')[0];
                    return mDate !== dateStr && startDate < currentDate && endDate >= date;
                });

                let classes = 'calendar-day';

                // Priority: Start days get full color, continuation days get faded color
                if (dayMigraines.length > 0) {
                    classes += ' has-episode';

                    const maxStartingPain = Math.max(...dayMigraines.map(m => {
                        if (m.painHistory && m.painHistory.length > 0) {
                            return m.painHistory[0].level;
                        }
                        return m.painLevel;
                    }));

                    if (maxStartingPain <= 3) classes += ' mild';
                    else if (maxStartingPain <= 6) classes += ' moderate';
                    else classes += ' severe';
                } else if (continuationMigraines.length > 0) {
                    // This day is a continuation day (not the start day)
                    const maxContinuationPain = Math.max(...continuationMigraines.map(m => {
                        if (m.painHistory && m.painHistory.length > 0) {
                            return m.painHistory[0].level;
                        }
                        return m.painLevel;
                    }));

                    if (maxContinuationPain <= 3) classes += ' mild-continuation';
                    else if (maxContinuationPain <= 6) classes += ' moderate-continuation';
                    else classes += ' severe-continuation';
                }
                
                if (date.toDateString() === today.toDateString()) {
                    classes += ' today';
                }
                
                if (activeMigraine) {
                    const activeDate = new Date(activeMigraine.startTime).toISOString().split('T')[0];
                    if (dateStr === activeDate) {
                        classes += ' active-indicator';
                    }
                }

                // Add pressure indicator if weather tracking enabled
                let pressureIndicator = '';
                if (weatherData.enabled && weatherData.history.length > 0) {
                    const weatherEntry = weatherData.history.find(w => w.date.startsWith(dateStr));
                    if (weatherEntry) {
                        // Find previous day to calculate change
                        const prevDate = new Date(date);
                        prevDate.setDate(prevDate.getDate() - 1);
                        const prevDateStr = prevDate.toISOString().split('T')[0];
                        const prevEntry = weatherData.history.find(w => w.date.startsWith(prevDateStr));

                        if (prevEntry) {
                            // Use dailyAvg or fallback to pressure for old data
                            const todayPressure = weatherEntry.dailyAvg || weatherEntry.pressure;
                            const yesterdayPressure = prevEntry.dailyAvg || prevEntry.pressure;

                            if (todayPressure && yesterdayPressure) {
                                const change = todayPressure - yesterdayPressure;
                                let icon = '‚Üí';
                                let color = 'var(--text-secondary)';

                                // Show rapid change indicator if available
                                // Updated threshold: 5+ hPa in 6h (research-validated)
                                if (weatherEntry.maxChange3h && weatherEntry.maxChange3h >= 5) {
                                    icon = '‚ö°';
                                    color = 'var(--accent-red)';
                                } else if (change > 5) {
                                    icon = '‚Üë';
                                    color = 'var(--accent-green)';
                                } else if (change < -5) {
                                    icon = '‚Üì';
                                    color = 'var(--pain-moderate)';
                                }

                                pressureIndicator = `<span class="pressure-indicator" style="color: ${color}">${icon}</span>`;
                            }
                        }
                    }
                }

                html += `<div class="${classes}" onclick="showDayDetails('${dateStr}')">
                    ${day}${pressureIndicator}
                </div>`;
            }
            
            document.getElementById('calendar-grid').innerHTML = html;
        }

        function showDayDetails(dateStr) {
            const activeMigraines = getActiveMigraines();

            // Find attacks that started on this day
            const startedToday = activeMigraines.filter(m => {
                const mDate = new Date(m.startTime).toISOString().split('T')[0];
                return mDate === dateStr;
            });

            // Find attacks ongoing on this day (but started earlier)
            const ongoingToday = activeMigraines.filter(m => {
                const startDate = new Date(m.startTime);
                const endDate = m.endTime ? new Date(m.endTime) : new Date();
                const date = new Date(dateStr + 'T00:00:00');
                const currentDate = new Date(dateStr + 'T23:59:59');

                const mDate = new Date(m.startTime).toISOString().split('T')[0];
                return mDate !== dateStr && startDate < currentDate && endDate >= date;
            });

            const date = new Date(dateStr + 'T00:00:00');

            // Check for weather data on this day
            let weatherContent = '';
            if (weatherData.enabled && weatherData.history.length > 0) {
                const weatherEntry = weatherData.history.find(w => w.date.startsWith(dateStr));
                if (weatherEntry) {
                    const prevDate = new Date(date);
                    prevDate.setDate(prevDate.getDate() - 1);
                    const prevDateStr = prevDate.toISOString().split('T')[0];
                    const prevEntry = weatherData.history.find(w => w.date.startsWith(prevDateStr));

                    // Use dailyAvg or fallback to pressure for old data
                    const todayPressure = weatherEntry.dailyAvg || weatherEntry.pressure;
                    const yesterdayPressure = prevEntry ? (prevEntry.dailyAvg || prevEntry.pressure) : null;

                    if (todayPressure) {
                        let changeInfo = '';
                        if (yesterdayPressure) {
                            const change = todayPressure - yesterdayPressure;
                            const changeText = change > 0 ? `+${change.toFixed(1)}` : change.toFixed(1);
                            const trend = change > 5 ? '‚Üë Rising' : change < -5 ? '‚Üì Falling' : '‚Üí Stable';

                            changeInfo = `
                                <p>24h Change: ${changeText} hPa (${trend})</p>
                                ${Math.abs(change) > 5 ? `<p style="color: var(--pain-moderate); margin-top: 4px;">‚ö†Ô∏è Significant 24h change</p>` : ''}
                            `;
                        }

                        // Show rapid change info if available
                        // Updated threshold: 5+ hPa in 6h (research-validated)
                        let rapidChangeInfo = '';
                        if (weatherEntry.maxChange3h && weatherEntry.maxChange3h >= 5) {
                            rapidChangeInfo = `<p style="color: var(--accent-red); margin-top: 4px;">‚ö° Rapid change: ${weatherEntry.maxChange3h} hPa in 6h</p>`;
                        }

                        weatherContent = `
                            <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--accent-green);">
                                <p><strong>‚òÅÔ∏è Weather Conditions</strong></p>
                                <p>Pressure: ${todayPressure.toFixed(1)} hPa</p>
                                ${changeInfo}
                                ${rapidChangeInfo}
                            </div>
                        `;
                    }
                }
            }

            if (startedToday.length === 0 && ongoingToday.length === 0) {
                const noEpisodeContent = weatherContent || '<p>No episodes logged on this day.</p>';
                showModal(formatDate(date), noEpisodeContent);
                return;
            }

            let content = weatherContent;

            if (startedToday.length > 0) {
                content += startedToday.map(m => `
                    <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; position: relative;">
                        <button onclick="editAttack(${m.id})" style="position: absolute; top: 8px; right: 8px; background: var(--accent-blue); color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 4px;" title="Edit this episode">
                            ‚úèÔ∏è Edit
                        </button>
                        <p><strong>Started: ${formatTime(new Date(m.startTime))}</strong></p>
                        <p>Pain: ${m.painLevel}/10 (${m.category})</p>
                        <p>Duration: ${formatDuration(m.duration)}</p>
                        ${m.medication ? `<p>üíä Medication: ${m.medication}</p>` : ''}
                        ${m.notes ? `<p style="margin-top: 8px;">üìù Notes: ${m.notes}</p>` : ''}
                        ${m.endNotes ? `<p style="margin-top: 8px;">üèÅ Resolution: ${m.endNotes}</p>` : ''}
                    </div>
                `).join('');
            }

            if (ongoingToday.length > 0) {
                content += ongoingToday.map(m => `
                    <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--accent-blue); position: relative;">
                        <button onclick="editAttack(${m.id})" style="position: absolute; top: 8px; right: 8px; background: var(--accent-blue); color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 4px;" title="Edit this episode">
                            ‚úèÔ∏è Edit
                        </button>
                        <p><strong>Ongoing Attack</strong></p>
                        <p>Started: ${formatTime(new Date(m.startTime))}</p>
                        <p>Pain: ${m.painLevel}/10 (${m.category})</p>
                        <p>Duration: ${formatDuration(m.duration)}</p>
                        ${m.medication ? `<p>üíä Medication: ${m.medication}</p>` : ''}
                        ${m.notes ? `<p style="margin-top: 8px;">üìù Notes: ${m.notes}</p>` : ''}
                        ${m.endNotes ? `<p style="margin-top: 8px;">üèÅ Resolution: ${m.endNotes}</p>` : ''}
                    </div>
                `).join('');
            }

            showModal(formatDate(date), content);
        }

        function initializeSettings() {
            updateStorageInfo();

            document.getElementById('export-json-btn').addEventListener('click', exportJSON);

            document.getElementById('export-csv-btn').addEventListener('click', exportCSV);

            document.getElementById('export-pdf-btn').addEventListener('click', showPDFDateRangeModal);

            document.getElementById('import-json-btn').addEventListener('click', () => {
                document.getElementById('import-file-input').click();
            });

            document.getElementById('import-csv-btn').addEventListener('click', () => {
                document.getElementById('import-csv-input').click();
            });

            document.getElementById('import-file-input').addEventListener('change', handleImport);

            document.getElementById('import-csv-input').addEventListener('change', handleCSVImport);

            document.getElementById('view-trash-btn').addEventListener('click', viewTrash);

            document.getElementById('tour-btn').addEventListener('click', () => {
                showPage('log');
                setTimeout(() => {
                    startGuidedTour();
                }, 400);
            });

            document.getElementById('how-to-btn').addEventListener('click', showHowTo);
            document.getElementById('about-btn').addEventListener('click', showAbout);
            document.getElementById('privacy-btn').addEventListener('click', showPrivacy);

            document.getElementById('clear-all-btn').addEventListener('click', clearAllData);

            initializeNotifications();
        }

        function updateStorageInfo() {
            const activeMigraines = getActiveMigraines();
            const deletedMigraines = getDeletedMigraines();
            const episodes = activeMigraines.length;
            const dataStr = JSON.stringify(migraines);
            const sizeBytes = new Blob([dataStr]).size;
            const sizeKB = (sizeBytes / 1024).toFixed(2);
            const lastBackup = localStorage.getItem('lastBackup') || 'Never';

            document.getElementById('storage-episodes').textContent = episodes;
            document.getElementById('storage-size').textContent = `${sizeKB} KB`;
            document.getElementById('last-backup').textContent = lastBackup;

            const trashCount = document.getElementById('trash-count');
            const trashSubtitle = document.getElementById('trash-subtitle');
            if (trashCount) {
                trashCount.textContent = deletedMigraines.length;
            }
            if (trashSubtitle) {
                const itemText = deletedMigraines.length === 1 ? 'item' : 'items';
                trashSubtitle.textContent = `${deletedMigraines.length} ${itemText}`;
            }
        }

        function exportJSON() {
            const activeMigraines = getActiveMigraines();
            const data = {
                appVersion: '1.5.0',
                exportDate: new Date().toISOString(),
                totalEpisodes: activeMigraines.length,
                migraines: activeMigraines
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aiding-migraine-backup-${formatDateFile(new Date())}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            localStorage.setItem('lastBackup', formatDate(new Date()));
            updateStorageInfo();
            
            showModal('Export Complete', 'Your data has been exported successfully.');
        }

        function handleImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.name.endsWith('.json')) {
                showModal('Invalid File Type',
                    '<p>Please select a JSON file (.json).</p>' +
                    '<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 12px;">Backup files exported from this app end with .json</p>');
                e.target.value = '';
                return;
            }

            // Validate file size (max 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showModal('File Too Large',
                    '<p>The selected file is too large. Maximum size is 10MB.</p>' +
                    '<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 12px;">If you have many episodes, try exporting a smaller date range.</p>');
                e.target.value = '';
                return;
            }

            // Check for empty file
            if (file.size === 0) {
                showModal('Empty File', '<p>The selected file is empty. Please select a valid backup file.</p>');
                e.target.value = '';
                return;
            }

            const reader = new FileReader();

            reader.onerror = () => {
                showModal('File Read Error',
                    '<p>Could not read the file. Please try again.</p>' +
                    '<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 12px;">Make sure the file is not corrupted or in use by another program.</p>');
                e.target.value = '';
            };

            reader.onload = (event) => {
                try {
                    const text = event.target.result;

                    // Check for empty content
                    if (!text || text.trim().length === 0) {
                        throw new Error('EMPTY_CONTENT');
                    }

                    // Parse JSON
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (parseError) {
                        throw new Error('INVALID_JSON');
                    }

                    // Validate structure
                    if (!data || typeof data !== 'object') {
                        throw new Error('INVALID_STRUCTURE');
                    }

                    if (!data.migraines) {
                        throw new Error('MISSING_MIGRAINES');
                    }

                    if (!Array.isArray(data.migraines)) {
                        throw new Error('MIGRAINES_NOT_ARRAY');
                    }

                    if (data.migraines.length === 0) {
                        showModal('Empty Backup',
                            '<p>This backup file contains no episodes.</p>' +
                            '<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 12px;">The file is valid but has no data to import.</p>');
                        e.target.value = '';
                        return;
                    }

                    // Validate individual episodes
                    const validationResult = validateEpisodes(data.migraines);

                    if (!validationResult.valid) {
                        showModal('Invalid Episode Data',
                            `<p>Some episodes in the backup file have invalid data:</p>` +
                            `<ul style="margin: 12px 0; padding-left: 20px; color: var(--text-secondary);">` +
                            validationResult.errors.slice(0, 5).map(err => `<li>${err}</li>`).join('') +
                            (validationResult.errors.length > 5 ? `<li>...and ${validationResult.errors.length - 5} more</li>` : '') +
                            `</ul>` +
                            `<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 12px;">This may not be a valid Aiding Migraine backup file.</p>`);
                        e.target.value = '';
                        return;
                    }

                    // Check storage space
                    const importSize = new Blob([text]).size;
                    const storageCheck = checkStorageSpace(importSize);

                    if (!storageCheck.hasSpace) {
                        showModal('Storage Full',
                            `<p>Not enough storage space to import this file.</p>` +
                            `<div style="margin: 16px 0; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; font-size: 0.9rem;">` +
                            `<p>Current data: <strong>${storageCheck.currentMB} MB</strong></p>` +
                            `<p>Import size: <strong>${storageCheck.importMB} MB</strong></p>` +
                            `<p>Total would be: <strong>${storageCheck.totalMB} MB</strong></p>` +
                            `<p>Storage limit: <strong>${storageCheck.limitMB} MB</strong></p>` +
                            `</div>` +
                            `<p style="color: var(--text-secondary); font-size: 0.9rem;">Try exporting and deleting old episodes, or empty your trash to free up space.</p>`);
                        e.target.value = '';
                        return;
                    }

                    // Analyze import data
                    const analysis = analyzeImportData(data.migraines);

                    // Show import review UI with storage warning if needed
                    showImportReviewModal(data.migraines, analysis, storageCheck);

                } catch (error) {
                    let title = 'Import Failed';
                    let message = '';

                    switch (error.message) {
                        case 'EMPTY_CONTENT':
                            message = '<p>The file appears to be empty or contains only whitespace.</p>';
                            break;
                        case 'INVALID_JSON':
                            message = '<p>The file is not valid JSON format.</p>' +
                                     '<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 12px;">Make sure you selected a backup file exported from Aiding Migraine.</p>';
                            break;
                        case 'INVALID_STRUCTURE':
                            message = '<p>The file structure is not recognized.</p>' +
                                     '<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 12px;">This doesn\'t appear to be an Aiding Migraine backup file.</p>';
                            break;
                        case 'MISSING_MIGRAINES':
                            message = '<p>The file is missing the required "migraines" data field.</p>' +
                                     '<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 12px;">This may be from a different app or an older version.</p>';
                            break;
                        case 'MIGRAINES_NOT_ARRAY':
                            message = '<p>The episodes data is in an incorrect format.</p>' +
                                     '<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 12px;">The file may be corrupted.</p>';
                            break;
                        default:
                            message = '<p>The file you selected could not be imported.</p>' +
                                     '<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 12px;">Please make sure it\'s a valid backup file from Aiding Migraine.</p>';
                    }

                    showModal(title, message);
                }

                e.target.value = '';
            };

            reader.readAsText(file);
        }

        function sanitizeHTML(text) {
            if (!text || typeof text !== 'string') return text;

            // Create a temporary div to use browser's HTML parser
            const temp = document.createElement('div');
            temp.textContent = text;
            return temp.innerHTML;
        }

        function sanitizeEpisode(episode) {
            // Sanitize text fields to prevent XSS
            const textFields = ['notes', 'medication', 'endNotes', 'triggers'];

            textFields.forEach(field => {
                if (episode[field]) {
                    episode[field] = sanitizeHTML(episode[field]);
                }
            });

            return episode;
        }

        function checkStorageSpace(dataSize) {
            try {
                // Get current storage usage
                const currentData = localStorage.getItem('migraines') || '[]';
                const currentSize = new Blob([currentData]).size;

                // Estimate total size after import
                const estimatedTotal = currentSize + dataSize;

                // LocalStorage limit is typically 5-10MB, we'll use 5MB as conservative estimate
                const storageLimit = 5 * 1024 * 1024; // 5MB

                // Check if we're approaching the limit (use 80% threshold)
                const threshold = storageLimit * 0.8;

                if (estimatedTotal > threshold) {
                    const currentMB = (currentSize / (1024 * 1024)).toFixed(2);
                    const importMB = (dataSize / (1024 * 1024)).toFixed(2);
                    const totalMB = (estimatedTotal / (1024 * 1024)).toFixed(2);

                    return {
                        hasSpace: estimatedTotal <= storageLimit,
                        warning: estimatedTotal > threshold && estimatedTotal <= storageLimit,
                        currentMB: currentMB,
                        importMB: importMB,
                        totalMB: totalMB,
                        limitMB: (storageLimit / (1024 * 1024)).toFixed(2)
                    };
                }

                return { hasSpace: true, warning: false };
            } catch (e) {
                // If we can't check, assume it's okay but log the error
                console.error('Storage check failed:', e);
                return { hasSpace: true, warning: false };
            }
        }

        function validateEpisodes(episodes) {
            const errors = [];
            const requiredFields = ['id', 'startTime', 'painLevel', 'category', 'duration'];

            episodes.forEach((episode, index) => {
                // Check if episode is an object
                if (!episode || typeof episode !== 'object') {
                    errors.push(`Episode ${index + 1}: Invalid episode format`);
                    return;
                }

                // Check required fields
                requiredFields.forEach(field => {
                    if (episode[field] === undefined || episode[field] === null) {
                        errors.push(`Episode ${index + 1}: Missing required field "${field}"`);
                    }
                });

                // Validate specific fields
                if (episode.painLevel !== undefined) {
                    if (typeof episode.painLevel !== 'number' || episode.painLevel < 1 || episode.painLevel > 10) {
                        errors.push(`Episode ${index + 1}: Pain level must be between 1-10`);
                    }
                }

                if (episode.startTime !== undefined) {
                    const date = new Date(episode.startTime);
                    if (isNaN(date.getTime())) {
                        errors.push(`Episode ${index + 1}: Invalid start time format`);
                    }
                }

                if (episode.category !== undefined) {
                    if (!['Mild', 'Moderate', 'Severe'].includes(episode.category)) {
                        errors.push(`Episode ${index + 1}: Invalid category "${episode.category}"`);
                    }
                }

                if (episode.duration !== undefined) {
                    if (typeof episode.duration !== 'number' || episode.duration < 0) {
                        errors.push(`Episode ${index + 1}: Invalid duration value`);
                    }
                }

                // Sanitize text fields to prevent XSS attacks
                sanitizeEpisode(episode);
            });

            return {
                valid: errors.length === 0,
                errors: errors
            };
        }

        function analyzeImportData(importedEpisodes) {
            const newEpisodes = [];
            const duplicates = [];
            const conflicts = [];

            importedEpisodes.forEach(imported => {
                // Check for exact ID match
                const exactMatch = migraines.find(m => m.id === imported.id);

                if (exactMatch) {
                    // Check if data is identical or different
                    const isDifferent = JSON.stringify(exactMatch) !== JSON.stringify(imported);

                    if (isDifferent) {
                        conflicts.push({
                            imported: imported,
                            existing: exactMatch,
                            matchType: 'id'
                        });
                    } else {
                        duplicates.push({
                            imported: imported,
                            existing: exactMatch,
                            matchType: 'exact'
                        });
                    }
                } else {
                    // Check for timestamp proximity (within 1 minute)
                    const importTime = new Date(imported.startTime).getTime();
                    const proximityMatch = migraines.find(m => {
                        const existingTime = new Date(m.startTime).getTime();
                        const diff = Math.abs(importTime - existingTime);
                        return diff < 60000; // 1 minute
                    });

                    if (proximityMatch) {
                        // Similar timing - could be duplicate
                        conflicts.push({
                            imported: imported,
                            existing: proximityMatch,
                            matchType: 'time'
                        });
                    } else {
                        // Truly new episode
                        newEpisodes.push(imported);
                    }
                }
            });

            return {
                total: importedEpisodes.length,
                new: newEpisodes,
                duplicates: duplicates,
                conflicts: conflicts
            };
        }

        function showImportReviewModal(importedEpisodes, analysis, storageCheck) {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            let summaryHTML = ``;

            // Show storage warning if approaching limit
            if (storageCheck && storageCheck.warning) {
                summaryHTML += `
                    <div style="padding: 12px; background: var(--accent-red); color: white; border-radius: 8px; margin-bottom: 16px; font-size: 0.9rem;">
                        <strong>‚ö†Ô∏è Storage Warning</strong><br>
                        You're approaching the storage limit (${storageCheck.totalMB} MB / ${storageCheck.limitMB} MB).
                        Consider deleting old episodes or emptying trash after import.
                    </div>
                `;
            }

            summaryHTML += `
                <p style="margin-bottom: 16px;">Found <strong>${analysis.total} episodes</strong> in backup file:</p>
                <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;">
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; display: flex; justify-content: space-between;">
                        <span>‚úÖ New Episodes:</span>
                        <strong style="color: var(--accent-green);">${analysis.new.length}</strong>
                    </div>
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; display: flex; justify-content: space-between;">
                        <span>üìã Exact Duplicates:</span>
                        <strong>${analysis.duplicates.length}</strong>
                    </div>
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; display: flex; justify-content: space-between;">
                        <span>‚ö†Ô∏è Conflicts:</span>
                        <strong style="color: var(--accent-red);">${analysis.conflicts.length}</strong>
                    </div>
                </div>
            `;

            if (analysis.conflicts.length > 0) {
                summaryHTML += `
                    <p style="color: var(--accent-red); margin-bottom: 12px;">
                        <strong>‚ö†Ô∏è Conflicts Detected</strong><br>
                        Some episodes have the same ID or similar timing but different data.
                    </p>
                `;
            }

            if (analysis.new.length === 0 && analysis.conflicts.length === 0) {
                summaryHTML += `<p style="color: var(--text-secondary);">All episodes already exist. Nothing new to import.</p>`;
            }

            body.innerHTML = summaryHTML;

            // Action buttons
            const actions = document.getElementById('modal-actions');

            if (analysis.new.length === 0 && analysis.conflicts.length === 0) {
                actions.innerHTML = `
                    <button class="btn btn-primary" onclick="closeModal()">Close</button>
                `;
            } else if (analysis.conflicts.length > 0) {
                actions.innerHTML = `
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-secondary" onclick="reviewConflicts(${JSON.stringify(analysis).replace(/"/g, '&quot;')})">Review Conflicts</button>
                    <button class="btn btn-primary" onclick="importWithStrategy(${JSON.stringify(analysis).replace(/"/g, '&quot;')}, 'skipConflicts')">Import New Only</button>
                `;
            } else {
                actions.innerHTML = `
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmImport(${JSON.stringify(analysis.new).replace(/"/g, '&quot;')})">Import ${analysis.new.length} Episodes</button>
                `;
            }

            document.getElementById('modal-title').textContent = 'Import Review';
            modal.classList.add('active');
        }

        function reviewConflicts(analysis) {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            let conflictsHTML = `
                <p style="margin-bottom: 16px;">Review ${analysis.conflicts.length} conflicting episodes:</p>
                <div style="max-height: 400px; overflow-y: auto;">
            `;

            analysis.conflicts.forEach((conflict, index) => {
                const imported = conflict.imported;
                const existing = conflict.existing;
                const matchLabel = conflict.matchType === 'id' ? 'Same ID' : 'Similar Time';

                conflictsHTML += `
                    <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--accent-red);">
                        <div style="margin-bottom: 8px; font-weight: 600; color: var(--accent-red);">
                            Conflict #${index + 1} (${matchLabel})
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.9rem;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px; color: var(--accent-green);">üì• Importing:</div>
                                <div>Date: ${formatDate(new Date(imported.startTime))}</div>
                                <div>Time: ${formatTime(new Date(imported.startTime))}</div>
                                <div>Pain: ${imported.painLevel}/10</div>
                                <div>Duration: ${formatDuration(imported.duration || 0)}</div>
                                ${imported.medication ? `<div>Med: ${imported.medication}</div>` : ''}
                            </div>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px; color: var(--accent-blue);">üíæ Existing:</div>
                                <div>Date: ${formatDate(new Date(existing.startTime))}</div>
                                <div>Time: ${formatTime(new Date(existing.startTime))}</div>
                                <div>Pain: ${existing.painLevel}/10</div>
                                <div>Duration: ${formatDuration(existing.duration || 0)}</div>
                                ${existing.medication ? `<div>Med: ${existing.medication}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            conflictsHTML += `</div>`;

            body.innerHTML = conflictsHTML;

            const actions = document.getElementById('modal-actions');
            actions.innerHTML = `
                <button class="btn btn-secondary" onclick="showImportReviewModal([], ${JSON.stringify(analysis).replace(/"/g, '&quot;')})">Back</button>
                <button class="btn btn-secondary" onclick="importWithStrategy(${JSON.stringify(analysis).replace(/"/g, '&quot;')}, 'skipConflicts')">Skip Conflicts</button>
                <button class="btn btn-primary" onclick="importWithStrategy(${JSON.stringify(analysis).replace(/"/g, '&quot;')}, 'replaceConflicts')">Replace Existing</button>
            `;

            document.getElementById('modal-title').textContent = 'Review Conflicts';
        }

        function importWithStrategy(analysis, strategy) {
            let importedCount = 0;

            // Always import new episodes
            analysis.new.forEach(episode => {
                migraines.push(episode);
                importedCount++;
            });

            // Handle conflicts based on strategy
            if (strategy === 'replaceConflicts') {
                analysis.conflicts.forEach(conflict => {
                    // Remove existing and add new
                    const index = migraines.findIndex(m => m.id === conflict.existing.id);
                    if (index !== -1) {
                        migraines[index] = conflict.imported;
                        importedCount++;
                    }
                });
            }
            // If 'skipConflicts', we just don't import them

            // Sort migraines by startTime
            migraines.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

            saveData();
            renderHistory();
            updateDashboard();
            renderCalendar();
            updateStorageInfo();

            closeModal();

            let message = `Successfully imported ${importedCount} episodes.`;
            if (strategy === 'skipConflicts' && analysis.conflicts.length > 0) {
                message += `\n\nSkipped ${analysis.conflicts.length} conflicting episodes.`;
            }

            showModal('Import Complete', message);
        }

        function confirmImport(newEpisodes) {
            newEpisodes.forEach(episode => {
                migraines.push(episode);
            });

            // Sort migraines by startTime
            migraines.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

            saveData();
            renderHistory();
            updateDashboard();
            renderCalendar();
            updateStorageInfo();

            closeModal();
            showModal('Import Complete', `Successfully imported ${newEpisodes.length} episodes.`);
        }

        // ============================================
        // CSV EXPORT/IMPORT FUNCTIONS
        // ============================================

        function exportCSV() {
            const activeMigraines = getActiveMigraines();

            if (activeMigraines.length === 0) {
                showModal('No Data', 'You have no migraine episodes to export.');
                return;
            }

            // CSV Header with BOM for Excel compatibility
            const BOM = '\uFEFF';
            let csv = BOM + 'Date,Start Time,End Time,Duration (hours),Pain Level,Category,Medication,Notes,Resolution,Status,Pressure (hPa)\n';

            // Sort by date (oldest first) - use slice() to avoid mutating original array
            const sorted = activeMigraines.slice().sort((a, b) =>
                new Date(a.startTime) - new Date(b.startTime)
            );

            // Convert each migraine to CSV row
            sorted.forEach(m => {
                const startDate = new Date(m.startTime);
                const date = startDate.toISOString().split('T')[0];
                const startTime = startDate.toTimeString().slice(0, 5);

                let endTime = '';
                let durationHours = '';
                if (m.endTime && m.duration) {
                    const endDate = new Date(m.endTime);
                    endTime = endDate.toTimeString().slice(0, 5);
                    durationHours = (m.duration / 3600).toFixed(2);
                }

                const medication = (m.medication || '').replace(/"/g, '""'); // Escape quotes
                const notes = (m.notes || '').replace(/"/g, '""');
                const resolution = (m.endNotes || '').replace(/"/g, '""');
                const pressure = m.weather && m.weather.pressure ? m.weather.pressure.toFixed(1) : '';

                // Quote fields that might contain commas
                csv += `${date},${startTime},${endTime},${durationHours},${m.painLevel},${m.category},"${medication}","${notes}","${resolution}",${m.status},${pressure}\n`;
            });

            // Create and download file
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aiding-migraine-export-${formatDateFile(new Date())}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            showModal('Export Complete', `Successfully exported ${activeMigraines.length} episodes to CSV.`);
        }

        function handleCSVImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.name.endsWith('.csv')) {
                showModal('Invalid File Type', 'Please select a CSV file (.csv).');
                e.target.value = '';
                return;
            }

            // Validate file size (max 5MB)
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                showModal('File Too Large', 'The selected CSV file is too large. Maximum size is 5MB.');
                e.target.value = '';
                return;
            }

            const reader = new FileReader();

            reader.onload = (event) => {
                try {
                    const csvText = event.target.result;

                    if (!csvText || csvText.trim().length === 0) {
                        showModal('Empty File', 'The CSV file is empty.');
                        e.target.value = '';
                        return;
                    }

                    // Parse CSV
                    const parsed = parseCSV(csvText);

                    if (!parsed.success) {
                        showModal('Parse Error', parsed.error);
                        e.target.value = '';
                        return;
                    }

                    if (parsed.entries.length === 0) {
                        showModal('No Data', 'No valid migraine entries found in the CSV file.');
                        e.target.value = '';
                        return;
                    }

                    // Show preview modal
                    showCSVImportPreview(parsed.entries);

                } catch (error) {
                    showModal('Import Error', 'Failed to read the CSV file. Please check the file format.');
                    console.error('CSV import error:', error);
                }

                e.target.value = '';
            };

            reader.readAsText(file);
        }

        function parseCSV(csvText) {
            try {
                // Remove BOM if present
                csvText = csvText.replace(/^\uFEFF/, '');

                // Split into lines
                const lines = csvText.split(/\r?\n/).filter(line => line.trim());

                if (lines.length < 2) {
                    return { success: false, error: 'CSV file must have at least a header row and one data row.' };
                }

                // Parse header
                const header = lines[0].split(',').map(h => h.trim().toLowerCase());

                // Find column indices
                const dateIdx = header.findIndex(h => h.includes('date'));
                const timeIdx = header.findIndex(h => h.includes('time') && h.includes('start'));
                const painIdx = header.findIndex(h => h.includes('pain'));

                if (dateIdx === -1 || timeIdx === -1 || painIdx === -1) {
                    return { success: false, error: 'CSV must have Date, Start Time, and Pain Level columns.' };
                }

                // Optional columns
                const endTimeIdx = header.findIndex(h => h.includes('end') && h.includes('time'));
                const medicationIdx = header.findIndex(h => h.includes('medication') || h.includes('med'));
                const notesIdx = header.findIndex(h => h.includes('note'));

                // Parse data rows
                const entries = [];
                const errors = [];

                for (let i = 1; i < lines.length; i++) {
                    try {
                        // Simple CSV parser (handles quoted fields)
                        const row = parseCSVLine(lines[i]);

                        const date = row[dateIdx];
                        const time = row[timeIdx];
                        const painStr = row[painIdx];

                        if (!date || !time || !painStr) {
                            errors.push(`Row ${i + 1}: Missing required fields`);
                            continue;
                        }

                        // Validate pain level
                        const pain = parseInt(painStr);
                        if (isNaN(pain) || pain < 0 || pain > 10) {
                            errors.push(`Row ${i + 1}: Invalid pain level "${painStr}"`);
                            continue;
                        }

                        // Create start time
                        const startDateTime = new Date(`${date}T${time}`);
                        if (isNaN(startDateTime.getTime())) {
                            errors.push(`Row ${i + 1}: Invalid date/time`);
                            continue;
                        }

                        // Don't import future dates
                        if (startDateTime > new Date()) {
                            errors.push(`Row ${i + 1}: Future date not allowed`);
                            continue;
                        }

                        // Create migraine object
                        const migraine = {
                            id: Date.now() * 1000 + Math.floor(Math.random() * 1000) + i, // Unique ID with randomness
                            startTime: startDateTime.toISOString(),
                            painLevel: pain,
                            category: getPainCategory(pain),
                            status: 'completed',
                            medication: medicationIdx !== -1 ? row[medicationIdx] : null,
                            notes: notesIdx !== -1 ? row[notesIdx] : null,
                            importedAt: new Date().toISOString(),
                            importSource: 'csv'
                        };

                        // Add end time if present
                        if (endTimeIdx !== -1 && row[endTimeIdx]) {
                            const endDateTime = new Date(`${date}T${row[endTimeIdx]}`);
                            if (!isNaN(endDateTime.getTime()) && endDateTime > startDateTime) {
                                migraine.endTime = endDateTime.toISOString();
                                migraine.duration = Math.floor((endDateTime - startDateTime) / 1000);
                            }
                        }

                        entries.push(migraine);
                    } catch (rowError) {
                        errors.push(`Row ${i + 1}: ${rowError.message}`);
                    }
                }

                if (entries.length === 0 && errors.length > 0) {
                    return {
                        success: false,
                        error: `No valid entries found. Errors:\n${errors.slice(0, 5).join('\n')}`
                    };
                }

                return { success: true, entries, warnings: errors };

            } catch (error) {
                return { success: false, error: `Parse error: ${error.message}` };
            }
        }

        function parseCSVLine(line) {
            // Simple CSV line parser that handles quoted fields
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        // Escaped quote
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());

            return result;
        }

        function showCSVImportPreview(entries) {
            // Check for duplicates
            const existing = getActiveMigraines();
            const duplicates = entries.filter(newEntry => {
                return existing.some(existing => {
                    const timeDiff = Math.abs(new Date(newEntry.startTime) - new Date(existing.startTime));
                    return timeDiff < 60000 && newEntry.painLevel === existing.painLevel; // Within 1 minute
                });
            });

            const toImport = entries.filter(e => !duplicates.some(d => d.id === e.id));

            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            const preview = entries.slice(0, 5).map(e => {
                const date = new Date(e.startTime);
                return `üìÖ ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})} - Pain: ${e.painLevel}/10`;
            }).join('<br>');

            body.innerHTML = `
                <p style="margin-bottom: 16px;">Found <strong>${entries.length}</strong> entries in CSV file.</p>

                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <p style="font-weight: 600; margin-bottom: 8px;">Preview (first 5):</p>
                    ${preview}
                </div>

                ${duplicates.length > 0 ? `
                <div style="background: rgba(212, 165, 116, 0.1); border-left: 3px solid #d4a574; padding: 12px; border-radius: 4px; margin-bottom: 16px;">
                    <p>‚ö†Ô∏è <strong>${duplicates.length}</strong> duplicate${duplicates.length > 1 ? 's' : ''} detected (will be skipped)</p>
                </div>
                ` : ''}

                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                    Imported entries will be merged with your existing data.
                </p>
            `;

            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="confirm-csv-import">Import ${toImport.length} ${toImport.length === 1 ? 'Entry' : 'Entries'}</button>
            `;

            document.getElementById('modal-title').textContent = 'Import Preview';
            modal.classList.add('active');

            document.getElementById('confirm-csv-import').addEventListener('click', () => {
                importCSVEntries(toImport);
                closeModal();
            });
        }

        function importCSVEntries(entries) {
            // Add entries to migraines array
            entries.forEach(entry => {
                migraines.push(entry);
            });

            // Save and update UI
            saveData();
            updateDashboard();
            renderCalendar();
            renderHistory();
            updateStorageInfo();

            showModal('Import Complete', `Successfully imported ${entries.length} ${entries.length === 1 ? 'episode' : 'episodes'} from CSV.`);
        }

        function showPDFDateRangeModal() {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            body.innerHTML = `
                <p style="margin-bottom: 20px; color: var(--text-secondary);">Select a date range for your doctor report:</p>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="settings-btn" onclick="exportPDF('7days')">
                        <span>üìÖ Last 7 Days</span>
                    </button>
                    <button class="settings-btn" onclick="exportPDF('30days')">
                        <span>üìÖ Last 30 Days</span>
                    </button>
                    <button class="settings-btn" onclick="exportPDF('90days')">
                        <span>üìÖ Last 90 Days</span>
                    </button>
                    <button class="settings-btn" onclick="showCustomDateRange()">
                        <span>üìÖ Custom Range</span>
                    </button>
                </div>
            `;

            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            `;

            document.getElementById('modal-title').textContent = 'Export PDF Report';
            modal.classList.add('active');
        }

        function showCustomDateRange() {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            const today = new Date().toISOString().split('T')[0];
            const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            body.innerHTML = `
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="custom-start-date" value="${monthAgo}" max="${today}"
                           style="width: 100%; padding: 12px; background: var(--bg-tertiary);
                                  border: 1px solid var(--border-color); border-radius: 8px;
                                  color: var(--text-primary); font-size: 1rem;">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="custom-end-date" value="${today}" max="${today}"
                           style="width: 100%; padding: 12px; background: var(--bg-tertiary);
                                  border: 1px solid var(--border-color); border-radius: 8px;
                                  color: var(--text-primary); font-size: 1rem;">
                </div>
            `;

            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="showPDFDateRangeModal()">Back</button>
                <button class="btn btn-primary" onclick="exportCustomPDF()">Generate PDF</button>
            `;

            document.getElementById('modal-title').textContent = 'Custom Date Range';
        }

        function exportCustomPDF() {
            const startDate = document.getElementById('custom-start-date').value;
            const endDate = document.getElementById('custom-end-date').value;

            if (!startDate || !endDate) {
                showModal('Error', 'Please select both start and end dates.');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showModal('Error', 'Start date must be before end date.');
                return;
            }

            exportPDF('custom', startDate, endDate);
        }

        function exportPDF(rangeType, customStart, customEnd) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Calculate date range
            let startDate, endDate;
            const now = new Date();

            if (rangeType === 'custom') {
                startDate = new Date(customStart);
                endDate = new Date(customEnd);
                endDate.setHours(23, 59, 59, 999);
            } else {
                endDate = now;
                const days = rangeType === '7days' ? 7 : rangeType === '30days' ? 30 : 90;
                startDate = new Date(now - days * 24 * 60 * 60 * 1000);
            }

            // Filter episodes in range
            const activeMigraines = getActiveMigraines();
            const episodesInRange = activeMigraines.filter(m => {
                const episodeDate = new Date(m.startTime);
                return episodeDate >= startDate && episodeDate <= endDate;
            });

            // Generate PDF
            let yPos = 20;

            // Title
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('Migraine Report', 105, yPos, { align: 'center' });
            yPos += 10;

            // Date range
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            const dateRangeStr = `${formatDate(startDate)} - ${formatDate(endDate)}`;
            doc.text(dateRangeStr, 105, yPos, { align: 'center' });
            yPos += 15;

            // Patient Information Section (blank for handwriting)
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Patient Information', 20, yPos);
            yPos += 8;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Name: _______________________________________', 20, yPos);
            yPos += 7;
            doc.text('Date of Birth: _______________', 20, yPos);
            doc.text('Visit Date: _______________', 120, yPos);
            yPos += 15;

            // Summary Statistics with Clinical Interpretation
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Clinical Summary', 20, yPos);
            yPos += 10;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');

            const totalEpisodes = episodesInRange.length;

            // Calculate unique migraine days (most important clinical metric, including multi-day attacks)
            const migraineDays = new Set();
            episodesInRange.forEach(m => {
                const days = getMigraineDays(m);
                days.forEach(day => migraineDays.add(day));
            });
            const uniqueMigraineDays = migraineDays.size;

            // Calculate days in range
            const daysInRange = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const monthsInRange = (daysInRange / 30).toFixed(1);

            // Calculate monthly average
            const migraineDaysPerMonth = (uniqueMigraineDays / (daysInRange / 30)).toFixed(1);

            // Determine clinical status
            let clinicalStatus, statusNote;
            if (migraineDaysPerMonth >= 15) {
                clinicalStatus = 'Chronic Migraine';
                statusNote = 'Clinical note: ‚â•15 headache days/month meets criteria for Chronic Migraine';
            } else if (migraineDaysPerMonth >= 10) {
                clinicalStatus = 'High-Frequency Episodic Migraine';
                statusNote = 'Clinical note: >10 days/month indicates elevated risk for chronification';
            } else if (migraineDaysPerMonth >= 4) {
                clinicalStatus = 'Episodic Migraine';
                statusNote = 'Clinical note: <15 days/month indicates episodic pattern';
            } else {
                clinicalStatus = 'Low-Frequency Episodic Migraine';
                statusNote = 'Clinical note: <4 days/month indicates low-frequency pattern';
            }

            // Headache Frequency Section
            doc.setFont(undefined, 'bold');
            doc.text('üìä Headache Frequency', 20, yPos);
            yPos += 6;
            doc.setFont(undefined, 'normal');
            doc.text(`Migraine Days in Period: ${uniqueMigraineDays} days (out of ${daysInRange} days tracked)`, 20, yPos);
            yPos += 5;
            doc.text(`Average per Month: ${migraineDaysPerMonth} days/month`, 20, yPos);
            yPos += 5;
            doc.text(`Total Episodes: ${totalEpisodes}`, 20, yPos);
            yPos += 5;
            doc.setFont(undefined, 'bold');
            doc.text(`Status: ${clinicalStatus}`, 20, yPos);
            yPos += 5;
            doc.setFontSize(9);
            doc.setFont(undefined, 'italic');
            doc.text(statusNote, 20, yPos);
            yPos += 10;

            // Pain Characteristics
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('üìà Pain Characteristics', 20, yPos);
            yPos += 6;
            doc.setFont(undefined, 'normal');

            const avgPain = totalEpisodes > 0
                ? (episodesInRange.reduce((sum, m) => sum + m.painLevel, 0) / totalEpisodes).toFixed(1)
                : 0;
            const painInterpretation = avgPain >= 7 ? 'Severe' : avgPain >= 4 ? 'Moderate' : 'Mild';

            doc.text(`Average Pain Level: ${avgPain}/10 (${painInterpretation})`, 20, yPos);
            yPos += 5;

            const severeCount = episodesInRange.filter(m => m.painLevel >= 7).length;
            const moderateCount = episodesInRange.filter(m => m.painLevel >= 4 && m.painLevel < 7).length;
            const mildCount = episodesInRange.filter(m => m.painLevel < 4).length;

            doc.text(`Pain Distribution: Severe (${severeCount}), Moderate (${moderateCount}), Mild (${mildCount})`, 20, yPos);
            yPos += 10;

            // Duration Analysis
            doc.setFont(undefined, 'bold');
            doc.text('‚è±Ô∏è Duration Analysis', 20, yPos);
            yPos += 6;
            doc.setFont(undefined, 'normal');

            const avgDuration = totalEpisodes > 0
                ? episodesInRange.reduce((sum, m) => sum + (m.duration || 0), 0) / totalEpisodes
                : 0;

            const durations = episodesInRange.map(m => m.duration || 0).filter(d => d > 0);
            const minDuration = durations.length > 0 ? Math.min(...durations) : 0;
            const maxDuration = durations.length > 0 ? Math.max(...durations) : 0;

            doc.text(`Average Duration: ${formatDuration(Math.floor(avgDuration))}`, 20, yPos);
            yPos += 5;
            doc.text(`Range: ${formatDuration(minDuration)} - ${formatDuration(maxDuration)}`, 20, yPos);
            yPos += 15;

            // Weather Correlation (if enabled)
            if (weatherData.enabled && weatherData.history.length >= 7) {
                const correlation = calculateWeatherCorrelation();

                if (correlation) {
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('‚òÅÔ∏è Weather Sensitivity Analysis', 20, yPos);
                    yPos += 6;
                    doc.setFont(undefined, 'normal');

                    const strengthText = correlation.level === 'strong' ? 'Strong Correlation' :
                                       correlation.level === 'moderate' ? 'Moderate Correlation' :
                                       'Weak Correlation';

                    doc.text(`Barometric Pressure Correlation: ${correlation.percentage.toFixed(0)}% (${strengthText})`, 20, yPos);
                    yPos += 5;
                    doc.text(`Significant Pressure Changes: ${correlation.significantChangeDays} days (>5 hPa in 24h)`, 20, yPos);
                    yPos += 5;
                    doc.text(`Migraines on Change Days: ${correlation.migrainesOnChangeDays} days`, 20, yPos);
                    yPos += 5;

                    doc.setFontSize(9);
                    doc.setFont(undefined, 'italic');
                    let clinicalNote = '';
                    if (correlation.level === 'strong') {
                        clinicalNote = 'Clinical note: Strong weather sensitivity detected. Consider preventive measures before significant pressure changes.';
                    } else if (correlation.level === 'moderate') {
                        clinicalNote = 'Clinical note: Moderate weather sensitivity. May benefit from monitoring pressure changes.';
                    } else {
                        clinicalNote = 'Clinical note: Low weather correlation. Other triggers may be more significant.';
                    }
                    doc.text(clinicalNote, 20, yPos);
                    yPos += 10;
                }
            }

            // Episode Details
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Episode Details', 20, yPos);
            yPos += 8;

            if (totalEpisodes === 0) {
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('No episodes recorded in this date range.', 20, yPos);
            } else {
                // Table header
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text('Date', 20, yPos);
                doc.text('Time', 50, yPos);
                doc.text('Pain', 75, yPos);
                doc.text('Duration', 95, yPos);
                doc.text('Medication', 125, yPos);
                yPos += 5;

                // Line under header
                doc.line(20, yPos, 190, yPos);
                yPos += 5;

                // Episode rows
                doc.setFont(undefined, 'normal');
                const sortedEpisodes = [...episodesInRange].sort((a, b) =>
                    new Date(b.startTime) - new Date(a.startTime)
                );

                for (const episode of sortedEpisodes) {
                    // Check if we need a new page
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }

                    const epStart = new Date(episode.startTime);
                    const painStr = episode.painHistory && episode.painHistory.length > 1
                        ? `${episode.painHistory[0].level}‚Üí${episode.painLevel}`
                        : `${episode.painLevel}/10`;

                    doc.text(formatDate(epStart), 20, yPos);
                    doc.text(formatTime(epStart), 50, yPos);
                    doc.text(painStr, 75, yPos);
                    doc.text(formatDuration(episode.duration || 0), 95, yPos);

                    const medText = episode.medication || 'None';
                    const maxMedWidth = 65;
                    if (doc.getTextWidth(medText) > maxMedWidth) {
                        doc.text(medText.substring(0, 25) + '...', 125, yPos);
                    } else {
                        doc.text(medText, 125, yPos);
                    }

                    yPos += 5;

                    // Add notes if present
                    if (episode.notes) {
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'italic');
                        const noteLines = doc.splitTextToSize(`Notes: ${episode.notes}`, 170);
                        doc.text(noteLines, 25, yPos);
                        yPos += noteLines.length * 4;
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                    }

                    yPos += 2;
                }
            }

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setFont(undefined, 'italic');
                doc.text(`Generated by Aiding Migraine on ${formatDate(new Date())}`, 105, 285, { align: 'center' });
                doc.text(`Page ${i} of ${pageCount}`, 190, 285, { align: 'right' });
            }

            // Save PDF
            const startDateStr = formatDateFile(startDate);
            const endDateStr = formatDateFile(endDate);
            const filename = `migraine-report-${startDateStr}-to-${endDateStr}.pdf`;
            doc.save(filename);

            closeModal();
            showModal('PDF Exported', `Your migraine report has been saved as ${filename}`);
        }

        function showHowTo() {
            const content = `
                <h3>Logging Episodes</h3>
                <p>1. Select your pain level (0-10)</p>
                <p>2. Optionally add medication and notes</p>
                <p>3. Tap "Log Episode"</p>
                
                <h3>Active Episodes</h3>
                <p>‚Ä¢ Update pain as it changes</p>
                <p>‚Ä¢ End episode when resolved</p>
                <p>‚Ä¢ Duration tracked automatically</p>
                
                <h3>Viewing History</h3>
                <p>‚Ä¢ All episodes listed in History tab</p>
                <p>‚Ä¢ Calendar shows severity by color</p>
                <p>‚Ä¢ Stats dashboard shows trends</p>
                
                <h3>Backing Up Data</h3>
                <p>‚Ä¢ Export regularly from Settings</p>
                <p>‚Ä¢ Keep backup file safe</p>
                <p>‚Ä¢ Import on new device</p>
            `;
            showModal('How to Use', content);
        }

        function showAbout() {
            const content = `
                <p><strong>Aiding Migraine v1.6.0</strong></p>
                <p>Built with care for migraine sufferers.</p>
                
                <h3>Features</h3>
                <ul>
                    <li>Easy pain tracking</li>
                    <li>Duration monitoring</li>
                    <li>Pattern visualization</li>
                    <li>Privacy-focused</li>
                    <li>Export & backup</li>
                </ul>
                
                <p style="margin-top: 20px; color: var(--text-secondary);">
                    Created by someone who understands the struggle of managing migraines.
                </p>
            `;
            showModal('About This App', content);
        }

        function showPrivacy() {
            const content = `
                <h3>Your Privacy Matters</h3>
                
                <p><strong>‚úì All data stored locally</strong><br>
                Your information never leaves your device.</p>
                
                <p><strong>‚úì No cloud uploads</strong><br>
                No servers, no tracking, no analytics.</p>
                
                <p><strong>‚úì No account required</strong><br>
                Start using immediately, privately.</p>
                
                <p><strong>‚úì You own your data</strong><br>
                Export anytime, delete anytime.</p>
                
                <h3>Data Storage</h3>
                <p>Your migraine data is stored only on this device using browser storage.</p>
                
                <h3>Backup Recommendation</h3>
                <p>Export your data regularly to prevent loss if you clear browser data.</p>
                
                <p style="margin-top: 20px; color: var(--text-secondary); font-size: 0.9rem;">
                    <strong>Note:</strong> This app is not HIPAA compliant and should not be used for official medical records. Always consult healthcare providers.
                </p>
            `;
            showModal('Privacy & Your Data', content);
        }

        function clearAllData() {
            const modal = document.getElementById('modal');
            document.getElementById('modal-title').textContent = '‚ö†Ô∏è Delete All Data?';
            document.getElementById('modal-body').innerHTML = `
                <p><strong>This will permanently delete ALL ${migraines.length} episodes and cannot be undone.</strong></p>
                <p style="margin-top: 12px;">We recommend exporting a backup first.</p>
            `;
            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-secondary" onclick="exportJSON(); closeModal();">Export First</button>
                <button class="btn btn-primary" style="background: var(--accent-red);" onclick="confirmClearAll()">Delete All</button>
            `;
            modal.classList.add('active');
        }

        function confirmClearAll() {
            migraines = [];
            activeMigraine = null;
            localStorage.clear();
            
            saveData();
            renderHistory();
            updateDashboard();
            renderCalendar();
            updateStorageInfo();
            checkActiveMigraine();
            
            closeModal();
            showModal('Data Cleared', 'All data has been deleted.');
        }

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal-actions').innerHTML = '<button class="btn btn-primary" onclick="closeModal()">Close</button>';
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function showWelcomeModal() {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            const actions = document.getElementById('modal-actions');

            body.innerHTML = `
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">ü§ï</div>
                    <h2 style="margin-bottom: 16px; font-size: 1.5rem;">Welcome to Aiding Migraine</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 20px; line-height: 1.8;">
                        Your personal migraine tracking companion. Log episodes, track patterns,
                        and generate professional reports for your healthcare provider.
                    </p>
                    <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 20px; margin: 24px 0; text-align: left;">
                        <h3 style="font-size: 1.1rem; margin-bottom: 12px; text-align: center;">‚ú® Key Features</h3>
                        <ul style="list-style: none; padding: 0; color: var(--text-secondary); line-height: 2;">
                            <li>üìù <strong>Easy Logging:</strong> Track pain levels, duration, and medications</li>
                            <li>üìä <strong>Visual History:</strong> Calendar view and detailed statistics</li>
                            <li>üìÑ <strong>PDF Reports:</strong> Professional reports for doctor visits</li>
                            <li>üíæ <strong>Secure Backup:</strong> Import/export your data safely</li>
                            <li>üóëÔ∏è <strong>Smart Recovery:</strong> 30-day trash for deleted episodes</li>
                        </ul>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 16px;">
                        All your data stays private on your device. Nothing is sent to any server.
                    </p>
                </div>
            `;

            actions.innerHTML = `
                <button class="btn btn-secondary" onclick="closeWelcome()">Get Started</button>
                <button class="btn btn-primary" onclick="startGuidedTour()">Take a Tour</button>
            `;

            document.getElementById('modal-title').textContent = '';
            modal.classList.add('active');
        }

        function closeWelcome() {
            localStorage.setItem('hasSeenWelcome', 'true');
            closeModal();
        }

        function checkFirstTimeUser() {
            const hasSeenWelcome = localStorage.getItem('hasSeenWelcome');
            if (!hasSeenWelcome) {
                // Small delay to let the page load first
                setTimeout(() => {
                    showWelcomeModal();
                }, 500);
            }
        }

        let tourStep = 0;
        const tourSteps = [
            {
                title: 'Log a Migraine Episode',
                description: 'Select your pain level (1-10) and click "Start Episode" to begin tracking. You can update pain levels and add notes during the episode.',
                target: '.pain-scale',
                page: 'log',
                position: 'bottom'
            },
            {
                title: 'Episode History',
                description: 'View all your past episodes here. You can edit notes, view details, or delete episodes. Deleted episodes go to trash for 30 days.',
                target: '#history-list',
                page: 'history',
                position: 'top'
            },
            {
                title: 'Calendar View',
                description: 'The Dashboard shows your migraine patterns over time. Click any day to see episodes logged that day.',
                target: '#calendar-grid',
                page: 'log',
                position: 'top'
            },
            {
                title: 'Export & Backup',
                description: 'Export your data as PDF for doctor visits or JSON for backups. You can also import data to restore or merge from another device.',
                target: '#data-management-section',
                page: 'settings',
                position: 'top'
            },
            {
                title: 'Your Data is Private',
                description: 'Everything is stored locally on your device. No data is sent to any server. Remember to export backups regularly!',
                target: '#privacy-btn',
                page: 'settings',
                position: 'center'
            }
        ];

        function startGuidedTour() {
            localStorage.setItem('hasSeenWelcome', 'true');
            closeModal();
            tourStep = 0;
            // Add a delay to ensure modal is fully closed
            setTimeout(() => {
                showTourStep();
            }, 300);
        }

        function showTourStep() {
            const step = tourSteps[tourStep];

            // Switch to the required page
            if (step.page !== currentPage) {
                showPage(step.page);
            }

            // Wait for page to render before showing tooltip
            setTimeout(() => {
                // Remove any existing tour elements
                const oldOverlay = document.getElementById('tour-overlay');
                const oldTooltip = document.getElementById('tour-tooltip');
                if (oldOverlay) oldOverlay.remove();
                if (oldTooltip) oldTooltip.remove();

                // Create overlay
                const overlay = document.createElement('div');
                overlay.id = 'tour-overlay';
                overlay.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100% !important;
                    height: 100% !important;
                    background: rgba(0, 0, 0, 0.75) !important;
                    z-index: 9998 !important;
                    display: block !important;
                `;
                document.body.appendChild(overlay);

                // Create tooltip
                const tooltip = document.createElement('div');
                tooltip.id = 'tour-tooltip';
                tooltip.style.cssText = `
                    position: fixed !important;
                    top: 50% !important;
                    left: 50% !important;
                    transform: translate(-50%, -50%) !important;
                    background: var(--bg-secondary) !important;
                    border: 2px solid var(--accent-blue) !important;
                    border-radius: 12px !important;
                    padding: 24px !important;
                    max-width: 400px !important;
                    width: 90% !important;
                    z-index: 9999 !important;
                    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4) !important;
                    display: block !important;
                    visibility: visible !important;
                `;

                tooltip.innerHTML = `
                    <div style="margin-bottom: 8px; color: var(--accent-blue); font-size: 0.9rem; font-weight: 600;">
                        Step ${tourStep + 1} of ${tourSteps.length}
                    </div>
                    <h3 style="margin-bottom: 12px; font-size: 1.3rem;">${step.title}</h3>
                    <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px;">
                        ${step.description}
                    </p>
                    <div style="display: flex; gap: 12px; justify-content: space-between;">
                        <button class="btn btn-secondary" onclick="skipTour()" style="flex: 1;">
                            Skip Tour
                        </button>
                        <button class="btn btn-primary" onclick="nextTourStep()" style="flex: 1;">
                            ${tourStep === tourSteps.length - 1 ? 'Finish' : 'Next'}
                        </button>
                    </div>
                `;

                document.body.appendChild(tooltip);

                // Highlight the target element if it exists
                if (step.target) {
                    const targetEl = document.querySelector(step.target);
                    if (targetEl) {
                        targetEl.style.position = 'relative';
                        targetEl.style.zIndex = '9999';
                        targetEl.style.boxShadow = '0 0 0 4px var(--accent-blue), 0 0 20px rgba(107, 139, 184, 0.5)';
                        targetEl.style.borderRadius = '8px';
                        targetEl.setAttribute('data-tour-highlight', 'true');
                    }
                }
            }, 300);
        }

        function nextTourStep() {
            // Remove highlight from previous step
            const highlighted = document.querySelector('[data-tour-highlight]');
            if (highlighted) {
                highlighted.style.position = '';
                highlighted.style.zIndex = '';
                highlighted.style.boxShadow = '';
                highlighted.style.borderRadius = '';
                highlighted.removeAttribute('data-tour-highlight');
            }

            tourStep++;
            if (tourStep < tourSteps.length) {
                showTourStep();
            } else {
                endTour();
            }
        }

        function skipTour() {
            endTour();
        }

        function endTour() {
            // Remove highlight
            const highlighted = document.querySelector('[data-tour-highlight]');
            if (highlighted) {
                highlighted.style.position = '';
                highlighted.style.zIndex = '';
                highlighted.style.boxShadow = '';
                highlighted.style.borderRadius = '';
                highlighted.removeAttribute('data-tour-highlight');
            }

            // Remove overlay and tooltip
            const overlay = document.getElementById('tour-overlay');
            const tooltip = document.getElementById('tour-tooltip');
            if (overlay) overlay.remove();
            if (tooltip) tooltip.remove();

            tourStep = 0;
        }

        document.querySelector('.modal-close').addEventListener('click', closeModal);

        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') {
                closeModal();
            }
        });

        function getPainCategory(level) {
            if (level <= 3) return 'Mild';
            if (level <= 6) return 'Moderate';
            return 'Severe';
        }

        function getPainProgression(migraine) {
            if (!migraine.painHistory || migraine.painHistory.length <= 1) {
                return `${migraine.painLevel}/10`;
            }
            
            const first = migraine.painHistory[0].level;
            const last = migraine.painHistory[migraine.painHistory.length - 1].level;
            
            if (last < first) {
                return `${first} ‚Üí ${last} ‚Üì Improving`;
            } else if (last > first) {
                return `${first} ‚Üí ${last} ‚Üë Worsening`;
            } else {
                return `${first} ‚Üí Stable`;
            }
        }

        function formatDuration(seconds) {
            if (!seconds) return '0m';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
        }

        function formatDateFile(date) {
            return date.toISOString().split('T')[0];
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }

        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;

            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return formatDate(date);
        }

        // ============================================
        // NOTIFICATION SYSTEM
        // ============================================

        let notificationPreferences = {
            enabled: false,
            dailyCheckIn: {
                enabled: true,
                time: '19:00',
                frequency: 'daily'
            },
            activeAttackCheckIn: {
                enabled: true,
                delayHours: 2
            },
            postAttackFollowUp: {
                enabled: true,
                delayHours: 2
            },
            pushSubscription: null
        };

        function initializeNotifications() {
            loadNotificationPreferences();
            updateNotificationUI();

            // Event listeners
            document.getElementById('enable-notifications-btn').addEventListener('click', enableNotifications);
            document.getElementById('disable-notifications-btn').addEventListener('click', disableNotifications);
            document.getElementById('test-notification-btn').addEventListener('click', sendTestNotification);

            // Preference change listeners
            document.getElementById('daily-checkin-enabled').addEventListener('change', saveNotificationPreferences);
            document.getElementById('daily-checkin-time').addEventListener('change', saveNotificationPreferences);
            document.getElementById('daily-checkin-frequency').addEventListener('change', saveNotificationPreferences);
            document.getElementById('active-checkin-enabled').addEventListener('change', saveNotificationPreferences);
            document.getElementById('active-checkin-delay').addEventListener('change', saveNotificationPreferences);
            document.getElementById('followup-enabled').addEventListener('change', saveNotificationPreferences);
            document.getElementById('followup-delay').addEventListener('change', saveNotificationPreferences);

            // Handle deep links from notification clicks
            handleNotificationDeepLink();
        }

        function loadNotificationPreferences() {
            const stored = localStorage.getItem('notificationPreferences');
            if (stored) {
                notificationPreferences = JSON.parse(stored);

                // Migrate old preferences (add activeAttackCheckIn if missing)
                if (!notificationPreferences.activeAttackCheckIn) {
                    notificationPreferences.activeAttackCheckIn = {
                        enabled: true,
                        delayHours: 2
                    };
                    localStorage.setItem('notificationPreferences', JSON.stringify(notificationPreferences));
                }

                // Update UI with stored values
                document.getElementById('daily-checkin-enabled').checked = notificationPreferences.dailyCheckIn.enabled;
                document.getElementById('daily-checkin-time').value = notificationPreferences.dailyCheckIn.time;
                document.getElementById('daily-checkin-frequency').value = notificationPreferences.dailyCheckIn.frequency;
                document.getElementById('active-checkin-enabled').checked = notificationPreferences.activeAttackCheckIn.enabled;
                document.getElementById('active-checkin-delay').value = notificationPreferences.activeAttackCheckIn.delayHours;
                document.getElementById('followup-enabled').checked = notificationPreferences.postAttackFollowUp.enabled;
                document.getElementById('followup-delay').value = notificationPreferences.postAttackFollowUp.delayHours;
            }
        }

        function saveNotificationPreferences() {
            notificationPreferences.dailyCheckIn.enabled = document.getElementById('daily-checkin-enabled').checked;
            notificationPreferences.dailyCheckIn.time = document.getElementById('daily-checkin-time').value;
            notificationPreferences.dailyCheckIn.frequency = document.getElementById('daily-checkin-frequency').value;
            notificationPreferences.activeAttackCheckIn.enabled = document.getElementById('active-checkin-enabled').checked;
            notificationPreferences.activeAttackCheckIn.delayHours = parseInt(document.getElementById('active-checkin-delay').value);
            notificationPreferences.postAttackFollowUp.enabled = document.getElementById('followup-enabled').checked;
            notificationPreferences.postAttackFollowUp.delayHours = parseInt(document.getElementById('followup-delay').value);

            // Convert local time to UTC for server synchronization
            const localTime = notificationPreferences.dailyCheckIn.time;
            const utcData = convertLocalTimeToUTC(localTime);

            // Store UTC time data for server sync
            notificationPreferences.dailyCheckIn.utcHour = utcData.utcHour;
            notificationPreferences.dailyCheckIn.utcMinutes = utcData.utcMinutes;
            notificationPreferences.dailyCheckIn.utcTime = utcData.utcTime;
            notificationPreferences.dailyCheckIn.timezone = utcData.timezone;

            console.log(`Daily check-in set for ${localTime} local (${utcData.utcTime} UTC) in timezone ${utcData.timezone}`);

            localStorage.setItem('notificationPreferences', JSON.stringify(notificationPreferences));

            // Sync with server if notifications are enabled
            if (notificationPreferences.enabled && notificationPreferences.pushSubscription) {
                syncPreferencesWithServer();
            }
        }

        async function updateNotificationUI() {
            const statusText = document.getElementById('notification-status-text');
            const enableSection = document.getElementById('notification-enable-section');
            const preferencesSection = document.getElementById('notification-preferences');
            const iosPrompt = document.getElementById('ios-install-prompt');

            // Check if notifications are supported
            if (!('Notification' in window)) {
                statusText.innerHTML = '‚ùå Notifications not supported on this browser';
                statusText.parentElement.style.background = 'var(--accent-red)';
                statusText.parentElement.style.color = 'white';
                return;
            }

            // Check iOS installation status
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isInstalled = window.matchMedia('(display-mode: standalone)').matches;

            if (isIOS && !isInstalled) {
                statusText.innerHTML = 'üì± Please install app to home screen';
                statusText.parentElement.style.background = 'var(--accent-blue)';
                statusText.parentElement.style.color = 'white';
                iosPrompt.style.display = 'block';
                return;
            } else {
                iosPrompt.style.display = 'none';
            }

            // Check permission status
            const permission = Notification.permission;

            if (permission === 'granted') {
                // Check if we have a valid subscription
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.getSubscription();

                if (subscription && notificationPreferences.enabled) {
                    statusText.innerHTML = '‚úÖ Notifications enabled';
                    statusText.parentElement.style.background = 'var(--accent-green)';
                    statusText.parentElement.style.color = 'white';
                    enableSection.style.display = 'none';
                    preferencesSection.style.display = 'block';
                } else {
                    statusText.innerHTML = 'üîî Permission granted - Click to enable';
                    statusText.parentElement.style.background = 'var(--bg-tertiary)';
                    enableSection.style.display = 'block';
                    preferencesSection.style.display = 'none';
                }
            } else if (permission === 'denied') {
                statusText.innerHTML = '‚ùå Notifications blocked - Check browser settings';
                statusText.parentElement.style.background = 'var(--accent-red)';
                statusText.parentElement.style.color = 'white';
                enableSection.style.display = 'none';
                preferencesSection.style.display = 'none';
            } else {
                statusText.innerHTML = 'üîî Click below to enable notifications';
                statusText.parentElement.style.background = 'var(--bg-tertiary)';
                enableSection.style.display = 'block';
                preferencesSection.style.display = 'none';
            }
        }

        async function enableNotifications() {
            try {
                // Request permission
                const permission = await Notification.requestPermission();

                if (permission !== 'granted') {
                    alert('Notification permission denied. Please enable it in your browser settings.');
                    updateNotificationUI();
                    return;
                }

                // Get service worker registration
                const registration = await navigator.serviceWorker.ready;

                // VAPID Public Key for push notifications
                const VAPID_PUBLIC_KEY = 'BJ9vywBjnCoHDMUQoxyX9ciyARzXRPJeiBBdaoEMRB98HH9X1X4QRuus1FhP9VK4g91c382KclMId8MEeGwakHo';

                // Check if VAPID key is configured
                if (VAPID_PUBLIC_KEY === 'YOUR_VAPID_PUBLIC_KEY_HERE') {
                    // Server not configured yet - use local notifications only
                    notificationPreferences.enabled = true;
                    localStorage.setItem('notificationPreferences', JSON.stringify(notificationPreferences));
                    alert('‚úÖ Notifications enabled (local only)!\n\nTo enable server push notifications, configure Firebase and VAPID keys.\nSee NOTIFICATIONS_SETUP.md for details.');
                    updateNotificationUI();
                    return;
                }

                // Subscribe to push notifications with VAPID key
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });

                // Convert local time to UTC for server synchronization
                const localTime = notificationPreferences.dailyCheckIn.time;
                const utcData = convertLocalTimeToUTC(localTime);

                // Store UTC time data
                notificationPreferences.dailyCheckIn.utcHour = utcData.utcHour;
                notificationPreferences.dailyCheckIn.utcMinutes = utcData.utcMinutes;
                notificationPreferences.dailyCheckIn.utcTime = utcData.utcTime;
                notificationPreferences.dailyCheckIn.timezone = utcData.timezone;

                console.log(`Daily check-in set for ${localTime} local (${utcData.utcTime} UTC) in timezone ${utcData.timezone}`);

                // Send subscription to server
                const SERVER_URL = 'https://aiding-migraine-notifications.onrender.com';
                const response = await fetch(`${SERVER_URL}/api/subscriptions/subscribe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subscription: subscription,
                        preferences: {
                            dailyCheckIn: {
                                ...notificationPreferences.dailyCheckIn,
                                time: localTime,  // Keep local time for reference
                                utcHour: utcData.utcHour,
                                utcMinutes: utcData.utcMinutes,
                                utcTime: utcData.utcTime,
                                timezone: utcData.timezone
                            },
                            postAttackFollowUp: notificationPreferences.postAttackFollowUp
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to subscribe on server');
                }

                // Save subscription locally
                notificationPreferences.enabled = true;
                notificationPreferences.pushSubscription = subscription.toJSON();
                localStorage.setItem('notificationPreferences', JSON.stringify(notificationPreferences));

                alert('‚úÖ Notifications enabled! You will receive daily check-ins and post-attack follow-ups.');
                updateNotificationUI();

            } catch (error) {
                console.error('Error enabling notifications:', error);
                alert('Failed to enable notifications. ' + error.message);
            }
        }

        // Helper function to convert VAPID key from Base64 to Uint8Array
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // Get user's timezone
        function getUserTimezone() {
            try {
                return Intl.DateTimeFormat().resolvedOptions().timeZone;
            } catch (e) {
                console.error('Error getting timezone:', e);
                return 'UTC';
            }
        }

        // Convert local time (HH:MM) to UTC hour
        function convertLocalTimeToUTC(localTime) {
            // localTime format: "HH:MM" (e.g., "15:00")
            const [hours, minutes] = localTime.split(':').map(Number);

            // Create a date object for today at the specified local time
            const now = new Date();
            const localDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0);

            // Get UTC hour
            const utcHour = localDate.getUTCHours();
            const utcMinutes = localDate.getUTCMinutes();

            return {
                utcHour: utcHour,
                utcMinutes: utcMinutes,
                utcTime: `${String(utcHour).padStart(2, '0')}:${String(utcMinutes).padStart(2, '0')}`,
                timezone: getUserTimezone(),
                timezoneOffset: -localDate.getTimezoneOffset() // offset in minutes
            };
        }

        async function disableNotifications() {
            if (!confirm('Are you sure you want to disable all notifications?')) {
                return;
            }

            try {
                // Unsubscribe from push notifications if subscribed
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.getSubscription();

                if (subscription) {
                    await subscription.unsubscribe();
                }

                notificationPreferences.enabled = false;
                notificationPreferences.pushSubscription = null;
                localStorage.setItem('notificationPreferences', JSON.stringify(notificationPreferences));

                alert('Notifications disabled successfully.');
                updateNotificationUI();

            } catch (error) {
                console.error('Error disabling notifications:', error);
                alert('Failed to disable notifications. Please try again.');
            }
        }

        async function sendTestNotification() {
            if (Notification.permission !== 'granted') {
                alert('Please enable notifications first.');
                return;
            }

            try {
                // Send a local notification for testing
                const registration = await navigator.serviceWorker.ready;

                registration.showNotification('Aiding Migraine', {
                    body: 'Test notification - Your notification system is working! üéâ',
                    icon: './icons/icon-192x192.png',
                    badge: './icons/icon-72x72.png',
                    tag: 'test-notification',
                    requireInteraction: false,
                    vibrate: [200, 100, 200]
                });

            } catch (error) {
                console.error('Error sending test notification:', error);
                alert('Failed to send test notification.');
            }
        }

        function handleNotificationDeepLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            const attackId = urlParams.get('attackId');

            if (action === 'log') {
                showPage('log');
            } else if (action === 'update' && attackId) {
                // Find and show the attack for updating
                const attack = migraines.find(m => m.id === attackId);
                if (attack) {
                    showPage('history');
                    setTimeout(() => {
                        showMigraineSummary(attack);
                    }, 500);
                }
            }

            // Clean up URL
            if (action) {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        async function syncPreferencesWithServer() {
            // Sync preferences with the notification server
            if (!notificationPreferences.pushSubscription) {
                console.log('No push subscription - server sync skipped');
                return;
            }

            try {
                const SERVER_URL = 'https://aiding-migraine-notifications.onrender.com';
                const response = await fetch(`${SERVER_URL}/api/subscriptions/update-preferences`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        endpoint: notificationPreferences.pushSubscription.endpoint,
                        preferences: {
                            dailyCheckIn: notificationPreferences.dailyCheckIn,
                            postAttackFollowUp: notificationPreferences.postAttackFollowUp
                        }
                    })
                });

                if (response.ok) {
                    console.log('‚úÖ Preferences synced with server');
                } else {
                    console.error('Failed to sync preferences with server');
                }
            } catch (error) {
                console.error('Error syncing preferences:', error);
            }
        }

        // Schedule post-attack follow-up notification
        async function schedulePostAttackFollowUp(attackId) {
            if (!notificationPreferences.enabled || !notificationPreferences.postAttackFollowUp.enabled) {
                return;
            }

            const delayMs = notificationPreferences.postAttackFollowUp.delayHours * 60 * 60 * 1000;
            const followUpTime = new Date(Date.now() + delayMs);

            // Store scheduled notification locally
            const scheduledNotifications = JSON.parse(localStorage.getItem('scheduledNotifications') || '[]');
            scheduledNotifications.push({
                id: `followup-${attackId}`,
                attackId: attackId,
                scheduledTime: followUpTime.toISOString(),
                type: 'post-attack-followup'
            });
            localStorage.setItem('scheduledNotifications', JSON.stringify(scheduledNotifications));

            console.log(`üìÖ Scheduled follow-up notification for ${followUpTime.toLocaleString()}`);

            // Send to server if push subscription exists
            if (notificationPreferences.pushSubscription) {
                try {
                    const SERVER_URL = 'https://aiding-migraine-notifications.onrender.com';
                    const response = await fetch(`${SERVER_URL}/api/notifications/schedule-followup`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            attackId: attackId,
                            followUpTime: followUpTime.toISOString(),
                            subscriptionEndpoint: notificationPreferences.pushSubscription.endpoint
                        })
                    });

                    if (response.ok) {
                        console.log('‚úÖ Follow-up scheduled on server');
                    } else {
                        console.error('Failed to schedule follow-up on server');
                    }
                } catch (error) {
                    console.error('Error scheduling follow-up:', error);
                }
            }
        }

        async function scheduleActiveAttackCheckIn(attackId) {
            if (!notificationPreferences.enabled || !notificationPreferences.activeAttackCheckIn.enabled) {
                return;
            }

            const delayHours = notificationPreferences.activeAttackCheckIn.delayHours;

            // Schedule multiple recurring check-ins (up to 24 hours worth)
            const maxCheckIns = Math.floor(24 / delayHours); // e.g., if delayHours=2, schedule 12 check-ins
            const scheduledNotifications = JSON.parse(localStorage.getItem('scheduledNotifications') || '[]');

            for (let i = 1; i <= maxCheckIns; i++) {
                const delayMs = delayHours * i * 60 * 60 * 1000;
                const checkInTime = new Date(Date.now() + delayMs);

                // Store scheduled notification locally with unique ID including sequence number
                scheduledNotifications.push({
                    id: `active-checkin-${attackId}-${i}`,
                    attackId: attackId,
                    scheduledTime: checkInTime.toISOString(),
                    type: 'active-attack-checkin',
                    sequence: i
                });

                // Send to server if push subscription exists
                if (notificationPreferences.pushSubscription) {
                    try {
                        const SERVER_URL = 'https://aiding-migraine-notifications.onrender.com';
                        const response = await fetch(`${SERVER_URL}/api/notifications/schedule-active-checkin`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                attackId: `${attackId}-${i}`, // Unique ID for each check-in
                                checkInTime: checkInTime.toISOString(),
                                subscriptionEndpoint: notificationPreferences.pushSubscription.endpoint
                            })
                        });

                        if (!response.ok) {
                            console.error(`Failed to schedule active attack check-in #${i} on server`);
                        }
                    } catch (error) {
                        console.error(`Error scheduling active attack check-in #${i}:`, error);
                    }
                }
            }

            localStorage.setItem('scheduledNotifications', JSON.stringify(scheduledNotifications));
            console.log(`‚ö° Scheduled ${maxCheckIns} recurring active attack check-ins (every ${delayHours}h for 24h)`);
        }

        function cancelActiveAttackCheckIn(attackId) {
            // Remove ALL scheduled check-ins for this attack (they have IDs like active-checkin-${attackId}-1, -2, etc.)
            let scheduledNotifications = JSON.parse(localStorage.getItem('scheduledNotifications') || '[]');
            const toCancel = scheduledNotifications.filter(n => n.attackId === attackId && n.type === 'active-attack-checkin');
            scheduledNotifications = scheduledNotifications.filter(n => !(n.attackId === attackId && n.type === 'active-attack-checkin'));
            localStorage.setItem('scheduledNotifications', JSON.stringify(scheduledNotifications));

            console.log(`üö´ Canceled ${toCancel.length} active attack check-in notifications for attack ${attackId}`);

            // Cancel on server if push subscription exists
            if (notificationPreferences.pushSubscription && toCancel.length > 0) {
                try {
                    const SERVER_URL = 'https://aiding-migraine-notifications.onrender.com';

                    // Cancel each check-in on the server
                    for (const checkin of toCancel) {
                        const sequence = checkin.sequence || '';
                        const serverAttackId = sequence ? `${attackId}-${sequence}` : attackId;

                        fetch(`${SERVER_URL}/api/notifications/cancel-active-checkin`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                attackId: serverAttackId,
                                subscriptionEndpoint: notificationPreferences.pushSubscription.endpoint
                            })
                        }).catch(error => console.error(`Error canceling active attack check-in ${serverAttackId} on server:`, error));
                    }
                } catch (error) {
                    console.error('Error canceling active attack check-ins:', error);
                }
            }
        }

        // ============================================
        // WEATHER TRACKING SYSTEM
        // ============================================

        // Weather data structure (stored in localStorage)
        let weatherData = {
            version: 3,             // Data structure version for migrations (updated for ML features)
            enabled: false,
            location: {
                query: '',      // User's input (ZIP or city)
                city: '',       // Resolved city name
                lat: null,      // Latitude
                lon: null       // Longitude
            },
            current: {
                pressure: null,     // Current pressure in hPa
                temperature: null,  // Temperature in ¬∞C
                timestamp: null     // When fetched
            },
            forecast: [],           // 48-hour hourly forecast with full data
            history: [],            // 30 days of detailed pressure readings
            lastFetch: null,        // Last API call timestamp

            // PERSONAL PROFILE & ML FEATURES (NEW in v3)
            personalProfile: {
                threshold24h: null,         // Learned 24h threshold (null = use default 5)
                thresholdRapid: null,       // Learned rapid change threshold
                sensitivityLevel: 'standard', // 'sensitive', 'standard', 'conservative', 'custom'
                customThreshold24h: null,   // User's custom threshold if selected
                customThresholdRapid: null, // User's custom rapid threshold

                // Direction sensitivity
                dropSensitive: true,        // Triggered by pressure drops
                riseSensitive: false,       // Triggered by pressure rises
                dropPercentage: 0,          // % of migraines during drops
                risePercentage: 0,          // % of migraines during rises

                // Absolute pressure sensitivity
                lowPressureSensitive: false, // Triggered by low absolute pressure
                avgTriggerPressure: null,    // Average pressure when migraines occur

                // Multi-day patterns
                cumulativeSensitive: false,  // Reacts to multi-day cumulative changes
                avgDaysToTrigger: 1,         // Average days from pressure change to migraine

                // Seasonal patterns
                seasonalVariation: {},       // {spring: 1.2, summer: 0.8, fall: 1.3, winter: 0.9}

                // Learning metadata
                lastAnalyzed: null,          // When personal profile was last calculated
                sampleSize: 0,               // Number of migraines analyzed
                confidenceLevel: 'low'       // 'low', 'medium', 'high' based on sample size
            },

            // ML Model data
            mlModel: {
                enabled: false,
                weights: null,              // Model weights for logistic regression
                features: [],               // Feature names
                accuracy: 0,                // Model accuracy (0-100%)
                lastTrained: null,          // When model was last trained
                predictions: []             // Recent predictions for validation
            }
        };

        // Migrate weather data from old versions
        function migrateWeatherData(data) {
            if (!data || data.version === 3) {
                return data; // Already migrated or new installation
            }

            let migrated = data;

            // Migrate v1 ‚Üí v2 (if needed)
            if (!data.version || data.version < 2) {
                console.log('üì¶ Migrating weather data v1 ‚Üí v2...');
                migrated = {
                    version: 2,
                    enabled: data.enabled || false,
                    location: data.location || { query: '', city: '', lat: null, lon: null },
                    current: data.current || { pressure: null, temperature: null, timestamp: null },
                    forecast: data.forecast || [],
                    history: [],
                    lastFetch: data.lastFetch || null
                };

                // Convert old history format (simple daily readings) to new format (detailed with hourly data)
                if (data.history && Array.isArray(data.history)) {
                    migrated.history = data.history.map(oldEntry => {
                        // Old format: { date, pressure, hadMigraine }
                        // New format: { date, readings: [{time, pressure}], dailyAvg, maxChange3h, maxChange24h }

                        if (oldEntry.readings) {
                            // Already in new format somehow
                            return oldEntry;
                        }

                        return {
                            date: oldEntry.date,
                            readings: [{
                                time: oldEntry.date + 'T12:00:00Z', // Assume noon for old data
                                pressure: oldEntry.pressure || 1013.25
                            }],
                            dailyAvg: oldEntry.pressure || 1013.25,
                            maxChange3h: null,  // Unknown for old data
                            maxChange24h: null, // Will be calculated from history
                            hadMigraine: oldEntry.hadMigraine || false
                        };
                    });
                }
            }

            // Migrate v2 ‚Üí v3 (add personal profile and ML features)
            if (migrated.version === 2) {
                console.log('üì¶ Migrating weather data v2 ‚Üí v3 (adding ML features)...');
                migrated.version = 3;
                migrated.personalProfile = {
                    threshold24h: null,
                    thresholdRapid: null,
                    sensitivityLevel: 'standard',
                    customThreshold24h: null,
                    customThresholdRapid: null,
                    dropSensitive: true,
                    riseSensitive: false,
                    dropPercentage: 0,
                    risePercentage: 0,
                    lowPressureSensitive: false,
                    avgTriggerPressure: null,
                    cumulativeSensitive: false,
                    avgDaysToTrigger: 1,
                    seasonalVariation: {},
                    lastAnalyzed: null,
                    sampleSize: 0,
                    confidenceLevel: 'low'
                };
                migrated.mlModel = {
                    enabled: false,
                    weights: null,
                    features: [],
                    accuracy: 0,
                    lastTrained: null,
                    predictions: []
                };
            }

            console.log('‚úÖ Weather data migrated successfully to v3');
            return migrated;
        }

        // Initialize weather tracking
        function initWeatherTracking() {
            // Load saved weather data
            const saved = localStorage.getItem('weatherData');
            if (saved) {
                try {
                    const loaded = JSON.parse(saved);
                    weatherData = migrateWeatherData(loaded);

                    // Save migrated data
                    if (loaded.version !== 3) {
                        saveWeatherData();
                    }

                    // Analyze personal patterns if we have enough data
                    if (weatherData.enabled && weatherData.history.length >= 7) {
                        analyzePersonalWeatherProfile();
                    }
                } catch (e) {
                    console.error('Error loading weather data:', e);
                }
            }

            // Set up UI
            const enableToggle = document.getElementById('weather-tracking-enabled');
            const weatherSettings = document.getElementById('weather-settings');

            if (enableToggle) {
                enableToggle.checked = weatherData.enabled;
                weatherSettings.style.display = weatherData.enabled ? 'block' : 'none';

                enableToggle.addEventListener('change', () => {
                    weatherData.enabled = enableToggle.checked;
                    weatherSettings.style.display = weatherData.enabled ? 'block' : 'none';
                    saveWeatherData();

                    if (weatherData.enabled && weatherData.location.lat) {
                        // Fetch weather immediately when enabled
                        fetchWeatherData();
                    }
                });
            }

            // Load current location if exists
            if (weatherData.location.query) {
                document.getElementById('weather-location-input').value = weatherData.location.query;
                displayCurrentWeather();
            }

            // Location save button
            document.getElementById('weather-location-save')?.addEventListener('click', saveWeatherLocation);

            // Refresh button
            document.getElementById('weather-refresh-btn')?.addEventListener('click', () => {
                fetchWeatherData(true);
            });

            // Auto-refresh weather data if enabled and stale (>6 hours old)
            if (weatherData.enabled && weatherData.location.lat) {
                const sixHoursAgo = Date.now() - (6 * 60 * 60 * 1000);
                if (!weatherData.lastFetch || weatherData.lastFetch < sixHoursAgo) {
                    fetchWeatherData();
                }
            }
        }

        // Save weather data to localStorage
        function saveWeatherData() {
            localStorage.setItem('weatherData', JSON.stringify(weatherData));
        }

        // Save weather location (geocode and fetch weather)
        async function saveWeatherLocation() {
            const input = document.getElementById('weather-location-input').value.trim();
            const statusDiv = document.getElementById('weather-location-status');

            if (!input) {
                statusDiv.innerHTML = '<span style="color: var(--accent-red);">Please enter a location</span>';
                return;
            }

            statusDiv.innerHTML = '<span style="color: var(--accent-blue);">üîç Looking up location...</span>';

            try {
                // Use Open-Meteo geocoding API (free, no key needed)
                const geocodeUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(input)}&count=1&language=en&format=json`;

                const response = await fetch(geocodeUrl);
                const data = await response.json();

                if (!data.results || data.results.length === 0) {
                    statusDiv.innerHTML = '<span style="color: var(--accent-red);">‚ùå Location not found. Try a different format (e.g., "New York" or "10001")</span>';
                    return;
                }

                const result = data.results[0];

                // Save location data
                weatherData.location = {
                    query: input,
                    city: `${result.name}${result.admin1 ? ', ' + result.admin1 : ''}${result.country ? ', ' + result.country : ''}`,
                    lat: result.latitude,
                    lon: result.longitude
                };

                saveWeatherData();

                statusDiv.innerHTML = `<span style="color: var(--accent-green);">‚úÖ Location saved: ${weatherData.location.city}</span>`;

                // Fetch weather for this location
                await fetchWeatherData();

                // Update log screen weather display and calendar
                updateLogWeatherDisplay();
                renderCalendar();

            } catch (error) {
                console.error('Geocoding error:', error);
                statusDiv.innerHTML = '<span style="color: var(--accent-red);">‚ùå Error looking up location. Please try again.</span>';
            }
        }

        // Calculate maximum rapid pressure change from readings
        // UPDATED 2026-01-20: Changed to 6-hour window based on clinical research review
        // Note: Function name kept as "Max3hChange" for backward compatibility with data structure
        function calculateMax3hChange(readings) {
            if (!readings || readings.length < 7) {
                return 0; // Need at least 7 hourly readings for 6-hour window
            }

            let maxChange = 0;

            // Slide a 6-hour window through the readings
            // Research basis: More conservative, better evidence base than 3h
            // General "rapid change" concept validated (Okuma 2015, Kimoto 2011)
            // Specific thresholds vary in literature; 6h provides better clinical reliability
            for (let i = 0; i < readings.length - 6; i++) {
                const windowPressures = readings.slice(i, i + 7).map(r => r.pressure);
                const windowMax = Math.max(...windowPressures);
                const windowMin = Math.min(...windowPressures);
                const change = windowMax - windowMin;

                if (change > maxChange) {
                    maxChange = change;
                }
            }

            return Math.round(maxChange * 10) / 10;
        }

        // Fetch weather data from Open-Meteo
        async function fetchWeatherData(forced = false) {
            if (!weatherData.location.lat || !weatherData.location.lon) {
                console.log('No location set for weather fetch');
                return;
            }

            // Don't fetch if we fetched recently (unless forced)
            if (!forced && weatherData.lastFetch) {
                const oneHourAgo = Date.now() - (60 * 60 * 1000);
                if (weatherData.lastFetch > oneHourAgo) {
                    console.log('Weather data is recent, skipping fetch');
                    displayCurrentWeather();
                    return;
                }
            }

            try {
                // Open-Meteo API - Free, no key required
                // Get current + 48h forecast of surface pressure (hourly data)
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${weatherData.location.lat}&longitude=${weatherData.location.lon}&current=surface_pressure,temperature_2m&hourly=surface_pressure&timezone=auto&forecast_days=2`;

                const response = await fetch(weatherUrl);
                const data = await response.json();

                if (!data.current || !data.hourly) {
                    throw new Error('Invalid weather data received');
                }

                const currentTime = new Date();
                const currentPressure = Math.round(data.current.surface_pressure * 10) / 10;

                // Store current weather
                weatherData.current = {
                    pressure: currentPressure,
                    temperature: Math.round(data.current.temperature_2m * 10) / 10,
                    timestamp: Date.now()
                };

                // Store 48-hour hourly forecast
                weatherData.forecast = data.hourly.time.map((time, i) => ({
                    time: time,
                    pressure: Math.round(data.hourly.surface_pressure[i] * 10) / 10
                }));

                // Update history with new reading
                const today = new Date().toISOString().split('T')[0];
                const newReading = {
                    time: currentTime.toISOString(),
                    pressure: currentPressure
                };

                // Find or create today's entry
                let todayEntry = weatherData.history.find(h => h.date === today);

                if (!todayEntry) {
                    // Create new entry for today
                    todayEntry = {
                        date: today,
                        readings: [],
                        dailyAvg: 0,
                        maxChange3h: 0,
                        maxChange24h: null
                    };
                    weatherData.history.push(todayEntry);
                }

                // Add new reading (keep multiple readings per day)
                todayEntry.readings.push(newReading);

                // Keep only last 24 hours of readings per day (one per hour max)
                if (todayEntry.readings.length > 24) {
                    todayEntry.readings = todayEntry.readings.slice(-24);
                }

                // Calculate daily average from all readings
                const pressureSum = todayEntry.readings.reduce((sum, r) => sum + r.pressure, 0);
                todayEntry.dailyAvg = Math.round((pressureSum / todayEntry.readings.length) * 10) / 10;

                // Calculate max 3-hour change for today
                todayEntry.maxChange3h = calculateMax3hChange(todayEntry.readings);

                // Calculate 24h change if we have yesterday's data
                if (weatherData.history.length >= 2) {
                    const sorted = [...weatherData.history].sort((a, b) => new Date(b.date) - new Date(a.date));
                    const yesterday = sorted[1];
                    if (yesterday && yesterday.dailyAvg) {
                        todayEntry.maxChange24h = Math.round((todayEntry.dailyAvg - yesterday.dailyAvg) * 10) / 10;
                    }
                }

                // Keep only last 30 days
                weatherData.history = weatherData.history
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 30);

                weatherData.lastFetch = Date.now();
                saveWeatherData();

                displayCurrentWeather();
                updateLogWeatherDisplay();

                console.log('‚úÖ Weather data updated:', currentPressure, 'hPa');
                console.log('   3h max change:', todayEntry.maxChange3h, 'hPa');
                console.log('   24h change:', todayEntry.maxChange24h, 'hPa');

            } catch (error) {
                console.error('Weather fetch error:', error);
                const statusDiv = document.getElementById('weather-location-status');
                if (statusDiv) {
                    statusDiv.innerHTML = '<span style="color: var(--accent-red);">‚ùå Error fetching weather data. Please try again later.</span>';
                }
            }
        }

        // Display current weather in settings
        function displayCurrentWeather() {
            const displayDiv = document.getElementById('weather-current-display');
            const locationSpan = document.getElementById('weather-location-display');
            const pressureSpan = document.getElementById('weather-current-pressure');
            const changeSpan = document.getElementById('weather-pressure-change');
            const updatedSpan = document.getElementById('weather-last-updated');

            if (!weatherData.location.city || !weatherData.current.pressure) {
                displayDiv.style.display = 'none';
                return;
            }

            displayDiv.style.display = 'block';
            locationSpan.textContent = weatherData.location.city;
            pressureSpan.textContent = `${weatherData.current.pressure} hPa`;

            // Calculate 24h pressure change
            const change24h = getPressureChange24h();
            if (change24h !== null) {
                const changeText = change24h > 0 ? `‚Üë ${change24h} hPa` : `‚Üì ${Math.abs(change24h)} hPa`;
                const changeColor = Math.abs(change24h) > 5 ? 'var(--accent-red)' : 'var(--text-secondary)';
                changeSpan.innerHTML = `<span style="color: ${changeColor}">24h change: ${changeText}${Math.abs(change24h) > 5 ? ' (significant)' : ''}</span>`;
            } else {
                changeSpan.textContent = '24h change: Not enough data';
            }

            // Last updated
            if (weatherData.current.timestamp) {
                const lastUpdate = new Date(weatherData.current.timestamp);
                const now = new Date();
                const diffMinutes = Math.floor((now - lastUpdate) / 60000);

                let timeAgo;
                if (diffMinutes < 1) {
                    timeAgo = 'Just now';
                } else if (diffMinutes < 60) {
                    timeAgo = `${diffMinutes} minute${diffMinutes !== 1 ? 's' : ''} ago`;
                } else {
                    const diffHours = Math.floor(diffMinutes / 60);
                    timeAgo = `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
                }

                updatedSpan.textContent = `Last updated: ${timeAgo}`;
            }
        }

        // Get 24-hour pressure change (uses historical daily averages for accuracy)
        function getPressureChange24h() {
            if (weatherData.history.length < 2) {
                return null;
            }

            // Sort history to get last two days
            const sorted = [...weatherData.history]
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sorted.length < 2) {
                return null;
            }

            const today = sorted[0];
            const yesterday = sorted[1];

            // Use daily averages for consistent comparison
            if (!today.dailyAvg || !yesterday.dailyAvg) {
                return null;
            }

            const change = today.dailyAvg - yesterday.dailyAvg;
            return Math.round(change * 10) / 10; // 1 decimal place
        }

        // Detect rapid pressure changes in forecast (next 24 hours)
        // UPDATED 2026-01-20: Changed to 6-hour window with 5 hPa threshold
        // Based on clinical research review (see CLINICAL_THRESHOLDS_RESEARCH.md)
        function detectRapidForecastChanges() {
            if (!weatherData.forecast || weatherData.forecast.length < 7) {
                return [];
            }

            const rapidChanges = [];
            const now = new Date();
            const next24h = new Date(now.getTime() + 24 * 60 * 60 * 1000);

            // Check 6-hour sliding windows in the next 24 hours
            // Research basis: More conservative threshold with better clinical evidence
            for (let i = 0; i < Math.min(weatherData.forecast.length - 6, 24); i++) {
                const window = weatherData.forecast.slice(i, i + 7);
                const windowTime = new Date(window[0].time);

                // Only check forecast (future times)
                if (windowTime <= now || windowTime > next24h) {
                    continue;
                }

                const pressures = window.map(r => r.pressure);
                const maxPressure = Math.max(...pressures);
                const minPressure = Math.min(...pressures);
                const change = maxPressure - minPressure;

                // Clinical threshold: 5+ hPa in 6 hours (research-validated)
                // More conservative than previous 3h/3hPa which lacked specific literature support
                if (change >= 5) {
                    const hoursFromNow = Math.round((windowTime - now) / (1000 * 60 * 60));
                    rapidChanges.push({
                        startTime: window[0].time,
                        endTime: window[6].time,
                        change: Math.round(change * 10) / 10,
                        hoursFromNow: hoursFromNow,
                        direction: pressures[6] < pressures[0] ? 'falling' : 'rising'
                    });
                }
            }

            return rapidChanges;
        }

        // Get absolute pressure risk level (NEW - based on Okuma et al. 2015)
        // Research shows 50% of migraines occur in 1003-1007 hPa range
        function getAbsolutePressureRisk(pressure) {
            const STANDARD_PRESSURE = 1013.25;
            const VERY_HIGH_RISK = 1005; // 26.5% of migraines (Okuma 2015)
            const HIGH_RISK = 1007;      // 23.5% of migraines (Okuma 2015)

            if (pressure < VERY_HIGH_RISK) {
                return {
                    level: 'very-high',
                    message: 'Very low pressure - high migraine risk',
                    detail: `${(STANDARD_PRESSURE - pressure).toFixed(1)} hPa below standard`,
                    color: 'var(--accent-red)'
                };
            } else if (pressure < HIGH_RISK) {
                return {
                    level: 'high',
                    message: 'Low pressure - increased migraine risk',
                    detail: `${(STANDARD_PRESSURE - pressure).toFixed(1)} hPa below standard`,
                    color: 'var(--pain-moderate)'
                };
            } else if (pressure < STANDARD_PRESSURE) {
                return {
                    level: 'moderate',
                    message: 'Below standard pressure',
                    detail: `${(STANDARD_PRESSURE - pressure).toFixed(1)} hPa below standard`,
                    color: 'var(--text-secondary)'
                };
            } else {
                return {
                    level: 'normal',
                    message: 'Normal pressure range',
                    detail: 'Above standard pressure',
                    color: 'var(--accent-green)'
                };
            }
        }

        // Get pressure trend description
        function getPressureTrend() {
            const change24h = getPressureChange24h();
            if (change24h === null) {
                return { text: 'Unknown', icon: '?', significant: false };
            }

            if (change24h > 5) {
                return { text: 'Rising rapidly', icon: '‚Üë', significant: true };
            } else if (change24h > 2) {
                return { text: 'Rising', icon: '‚Üë', significant: false };
            } else if (change24h > -2) {
                return { text: 'Stable', icon: '‚Üí', significant: false };
            } else if (change24h > -5) {
                return { text: 'Falling', icon: '‚Üì', significant: false };
            } else {
                return { text: 'Falling rapidly', icon: '‚Üì', significant: true };
            }
        }

        // Get current weather for migraine entry
        function getCurrentWeatherForEntry() {
            if (!weatherData.enabled || !weatherData.current.pressure) {
                return null;
            }

            // Get today's entry if it exists for additional data
            const today = new Date().toISOString().split('T')[0];
            const todayEntry = weatherData.history.find(h => h.date === today);

            return {
                pressure: weatherData.current.pressure,
                change24h: getPressureChange24h(),
                maxChange3h: todayEntry ? todayEntry.maxChange3h : null,
                trend: getPressureTrend(),
                timestamp: weatherData.current.timestamp
            };
        }

        // Update weather forecast indicator on log screen
        function updateLogWeatherDisplay() {
            const forecastIndicator = document.getElementById('weather-forecast-indicator');
            const clearBox = document.getElementById('weather-clear');
            const warningBox = document.getElementById('weather-warning');

            // Hide if weather tracking is disabled or no data
            if (!weatherData.enabled || !weatherData.current.pressure) {
                forecastIndicator.style.display = 'none';
                return;
            }

            // Get 24h change and trend
            const change24h = getPressureChange24h();
            const trend = getPressureTrend();

            // Check for rapid changes in upcoming forecast
            const rapidChanges = detectRapidForecastChanges();
            const hasRapidChanges = rapidChanges.length > 0;

            // Show indicator if we have any data
            forecastIndicator.style.display = 'block';

            // Determine warning state: show warning if significant 24h change OR rapid forecast changes
            const showWarning = (trend.significant && change24h !== null) || hasRapidChanges;

            if (showWarning) {
                // Significant pressure change or rapid forecast change - show warning
                clearBox.style.display = 'none';
                warningBox.style.display = 'block';

                // Update warning detail with specific information
                const warningDetail = document.getElementById('weather-warning-detail');
                let warningText = '';

                if (trend.significant && change24h !== null) {
                    const changeText = change24h > 0 ? `+${change24h.toFixed(1)}` : change24h.toFixed(1);
                    warningText = `${trend.text} (${changeText} hPa in 24h)`;
                }

                if (hasRapidChanges) {
                    const nextChange = rapidChanges[0];
                    if (warningText) warningText += ' ‚Ä¢ ';
                    warningText += `Rapid ${nextChange.direction} (${nextChange.change} hPa in 6h) in ${nextChange.hoursFromNow}h`;
                }

                warningDetail.textContent = warningText;
            } else if (change24h !== null) {
                // Normal pressure - show clear
                clearBox.style.display = 'block';
                warningBox.style.display = 'none';
            } else {
                // Not enough data yet - hide forecast indicator
                forecastIndicator.style.display = 'none';
            }
        }

        // Calculate weather correlation for analytics (improved accuracy)
        function calculateWeatherCorrelation() {
            if (!weatherData.enabled || weatherData.history.length < 7) {
                return null;
            }

            const migraines = getActiveMigraines();

            // Count significant pressure changes and associated migraines
            let significantChangeDays = 0;
            let migrainesOnChangeDays = 0;
            let totalMigraineDays = 0;
            let rapidChangeDays = 0; // Track 3h rapid changes
            let migrainesOnRapidChangeDays = 0;

            // Sort history chronologically for proper analysis
            const sortedHistory = [...weatherData.history]
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            sortedHistory.forEach((day, index) => {
                if (index === 0) return; // Skip first day (no previous day to compare)

                const yesterday = sortedHistory[index - 1];
                const dayDate = new Date(day.date);

                // Calculate 24h change using daily averages
                let change24h = 0;
                if (day.dailyAvg && yesterday.dailyAvg) {
                    change24h = Math.abs(day.dailyAvg - yesterday.dailyAvg);
                } else if (day.pressure && yesterday.pressure) {
                    // Fallback for old data format
                    change24h = Math.abs((day.pressure || day.dailyAvg) - (yesterday.pressure || yesterday.dailyAvg));
                }

                // Check for significant 24h change (>5 hPa clinical threshold - Kimoto 2011)
                const hasSignificantChange = change24h > 5;

                // Check for rapid changes (>5 hPa in 6h - Updated 2026-01-20 based on research review)
                // Note: maxChange3h field name kept for backward compatibility, but now uses 6h window
                const hasRapidChange = day.maxChange3h && day.maxChange3h >= 5;

                if (hasSignificantChange) {
                    significantChangeDays++;
                }

                if (hasRapidChange) {
                    rapidChangeDays++;
                }

                // Check for migraines within ¬±12 hours of this day (accounting for lag)
                const windowStart = new Date(dayDate.getTime() - 12 * 60 * 60 * 1000);
                const windowEnd = new Date(dayDate.getTime() + 36 * 60 * 60 * 1000); // +36h to cover full day + 12h

                const hadMigraineInWindow = migraines.some(m => {
                    const migraineTime = new Date(m.startTime);
                    return migraineTime >= windowStart && migraineTime <= windowEnd;
                });

                if (hasSignificantChange && hadMigraineInWindow) {
                    migrainesOnChangeDays++;
                }

                if (hasRapidChange && hadMigraineInWindow) {
                    migrainesOnRapidChangeDays++;
                }

                // Count total migraine days in tracked period
                const hadMigraineThisDay = migraines.some(m => {
                    const migraineDate = new Date(m.startTime).toISOString().split('T')[0];
                    return migraineDate === day.date;
                });

                if (hadMigraineThisDay) {
                    totalMigraineDays++;
                }
            });

            // Use whichever correlation is stronger (24h or 3h)
            let primaryCorrelation = 0;
            let primaryType = '24h';

            if (significantChangeDays === 0 && rapidChangeDays === 0) {
                return {
                    percentage: 0,
                    significantChangeDays: 0,
                    migrainesOnChangeDays: 0,
                    level: 'insufficient',
                    message: 'Not enough significant pressure changes recorded yet.'
                };
            }

            // Calculate both correlations
            const correlation24h = significantChangeDays > 0 ?
                Math.round((migrainesOnChangeDays / significantChangeDays) * 100) : 0;

            const correlation3h = rapidChangeDays > 0 ?
                Math.round((migrainesOnRapidChangeDays / rapidChangeDays) * 100) : 0;

            // Use the stronger correlation for classification
            if (correlation3h > correlation24h) {
                primaryCorrelation = correlation3h;
                primaryType = '3h rapid';
            } else {
                primaryCorrelation = correlation24h;
                primaryType = '24h';
            }

            let level, message;
            if (primaryCorrelation >= 70) {
                level = 'strong';
                message = `Strong correlation detected with ${primaryType} pressure changes. This appears to be a significant trigger for you.`;
            } else if (primaryCorrelation >= 40) {
                level = 'moderate';
                message = `Moderate correlation with ${primaryType} pressure changes. May affect your migraines.`;
            } else {
                level = 'weak';
                message = `Low correlation with pressure changes. Other triggers may be more significant.`;
            }

            return {
                percentage: primaryCorrelation,
                correlation24h: correlation24h,
                correlation3h: correlation3h,
                significantChangeDays: significantChangeDays,
                rapidChangeDays: rapidChangeDays,
                migrainesOnChangeDays: migrainesOnChangeDays,
                migrainesOnRapidChangeDays: migrainesOnRapidChangeDays,
                totalMigraineDays: totalMigraineDays,
                level: level,
                message: message,
                primaryType: primaryType
            };
        }

        // ============================================
        // PERSONAL PROFILING & MACHINE LEARNING
        // ============================================

        // Main function to analyze user's personal weather sensitivity profile
        function analyzePersonalWeatherProfile() {
            if (!weatherData.enabled || weatherData.history.length < 7) {
                return; // Need at least 7 days of data
            }

            const migraines = getActiveMigraines();
            if (migraines.length < 3) {
                return; // Need at least 3 migraines for meaningful analysis
            }

            console.log('üß† Analyzing personal weather sensitivity profile...');

            const profile = weatherData.personalProfile;

            // 1. Calculate personal thresholds
            const thresholds = calculatePersonalThresholds(migraines);
            profile.threshold24h = thresholds.threshold24h;
            profile.thresholdRapid = thresholds.thresholdRapid;

            // 2. Analyze direction sensitivity (drops vs rises)
            const direction = analyzeDirectionSensitivity(migraines);
            profile.dropSensitive = direction.dropSensitive;
            profile.riseSensitive = direction.riseSensitive;
            profile.dropPercentage = direction.dropPercentage;
            profile.risePercentage = direction.risePercentage;

            // 3. Analyze absolute pressure sensitivity
            const absolute = analyzeAbsolutePressureSensitivity(migraines);
            profile.lowPressureSensitive = absolute.lowPressureSensitive;
            profile.avgTriggerPressure = absolute.avgTriggerPressure;

            // 4. Detect multi-day cumulative patterns
            const cumulative = detectMultiDayPatterns(migraines);
            profile.cumulativeSensitive = cumulative.cumulativeSensitive;
            profile.avgDaysToTrigger = cumulative.avgDaysToTrigger;

            // 5. Analyze seasonal patterns
            profile.seasonalVariation = analyzeSeasonalPatterns(migraines);

            // Update metadata
            profile.lastAnalyzed = Date.now();
            profile.sampleSize = migraines.length;
            profile.confidenceLevel = migraines.length >= 10 ? 'high' :
                                      migraines.length >= 5 ? 'medium' : 'low';

            saveWeatherData();

            console.log('‚úÖ Personal profile analyzed:', {
                threshold24h: profile.threshold24h,
                thresholdRapid: profile.thresholdRapid,
                dropSensitive: profile.dropSensitive,
                confidence: profile.confidenceLevel,
                sampleSize: profile.sampleSize
            });

            // Train ML model if enough data
            if (migraines.length >= 10 && weatherData.history.length >= 14) {
                trainMigrainePredictionModel(migraines);
            }
        }

        // Calculate user's personal trigger thresholds based on actual migraine history
        function calculatePersonalThresholds(migraines) {
            const changes24h = [];
            const changesRapid = [];

            migraines.forEach(migraine => {
                const migraineDate = new Date(migraine.startTime).toISOString().split('T')[0];

                // Find weather data for days around the migraine
                for (let daysBack = 0; daysBack <= 2; daysBack++) {
                    const checkDate = new Date(migraine.startTime);
                    checkDate.setDate(checkDate.getDate() - daysBack);
                    const checkDateStr = checkDate.toISOString().split('T')[0];

                    const weatherEntry = weatherData.history.find(h => h.date === checkDateStr);
                    if (weatherEntry) {
                        // Record 24h change if available
                        if (weatherEntry.maxChange24h && Math.abs(weatherEntry.maxChange24h) > 0) {
                            changes24h.push(Math.abs(weatherEntry.maxChange24h));
                        }

                        // Record rapid change if available
                        if (weatherEntry.maxChange3h && weatherEntry.maxChange3h > 0) {
                            changesRapid.push(weatherEntry.maxChange3h);
                        }
                    }
                }
            });

            // Calculate median (more robust than mean for outliers)
            const median = arr => {
                if (arr.length === 0) return null;
                const sorted = [...arr].sort((a, b) => a - b);
                const mid = Math.floor(sorted.length / 2);
                return sorted.length % 2 === 0 ?
                    (sorted[mid - 1] + sorted[mid]) / 2 :
                    sorted[mid];
            };

            // Use 25th percentile (more sensitive - catches more triggers)
            const percentile25 = arr => {
                if (arr.length === 0) return null;
                const sorted = [...arr].sort((a, b) => a - b);
                const index = Math.floor(sorted.length * 0.25);
                return sorted[index];
            };

            return {
                threshold24h: percentile25(changes24h) || 5,  // Default to 5 if no data
                thresholdRapid: percentile25(changesRapid) || 5
            };
        }

        // Analyze if user is sensitive to pressure drops vs rises
        function analyzeDirectionSensitivity(migraines) {
            let dropsCount = 0;
            let risesCount = 0;
            let totalWithData = 0;

            migraines.forEach(migraine => {
                const migraineDate = new Date(migraine.startTime).toISOString().split('T')[0];

                // Check 1-2 days before migraine
                for (let daysBack = 1; daysBack <= 2; daysBack++) {
                    const checkDate = new Date(migraine.startTime);
                    checkDate.setDate(checkDate.getDate() - daysBack);
                    const checkDateStr = checkDate.toISOString().split('T')[0];

                    const weatherEntry = weatherData.history.find(h => h.date === checkDateStr);
                    if (weatherEntry && weatherEntry.maxChange24h !== null) {
                        totalWithData++;
                        if (weatherEntry.maxChange24h < -2) { // Significant drop
                            dropsCount++;
                        } else if (weatherEntry.maxChange24h > 2) { // Significant rise
                            risesCount++;
                        }
                    }
                }
            });

            const dropPercentage = totalWithData > 0 ? Math.round((dropsCount / totalWithData) * 100) : 0;
            const risePercentage = totalWithData > 0 ? Math.round((risesCount / totalWithData) * 100) : 0;

            return {
                dropSensitive: dropPercentage >= 40,
                riseSensitive: risePercentage >= 40,
                dropPercentage: dropPercentage,
                risePercentage: risePercentage
            };
        }

        // Analyze sensitivity to absolute low pressure
        function analyzeAbsolutePressureSensitivity(migraines) {
            const pressuresAtMigraine = [];

            migraines.forEach(migraine => {
                const migraineDate = new Date(migraine.startTime).toISOString().split('T')[0];
                const weatherEntry = weatherData.history.find(h => h.date === migraineDate);

                if (weatherEntry) {
                    const pressure = weatherEntry.dailyAvg || weatherEntry.pressure;
                    if (pressure) {
                        pressuresAtMigraine.push(pressure);
                    }
                }
            });

            if (pressuresAtMigraine.length === 0) {
                return { lowPressureSensitive: false, avgTriggerPressure: null };
            }

            const avgPressure = pressuresAtMigraine.reduce((a, b) => a + b, 0) / pressuresAtMigraine.length;
            const lowPressureCount = pressuresAtMigraine.filter(p => p < 1007).length;
            const lowPressurePercent = (lowPressureCount / pressuresAtMigraine.length) * 100;

            return {
                lowPressureSensitive: lowPressurePercent >= 40,
                avgTriggerPressure: Math.round(avgPressure * 10) / 10
            };
        }

        // Detect if user reacts to cumulative multi-day pressure changes
        function detectMultiDayPatterns(migraines) {
            let cumulativeCount = 0;
            let totalAnalyzed = 0;
            const daysToTrigger = [];

            migraines.forEach(migraine => {
                const migraineDate = new Date(migraine.startTime);

                // Look back 5 days to find pressure change patterns
                let cumulativeChange = 0;
                let daysSinceChange = null;

                for (let daysBack = 1; daysBack <= 5; daysBack++) {
                    const checkDate = new Date(migraineDate);
                    checkDate.setDate(checkDate.getDate() - daysBack);
                    const checkDateStr = checkDate.toISOString().split('T')[0];

                    const weatherEntry = weatherData.history.find(h => h.date === checkDateStr);
                    if (weatherEntry && weatherEntry.maxChange24h !== null) {
                        cumulativeChange += weatherEntry.maxChange24h;

                        // If cumulative drop > 8 hPa over multiple days
                        if (cumulativeChange < -8) {
                            cumulativeCount++;
                            daysSinceChange = daysBack;
                            daysToTrigger.push(daysBack);
                            totalAnalyzed++;
                            break;
                        }
                    }
                }

                if (daysSinceChange === null) {
                    totalAnalyzed++;
                }
            });

            const avgDays = daysToTrigger.length > 0 ?
                daysToTrigger.reduce((a, b) => a + b, 0) / daysToTrigger.length : 1;

            return {
                cumulativeSensitive: totalAnalyzed > 0 && (cumulativeCount / totalAnalyzed) >= 0.3,
                avgDaysToTrigger: Math.round(avgDays * 10) / 10
            };
        }

        // Analyze seasonal variation in weather sensitivity
        function analyzeSeasonalPatterns(migraines) {
            const seasons = { winter: [], spring: [], summer: [], fall: [] };
            const weatherMigraines = [];

            migraines.forEach(migraine => {
                const migraineDate = new Date(migraine.startTime);
                const month = migraineDate.getMonth();
                const season = month <= 2 ? 'winter' :
                              month <= 5 ? 'spring' :
                              month <= 8 ? 'summer' : 'fall';

                // Check if weather-related (significant pressure change 0-2 days before)
                let wasWeatherRelated = false;
                for (let daysBack = 0; daysBack <= 2; daysBack++) {
                    const checkDate = new Date(migraineDate);
                    checkDate.setDate(checkDate.getDate() - daysBack);
                    const checkDateStr = checkDate.toISOString().split('T')[0];

                    const weatherEntry = weatherData.history.find(h => h.date === checkDateStr);
                    if (weatherEntry && weatherEntry.maxChange24h && Math.abs(weatherEntry.maxChange24h) > 5) {
                        wasWeatherRelated = true;
                        break;
                    }
                }

                seasons[season].push(wasWeatherRelated ? 1 : 0);
            });

            // Calculate weather-sensitivity ratio per season
            const seasonalRatios = {};
            let avgRatio = 0;
            let seasonCount = 0;

            for (const season in seasons) {
                if (seasons[season].length > 0) {
                    const weatherCount = seasons[season].filter(x => x === 1).length;
                    const ratio = weatherCount / seasons[season].length;
                    seasonalRatios[season] = ratio;
                    avgRatio += ratio;
                    seasonCount++;
                }
            }

            avgRatio = seasonCount > 0 ? avgRatio / seasonCount : 1;

            // Normalize to show relative sensitivity (1.0 = average)
            const normalized = {};
            for (const season in seasonalRatios) {
                normalized[season] = avgRatio > 0 ?
                    Math.round((seasonalRatios[season] / avgRatio) * 10) / 10 : 1.0;
            }

            return normalized;
        }

        // Get effective threshold based on user settings and learned thresholds
        function getEffectiveThreshold(type = '24h') {
            const profile = weatherData.personalProfile;

            // Check user's sensitivity setting
            if (profile.sensitivityLevel === 'custom') {
                return type === '24h' ?
                    (profile.customThreshold24h || 5) :
                    (profile.customThresholdRapid || 5);
            }

            // Use learned threshold if confidence is high
            if (profile.confidenceLevel === 'high') {
                const learned = type === '24h' ? profile.threshold24h : profile.thresholdRapid;
                if (learned !== null) {
                    // Apply sensitivity level multiplier
                    const multiplier = profile.sensitivityLevel === 'sensitive' ? 0.7 :
                                      profile.sensitivityLevel === 'conservative' ? 1.3 : 1.0;
                    return Math.round(learned * multiplier * 10) / 10;
                }
            }

            // Fall back to standard thresholds with sensitivity adjustment
            const standard = type === '24h' ? 5 : 5;
            const multiplier = profile.sensitivityLevel === 'sensitive' ? 0.6 :
                              profile.sensitivityLevel === 'conservative' ? 1.5 : 1.0;
            return Math.round(standard * multiplier * 10) / 10;
        }

        // Generate predictive alerts based on forecast and personal profile
        function generatePredictiveAlerts() {
            if (!weatherData.enabled || !weatherData.forecast || weatherData.forecast.length < 12) {
                return [];
            }

            const alerts = [];
            const profile = weatherData.personalProfile;
            const threshold24h = getEffectiveThreshold('24h');
            const thresholdRapid = getEffectiveThreshold('rapid');

            // Analyze next 24 hours of forecast
            const now = new Date();
            for (let i = 0; i < Math.min(weatherData.forecast.length - 6, 24); i++) {
                const window = weatherData.forecast.slice(i, i + 7);
                const startTime = new Date(window[0].time);

                if (startTime <= now) continue; // Only future predictions

                const pressures = window.map(r => r.pressure);
                const currentPressure = pressures[0];
                const avgChange = (pressures[6] - pressures[0]) / 6; // hPa per hour
                const totalChange = pressures[6] - pressures[0];
                const rapidChange = Math.max(...pressures) - Math.min(...pressures);

                // Check if this matches user's trigger pattern
                let triggerProbability = 0;
                const triggers = [];

                // Check rapid change
                if (rapidChange >= thresholdRapid) {
                    triggerProbability += 30;
                    triggers.push(`Rapid ${totalChange < 0 ? 'drop' : 'rise'} (${rapidChange.toFixed(1)} hPa in 6h)`);
                }

                // Check if direction matches user's sensitivity
                if (totalChange < 0 && profile.dropSensitive) {
                    triggerProbability += 20;
                } else if (totalChange > 0 && profile.riseSensitive) {
                    triggerProbability += 15;
                }

                // Check absolute low pressure
                if (profile.lowPressureSensitive && currentPressure < 1007) {
                    triggerProbability += 25;
                    triggers.push(`Low absolute pressure (${currentPressure.toFixed(1)} hPa)`);
                }

                // Check 24h projection
                if (i + 24 < weatherData.forecast.length) {
                    const pressure24hLater = weatherData.forecast[i + 24].pressure;
                    const change24h = Math.abs(pressure24hLater - currentPressure);
                    if (change24h >= threshold24h) {
                        triggerProbability += 25;
                        triggers.push(`24h ${pressure24hLater < currentPressure ? 'drop' : 'rise'} (${change24h.toFixed(1)} hPa)`);
                    }
                }

                // If probability high enough, create alert
                if (triggerProbability >= 40) {
                    const hoursUntil = Math.round((startTime - now) / (1000 * 60 * 60));
                    alerts.push({
                        time: startTime.toISOString(),
                        hoursUntil: hoursUntil,
                        probability: Math.min(triggerProbability, 95), // Cap at 95%
                        triggers: triggers,
                        pressure: currentPressure,
                        change: totalChange,
                        recommendation: getPredictiveRecommendation(triggerProbability, hoursUntil)
                    });
                }
            }

            // Return only the most imminent high-probability alerts
            return alerts
                .filter(a => a.probability >= 50)
                .sort((a, b) => b.probability - a.probability)
                .slice(0, 3);
        }

        // Get recommendation based on prediction
        function getPredictiveRecommendation(probability, hoursUntil) {
            if (probability >= 75) {
                if (hoursUntil <= 6) {
                    return 'HIGH RISK - Consider taking preventive medication now';
                } else {
                    return 'High risk predicted - Plan ahead and have medication ready';
                }
            } else if (probability >= 60) {
                return 'Moderate risk - Monitor symptoms and be prepared';
            } else {
                return 'Elevated risk - Stay aware of potential triggers';
            }
        }

        // Simple ML model: Logistic Regression for migraine probability
        function trainMigrainePredictionModel(migraines) {
            console.log('ü§ñ Training migraine prediction model...');

            const trainingData = [];
            const labels = [];

            // Build training dataset from last 30 days
            const sortedHistory = [...weatherData.history]
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(-30);

            sortedHistory.forEach(day => {
                const dayDate = new Date(day.date);

                // Features
                const features = [
                    day.dailyAvg || day.pressure || 1013, // Absolute pressure
                    day.maxChange24h || 0,                 // 24h change
                    day.maxChange3h || 0,                  // Rapid change
                    dayDate.getDay(),                      // Day of week (0-6)
                    dayDate.getMonth(),                    // Month (0-11)
                    day.dailyAvg < 1007 ? 1 : 0,          // Low pressure flag
                    (day.maxChange24h || 0) < 0 ? 1 : 0   // Dropping flag
                ];

                // Label: Did migraine occur on this day?
                const hadMigraine = migraines.some(m => {
                    const mDate = new Date(m.startTime).toISOString().split('T')[0];
                    return mDate === day.date;
                });

                trainingData.push(features);
                labels.push(hadMigraine ? 1 : 0);
            });

            // Simple logistic regression (gradient descent)
            const weights = simpleLogisticRegression(trainingData, labels);

            // Calculate accuracy
            let correct = 0;
            trainingData.forEach((features, i) => {
                const prediction = sigmoid(dotProduct(weights, features)) > 0.5 ? 1 : 0;
                if (prediction === labels[i]) correct++;
            });
            const accuracy = Math.round((correct / trainingData.length) * 100);

            weatherData.mlModel = {
                enabled: accuracy >= 60, // Only enable if reasonably accurate
                weights: weights,
                features: ['pressure', 'change24h', 'changeRapid', 'dayOfWeek', 'month', 'lowPressure', 'dropping'],
                accuracy: accuracy,
                lastTrained: Date.now(),
                predictions: []
            };

            saveWeatherData();

            console.log(`‚úÖ Model trained - Accuracy: ${accuracy}%`,
                        accuracy >= 60 ? '(enabled)' : '(disabled - low accuracy)');
        }

        // Simple logistic regression implementation
        function simpleLogisticRegression(X, y, learningRate = 0.01, iterations = 1000) {
            const m = X.length;
            const n = X[0].length;
            let weights = new Array(n).fill(0);

            for (let iter = 0; iter < iterations; iter++) {
                const gradients = new Array(n).fill(0);

                for (let i = 0; i < m; i++) {
                    const prediction = sigmoid(dotProduct(weights, X[i]));
                    const error = prediction - y[i];

                    for (let j = 0; j < n; j++) {
                        gradients[j] += error * X[i][j];
                    }
                }

                for (let j = 0; j < n; j++) {
                    weights[j] -= (learningRate / m) * gradients[j];
                }
            }

            return weights;
        }

        function sigmoid(z) {
            return 1 / (1 + Math.exp(-z));
        }

        function dotProduct(a, b) {
            return a.reduce((sum, val, i) => sum + val * b[i], 0);
        }

        // Predict migraine probability using ML model
        function predictMigraineProbability(pressureFeatures) {
            if (!weatherData.mlModel.enabled || !weatherData.mlModel.weights) {
                return null;
            }

            const features = [
                pressureFeatures.pressure,
                pressureFeatures.change24h || 0,
                pressureFeatures.changeRapid || 0,
                new Date().getDay(),
                new Date().getMonth(),
                pressureFeatures.pressure < 1007 ? 1 : 0,
                (pressureFeatures.change24h || 0) < 0 ? 1 : 0
            ];

            const probability = sigmoid(dotProduct(weatherData.mlModel.weights, features));
            return Math.round(probability * 100);
        }

        // ============================================
        // ANALYTICS SYSTEM
        // ============================================

        let analyticsCharts = {
            frequency: null,
            pain: null,
            time: null,
            dow: null,
            pressure: null
        };

        // Get theme-aware colors for charts
        function getChartColors() {
            const isDark = document.documentElement.getAttribute('data-theme') !== 'light';

            return {
                text: isDark ? '#f0eeeb' : '#2a2a2a',
                textSecondary: isDark ? '#d8d5cf' : '#666666',
                grid: isDark ? 'rgba(255, 255, 255, 0.12)' : 'rgba(0, 0, 0, 0.1)',
                primary: isDark ? 'rgb(168, 85, 247)' : 'rgb(147, 51, 234)',  // Brighter purple for dark mode
                primaryBg: isDark ? 'rgba(168, 85, 247, 0.2)' : 'rgba(147, 51, 234, 0.1)',
                green: isDark ? '#9cd4ab' : '#4a7c59',  // Brighter green for dark mode
                yellow: isDark ? '#ffd966' : '#ff9800',  // Brighter yellow for dark mode
                red: isDark ? '#ff9e94' : '#f44336',  // Brighter red for dark mode
                blue: isDark ? '#90bbff' : '#2196f3'  // Brighter blue for dark mode
            };
        }

        function initializeAnalytics() {
            // Set up event listener for range change
            document.getElementById('analytics-range').addEventListener('change', renderAnalytics);

            // Initial render
            renderAnalytics();
        }

        function renderAnalytics() {
            // Check for reduced motion preference and disable Chart.js animations
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            if (prefersReducedMotion) {
                Chart.defaults.animation = false;
                Chart.defaults.animations = {
                    colors: false,
                    x: false,
                    y: false
                };
                Chart.defaults.transitions = {
                    active: { animation: { duration: 0 } },
                    resize: { animation: { duration: 0 } },
                    show: { animation: { duration: 0 } },
                    hide: { animation: { duration: 0 } }
                };
            } else {
                // Enable smooth animations for users who haven't opted out
                Chart.defaults.animation = {
                    duration: 400,
                    easing: 'easeInOutQuart'
                };
            }

            const range = document.getElementById('analytics-range').value;
            const activeMigraines = getActiveMigraines();

            // Filter data by range
            let startDate;
            const endDate = new Date();

            if (range === 'all') {
                startDate = new Date(0); // Beginning of time
            } else {
                const days = parseInt(range);
                startDate = new Date(endDate - days * 24 * 60 * 60 * 1000);
            }

            const filteredData = activeMigraines.filter(m => {
                const date = new Date(m.startTime);
                return date >= startDate && date <= endDate;
            });

            // Calculate and display metrics
            updateAnalyticsMetrics(filteredData, startDate, endDate);

            // Render charts
            renderFrequencyChart(filteredData, startDate, endDate);
            renderPainChart(filteredData);
            renderTimeChart(filteredData);
            renderDayOfWeekChart(filteredData);

            // Render weather-related analytics if enabled
            if (weatherData.enabled && weatherData.history.length >= 7) {
                renderWeatherCorrelation(filteredData);
                renderPressureChart(filteredData, startDate, endDate);
            } else {
                // Hide weather analytics if not enabled or insufficient data
                document.getElementById('weather-correlation-card').style.display = 'none';
                document.getElementById('pressure-chart-card').style.display = 'none';
            }

            // Render medication analytics if any medication data exists
            renderMedicationAnalytics(filteredData);
        }

        function updateAnalyticsMetrics(data, startDate, endDate) {
            // Count unique migraine days (including multi-day attacks)
            const migraineDays = new Set();
            data.forEach(m => {
                const days = getMigraineDays(m);
                days.forEach(day => migraineDays.add(day));
            });

            const totalDays = migraineDays.size;
            const daysInRange = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const monthsInRange = daysInRange / 30;
            const avgPerMonth = monthsInRange > 0 ? (totalDays / monthsInRange).toFixed(1) : 0;

            const avgPain = data.length > 0
                ? (data.reduce((sum, m) => sum + m.painLevel, 0) / data.length).toFixed(1)
                : 0;

            const avgDuration = data.length > 0
                ? data.reduce((sum, m) => sum + (m.duration || 0), 0) / data.length
                : 0;

            document.getElementById('analytics-total-days').textContent = totalDays;
            document.getElementById('analytics-avg-month').textContent = avgPerMonth;
            document.getElementById('analytics-avg-pain').textContent = `${avgPain}/10`;
            document.getElementById('analytics-avg-duration').textContent = formatDuration(Math.floor(avgDuration));
        }

        function renderFrequencyChart(data, startDate, endDate) {
            const canvas = document.getElementById('frequency-chart');
            const ctx = canvas.getContext('2d');

            // Destroy existing chart
            if (analyticsCharts.frequency) {
                analyticsCharts.frequency.destroy();
            }

            // Group data by month (including multi-day attacks)
            const monthlyData = {};
            data.forEach(m => {
                const days = getMigraineDays(m);
                days.forEach(day => {
                    const date = new Date(day + 'T00:00:00');
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = new Set();
                    }
                    monthlyData[monthKey].add(day);
                });
            });

            // Generate labels for all months in range
            const labels = [];
            const values = [];
            const current = new Date(startDate);
            current.setDate(1);

            while (current <= endDate) {
                const monthKey = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}`;
                const label = current.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                labels.push(label);
                values.push(monthlyData[monthKey] ? monthlyData[monthKey].size : 0);
                current.setMonth(current.getMonth() + 1);
            }

            const colors = getChartColors();

            analyticsCharts.frequency = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Migraine Days',
                        data: values,
                        borderColor: colors.primary,
                        backgroundColor: colors.primaryBg,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: colors.textSecondary
                            },
                            grid: {
                                color: colors.grid
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 5,
                                color: colors.textSecondary
                            },
                            grid: {
                                color: colors.grid
                            },
                            title: {
                                display: true,
                                text: 'Days per Month',
                                color: colors.text
                            }
                        }
                    }
                }
            });
        }

        function renderPainChart(data) {
            const canvas = document.getElementById('pain-chart');
            const ctx = canvas.getContext('2d');

            if (analyticsCharts.pain) {
                analyticsCharts.pain.destroy();
            }

            const mild = data.filter(m => m.painLevel <= 3).length;
            const moderate = data.filter(m => m.painLevel >= 4 && m.painLevel <= 6).length;
            const severe = data.filter(m => m.painLevel >= 7).length;

            const colors = getChartColors();

            analyticsCharts.pain = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Mild (0-3)', 'Moderate (4-6)', 'Severe (7-10)'],
                    datasets: [{
                        data: [mild, moderate, severe],
                        backgroundColor: [
                            colors.green,
                            colors.yellow,
                            colors.red
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: colors.text,
                                padding: 12,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderTimeChart(data) {
            const canvas = document.getElementById('time-chart');
            const ctx = canvas.getContext('2d');

            if (analyticsCharts.time) {
                analyticsCharts.time.destroy();
            }

            // Group by time of day (4-hour blocks)
            const timeBlocks = {
                'Night (12am-4am)': 0,
                'Early Morning (4am-8am)': 0,
                'Morning (8am-12pm)': 0,
                'Afternoon (12pm-4pm)': 0,
                'Evening (4pm-8pm)': 0,
                'Night (8pm-12am)': 0
            };

            data.forEach(m => {
                const hour = new Date(m.startTime).getHours();
                if (hour >= 0 && hour < 4) timeBlocks['Night (12am-4am)']++;
                else if (hour >= 4 && hour < 8) timeBlocks['Early Morning (4am-8am)']++;
                else if (hour >= 8 && hour < 12) timeBlocks['Morning (8am-12pm)']++;
                else if (hour >= 12 && hour < 16) timeBlocks['Afternoon (12pm-4pm)']++;
                else if (hour >= 16 && hour < 20) timeBlocks['Evening (4pm-8pm)']++;
                else timeBlocks['Night (8pm-12am)']++;
            });

            const colors = getChartColors();

            analyticsCharts.time = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(timeBlocks),
                    datasets: [{
                        label: 'Number of Migraines',
                        data: Object.values(timeBlocks),
                        backgroundColor: colors.primaryBg.replace('0.2', '0.6'),
                        borderColor: colors.primary,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: colors.textSecondary
                            },
                            grid: {
                                color: colors.grid
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                color: colors.textSecondary
                            },
                            grid: {
                                color: colors.grid
                            }
                        }
                    }
                }
            });
        }

        function renderDayOfWeekChart(data) {
            const canvas = document.getElementById('dow-chart');
            const ctx = canvas.getContext('2d');

            if (analyticsCharts.dow) {
                analyticsCharts.dow.destroy();
            }

            const dowCounts = {
                'Sunday': 0,
                'Monday': 0,
                'Tuesday': 0,
                'Wednesday': 0,
                'Thursday': 0,
                'Friday': 0,
                'Saturday': 0
            };

            data.forEach(m => {
                const dayName = new Date(m.startTime).toLocaleDateString('en-US', { weekday: 'long' });
                dowCounts[dayName]++;
            });

            const colors = getChartColors();

            analyticsCharts.dow = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(dowCounts),
                    datasets: [{
                        label: 'Number of Migraines',
                        data: Object.values(dowCounts),
                        backgroundColor: colors.blue,
                        borderColor: colors.blue,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: colors.textSecondary
                            },
                            grid: {
                                color: colors.grid
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                color: colors.textSecondary
                            },
                            grid: {
                                color: colors.grid
                            }
                        }
                    }
                }
            });
        }

        function renderWeatherCorrelation(data) {
            const correlationCard = document.getElementById('weather-correlation-card');

            if (!weatherData.enabled || weatherData.history.length < 7) {
                correlationCard.style.display = 'none';
                return;
            }

            correlationCard.style.display = 'block';

            // Calculate correlation using existing function
            const correlation = calculateWeatherCorrelation();

            if (!correlation) {
                correlationCard.style.display = 'none';
                return;
            }

            // Update UI with correlation data
            document.getElementById('correlation-strength').textContent =
                `${correlation.percentage.toFixed(0)}%`;

            let strengthText = '';
            let strengthColor = '';

            if (correlation.level === 'strong') {
                strengthText = 'Strong Correlation';
                strengthColor = 'var(--pain-severe)';
            } else if (correlation.level === 'moderate') {
                strengthText = 'Moderate Correlation';
                strengthColor = 'var(--pain-moderate)';
            } else {
                strengthText = 'Weak Correlation';
                strengthColor = 'var(--pain-mild)';
            }

            document.getElementById('correlation-description').textContent = strengthText;
            document.getElementById('correlation-strength').style.color = strengthColor;

            document.getElementById('correlation-changes').textContent =
                `${correlation.significantChangeDays} days`;
            document.getElementById('correlation-migraines').textContent =
                `${correlation.migrainesOnChangeDays} days`;
            document.getElementById('correlation-percent').textContent =
                `${correlation.percentage.toFixed(1)}%`;
        }

        function renderPressureChart(data, startDate, endDate) {
            const chartCard = document.getElementById('pressure-chart-card');

            if (!weatherData.enabled || weatherData.history.length < 7) {
                chartCard.style.display = 'none';
                return;
            }

            chartCard.style.display = 'block';

            const canvas = document.getElementById('pressure-chart');
            const ctx = canvas.getContext('2d');

            if (analyticsCharts.pressure) {
                analyticsCharts.pressure.destroy();
            }

            // Prepare data: last 30 days of weather history
            const days = 30;
            const labels = [];
            const pressureData = [];
            const changeData = [];
            const migraineIndicators = [];

            // Get migraine days in the period
            const migraineDays = new Set();
            data.forEach(m => {
                const days = getMigraineDays(m);
                days.forEach(day => migraineDays.add(day));
            });

            // Build chart data from weather history
            const sortedHistory = [...weatherData.history].sort((a, b) =>
                new Date(a.date) - new Date(b.date)
            ).slice(-days);

            sortedHistory.forEach((entry, index) => {
                const date = new Date(entry.date);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

                // Use dailyAvg or fallback to pressure for old data
                const pressure = entry.dailyAvg || entry.pressure || 1013.25;
                pressureData.push(pressure);

                // Calculate 24h change
                if (index > 0) {
                    const prevPressure = sortedHistory[index - 1].dailyAvg || sortedHistory[index - 1].pressure || 1013.25;
                    const change = pressure - prevPressure;
                    changeData.push(change);
                } else {
                    changeData.push(0);
                }

                // Check if there was a migraine this day
                const dateKey = entry.date.split('T')[0];
                migraineIndicators.push(migraineDays.has(dateKey) ? pressure : null);
            });

            const colors = getChartColors();

            analyticsCharts.pressure = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Barometric Pressure (hPa)',
                            data: pressureData,
                            borderColor: colors.blue,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            pointRadius: 3,
                            pointBackgroundColor: colors.blue,
                            yAxisID: 'y'
                        },
                        {
                            label: '24h Change',
                            data: changeData,
                            borderColor: colors.orange,
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Migraine Days',
                            data: migraineIndicators,
                            type: 'bar',
                            backgroundColor: 'rgba(255, 99, 132, 0.3)',
                            borderColor: 'rgba(255, 99, 132, 0.7)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: colors.textSecondary,
                                boxWidth: 20,
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        if (context.datasetIndex === 0) {
                                            label += context.parsed.y.toFixed(1) + ' hPa';
                                        } else if (context.datasetIndex === 1) {
                                            label += (context.parsed.y > 0 ? '+' : '') +
                                                     context.parsed.y.toFixed(1) + ' hPa';
                                        } else {
                                            label = 'Migraine occurred';
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: colors.textSecondary,
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: colors.grid
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Pressure (hPa)',
                                color: colors.textSecondary
                            },
                            ticks: {
                                color: colors.textSecondary
                            },
                            grid: {
                                color: colors.grid
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '24h Change (hPa)',
                                color: colors.textSecondary
                            },
                            ticks: {
                                color: colors.textSecondary
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // ============================================
        // MEDICATION ANALYTICS
        // ============================================

        function renderMedicationAnalytics(data) {
            // Calculate medication statistics
            const stats = calculateMedicationStats(data);

            if (stats.totalMedications === 0) {
                // Hide medication analytics if no medication data
                document.getElementById('medication-effectiveness-card').style.display = 'none';
                document.getElementById('medication-usage-card').style.display = 'none';
                return;
            }

            // Show and render medication analytics
            document.getElementById('medication-effectiveness-card').style.display = 'block';
            document.getElementById('medication-usage-card').style.display = 'block';

            renderMedicationEffectiveness(stats);
            renderMedicationUsage(stats);
        }

        function calculateMedicationStats(data) {
            const medicationStats = {};
            let totalMedications = 0;

            // Process all migraines with medications
            data.forEach(migraine => {
                if (!migraine.medications || migraine.medications.length === 0) return;

                migraine.medications.forEach(med => {
                    const medName = med.name;
                    totalMedications++;

                    if (!medicationStats[medName]) {
                        medicationStats[medName] = {
                            name: medName,
                            type: med.type || 'unknown',
                            category: med.category || 'unknown',
                            uses: 0,
                            effectivenessRatings: [],
                            timeToReliefValues: [],
                            sideEffects: {},
                            daysUsed: new Set() // Track unique days for MOH
                        };
                    }

                    const stat = medicationStats[medName];
                    stat.uses++;

                    // Track day used for MOH calculation
                    const dayUsed = migraine.startTime.split('T')[0];
                    stat.daysUsed.add(dayUsed);

                    // Add effectiveness rating if exists
                    if (med.effectiveness) {
                        stat.effectivenessRatings.push(med.effectiveness);
                    }

                    // Add time to relief if exists
                    if (med.timeToRelief) {
                        stat.timeToReliefValues.push(med.timeToRelief);
                    }

                    // Track side effects
                    if (med.sideEffects && med.sideEffects.length > 0) {
                        med.sideEffects.forEach(effect => {
                            stat.sideEffects[effect] = (stat.sideEffects[effect] || 0) + 1;
                        });
                    }
                });
            });

            // Calculate averages
            Object.values(medicationStats).forEach(stat => {
                stat.avgEffectiveness = stat.effectivenessRatings.length > 0
                    ? (stat.effectivenessRatings.reduce((sum, val) => sum + val, 0) / stat.effectivenessRatings.length)
                    : null;

                stat.avgTimeToRelief = stat.timeToReliefValues.length > 0
                    ? (stat.timeToReliefValues.reduce((sum, val) => sum + val, 0) / stat.timeToReliefValues.length)
                    : null;
            });

            // Calculate MOH risk (medication overuse headache)
            const mohStats = calculateMOHRisk(data);

            return {
                totalMedications,
                medications: Object.values(medicationStats),
                mohRisk: mohStats
            };
        }

        function calculateMOHRisk(data) {
            // Calculate medication usage days per month for last 3 months
            const now = new Date();
            const months = [];

            for (let i = 0; i < 3; i++) {
                const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthKey = `${monthDate.getFullYear()}-${String(monthDate.getMonth() + 1).padStart(2, '0')}`;
                months.push({
                    key: monthKey,
                    name: monthDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }),
                    daysUsed: new Set()
                });
            }

            // Count days with abortive medication use
            data.forEach(migraine => {
                if (!migraine.medications || migraine.medications.length === 0) return;

                const hasAbortive = migraine.medications.some(med => med.type === 'abortive');
                if (!hasAbortive) return;

                const migraineDate = new Date(migraine.startTime);
                const monthKey = `${migraineDate.getFullYear()}-${String(migraineDate.getMonth() + 1).padStart(2, '0')}`;
                const dayKey = migraine.startTime.split('T')[0];

                const month = months.find(m => m.key === monthKey);
                if (month) {
                    month.daysUsed.add(dayKey);
                }
            });

            // Convert Sets to counts
            months.forEach(month => {
                month.count = month.daysUsed.size;
            });

            // Check if at risk (>10 days/month for 3 months)
            const atRisk = months.filter(m => m.count > 10).length >= 2;
            const currentMonthCount = months[0].count;

            return {
                atRisk,
                currentMonth: months[0],
                lastThreeMonths: months,
                threshold: 10
            };
        }

        function renderMedicationEffectiveness(stats) {
            const content = document.getElementById('medication-effectiveness-content');

            // Sort medications by average effectiveness (highest first)
            const sortedMeds = stats.medications
                .filter(med => med.avgEffectiveness !== null)
                .sort((a, b) => b.avgEffectiveness - a.avgEffectiveness);

            if (sortedMeds.length === 0) {
                content.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No effectiveness ratings yet. Rate medications after ending an episode to see analytics here.</p>';
                return;
            }

            const colors = getChartColors();

            content.innerHTML = sortedMeds.map(med => {
                const effectiveness = med.avgEffectiveness.toFixed(1);
                const percentage = (effectiveness / 5) * 100;
                const stars = '‚≠ê'.repeat(Math.round(effectiveness));
                const avgRelief = med.avgTimeToRelief
                    ? `${Math.round(med.avgTimeToRelief)} min`
                    : 'N/A';

                return `
                    <div style="margin-bottom: 24px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid ${med.type === 'abortive' ? 'var(--accent-blue)' : 'var(--accent-purple)'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <div style="font-weight: 600; font-size: 1.1rem;">${med.name}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">
                                    ${med.type === 'abortive' ? 'üéØ Abortive' : 'üõ°Ô∏è Preventive'} ‚Ä¢ ${med.uses} uses
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.3rem;">${stars}</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">${effectiveness}/5</div>
                            </div>
                        </div>

                        <div style="height: 8px; background: var(--bg-primary); border-radius: 4px; overflow: hidden; margin-bottom: 12px;">
                            <div style="height: 100%; width: ${percentage}%; background: var(--accent-gold); transition: width 0.3s;"></div>
                        </div>

                        <div style="display: flex; gap: 24px; font-size: 0.9rem; color: var(--text-secondary);">
                            <div>
                                <strong>Avg time to relief:</strong> ${avgRelief}
                            </div>
                            ${Object.keys(med.sideEffects).length > 0 ? `
                                <div>
                                    <strong>Common side effects:</strong> ${Object.keys(med.sideEffects).slice(0, 2).join(', ')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderMedicationUsage(stats) {
            const content = document.getElementById('medication-usage-content');
            const mohWarning = document.getElementById('moh-warning');

            // Check MOH risk and show warning if necessary
            if (stats.mohRisk.atRisk || stats.mohRisk.currentMonth.count > 10) {
                mohWarning.style.display = 'block';
                document.getElementById('moh-days-this-month').textContent = stats.mohRisk.currentMonth.count;

                const monthsHTML = stats.mohRisk.lastThreeMonths.map(month => {
                    const isWarning = month.count > 10;
                    return `<div style="color: ${isWarning ? '#dc2626' : 'var(--text-secondary)'}; padding: 4px 0;">
                        ${month.name}: <strong>${month.count} days</strong> ${isWarning ? '‚ö†Ô∏è' : ''}
                    </div>`;
                }).join('');

                document.getElementById('moh-three-months').innerHTML = monthsHTML;
            } else {
                mohWarning.style.display = 'none';
            }

            // Show medication usage list
            const sortedByUse = [...stats.medications].sort((a, b) => b.uses - a.uses);

            content.innerHTML = `
                <div style="margin-top: 16px;">
                    <h3 style="margin-bottom: 16px;">Medication Usage Frequency</h3>
                    ${sortedByUse.map(med => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 8px; border-left: 3px solid ${med.type === 'abortive' ? 'var(--accent-blue)' : 'var(--accent-purple)'};">
                            <div>
                                <div style="font-weight: 600;">${med.name}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 2px;">
                                    ${med.type === 'abortive' ? 'üéØ Abortive' : 'üõ°Ô∏è Preventive'}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600; font-size: 1.1rem;">${med.uses} uses</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">${med.daysUsed.size} days</div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div style="margin-top: 24px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                    <strong>‚ÑπÔ∏è About Medication Overuse Headache (MOH):</strong>
                    <p style="margin-top: 8px; color: var(--text-secondary); font-size: 0.9rem;">
                        Using abortive medication >10 days/month for >3 months can cause medication overuse headaches,
                        making migraines worse. If you're seeing this warning, please consult your doctor about preventive options.
                    </p>
                </div>
            `;
        }
    </script>

    <!-- Service Worker Registration with Update Detection -->
    <script>
        let newWorker;

        function showUpdateBanner() {
            const banner = document.getElementById('update-banner');
            const container = document.querySelector('.container');

            banner.style.display = 'block';
            container.classList.add('with-update-banner');

            console.log('‚ú® Update available! Showing banner.');
        }

        function hideUpdateBanner() {
            const banner = document.getElementById('update-banner');
            const container = document.querySelector('.container');

            banner.style.display = 'none';
            container.classList.remove('with-update-banner');
        }

        function updateApp() {
            if (newWorker) {
                console.log('‚ö° Updating app...');
                // Send message to skip waiting
                newWorker.postMessage({ type: 'SKIP_WAITING' });
            }
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered:', registration.scope);

                        // Immediately check for updates on load
                        registration.update().then(() => {
                            console.log('üîç Checked for updates');
                        });

                        // Check if there's already a waiting service worker
                        if (registration.waiting) {
                            newWorker = registration.waiting;
                            showUpdateBanner();
                        }

                        // Check for updates every hour
                        setInterval(() => {
                            console.log('‚è∞ Hourly update check...');
                            registration.update();
                        }, 60 * 60 * 1000);

                        // Listen for waiting service worker
                        registration.addEventListener('updatefound', () => {
                            console.log('üì¶ Update found!');
                            const installingWorker = registration.installing;

                            installingWorker.addEventListener('statechange', () => {
                                console.log('Service worker state:', installingWorker.state);
                                if (installingWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // New update available
                                        newWorker = installingWorker;
                                        showUpdateBanner();
                                    } else {
                                        // First time installation
                                        console.log('Service Worker installed for the first time');
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('‚ùå Service Worker registration failed:', error);
                    });

                // Listen for service worker controller change
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('üîÑ New service worker activated, reloading page...');
                    window.location.reload();
                });

                // Update button click handler
                document.getElementById('update-btn').addEventListener('click', () => {
                    updateApp();
                });

                // Dismiss button click handler
                document.getElementById('dismiss-update-btn').addEventListener('click', () => {
                    hideUpdateBanner();
                });
            });
        }
    </script>
</body>
</html>