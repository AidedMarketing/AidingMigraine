<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aiding Migraine</title>
    <style>
        /* ============================================
           AIDING MIGRAINE v1.5.0 - WEEK 3 POLISH
           ============================================ */

        /* === ROOT VARIABLES (DARK - DEFAULT) === */
        :root {
            --bg-primary: #1a1d24;
            --bg-secondary: #252930;
            --bg-tertiary: #2f3339;
            --text-primary: #e8e6e3;
            --text-secondary: #aca8a0;
            --border-color: #3a3f47;
            --accent-green: #7ba68a;
            --accent-red: #c96868;
            --accent-blue: #6b8bb8;
            --pain-mild: #7ba68a;
            --pain-moderate: #d4a574;
            --pain-severe: #c96868;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --radius: 12px;
            --transition: all 0.2s ease;
        }

        /* === LIGHT THEME OVERRIDE === */
        :root[data-theme="light"] {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8e8e8;
            --text-primary: #2a2a2a;
            --text-secondary: #666666;
            --border-color: #d0d0d0;
            --accent-green: #4a7c59;
            --accent-red: #b85050;
            --accent-blue: #4a6b9e;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* === BASE STYLES === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding-bottom: 80px;
            transition: var(--transition);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 24px;
            font-weight: 600;
            text-align: center;
        }

        h2 {
            font-size: 1.3rem;
            margin-bottom: 16px;
            font-weight: 500;
            text-align: center;
        }

        .section-card {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .active-episode-card {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 2px solid var(--accent-green);
        }

        .active-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .pulse-indicator {
            font-size: 1.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .active-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent-green);
        }

        .active-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            text-align: center;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: var(--transition);
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .pain-scale {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }

        .pain-btn {
            padding: 12px 8px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pain-btn:hover {
            background: var(--bg-secondary);
            transform: translateY(-2px);
        }

        .pain-btn.selected {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: white;
        }

        .pain-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .optional-details {
            margin: 20px 0;
        }

        .toggle-details-btn {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-details-btn:hover {
            background: var(--bg-secondary);
        }

        #details-arrow {
            transition: transform 0.2s ease;
        }

        #details-arrow.rotated {
            transform: rotate(-90deg);
        }

        .optional-details-content {
            padding-top: 16px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
        }

        .btn-primary {
            background: var(--accent-green);
            color: white;
        }

        .btn-primary:hover {
            background: #6a957a;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
        }

        .stat-box {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-green);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .stat-comparison {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .calendar-nav-btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .calendar-nav-btn:hover {
            background: var(--bg-secondary);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--bg-secondary);
        }

        .calendar-day.empty {
            background: transparent;
            cursor: default;
        }

        .calendar-day.today {
            border-color: var(--accent-blue);
        }

        .calendar-day.has-episode {
            font-weight: 600;
        }

        .calendar-day.mild {
            background: var(--pain-mild);
            color: white;
        }

        .calendar-day.moderate {
            background: var(--pain-moderate);
            color: white;
        }

        .calendar-day.severe {
            background: var(--pain-severe);
            color: white;
        }

        .calendar-day.active-indicator::after {
            content: '‚ö°';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.7rem;
        }

        .calendar-legend {
            display: flex;
            gap: 16px;
            justify-content: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .legend-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .legend-dot.mild {
            background: var(--pain-mild);
        }

        .legend-dot.moderate {
            background: var(--pain-moderate);
        }

        .legend-dot.severe {
            background: var(--pain-severe);
        }

        #history-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .history-item {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .history-item:hover {
            border-color: var(--accent-green);
            transform: translateX(4px);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .history-date {
            font-size: 1rem;
            font-weight: 600;
        }

        .history-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .history-details {
            display: flex;
            gap: 20px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .history-detail {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-green);
        }

        .history-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .history-actions button {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .settings-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .info-label {
            color: var(--text-secondary);
        }

        .info-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .settings-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .settings-btn {
            width: 100%;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .settings-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-green);
        }

        .settings-btn.danger {
            border-color: var(--accent-red);
        }

        .settings-btn.danger:hover {
            background: rgba(201, 104, 104, 0.1);
        }

        .btn-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-label {
            display: block;
            margin-bottom: 12px;
            font-weight: 500;
            text-align: center;
        }

        .theme-options {
            display: flex;
            gap: 12px;
        }

        .theme-btn {
            flex: 1;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .theme-btn:hover {
            background: var(--bg-secondary);
        }

        .theme-btn.active {
            border-color: var(--accent-green);
            background: var(--bg-secondary);
        }

        .theme-btn span:first-child {
            font-size: 1.5rem;
        }

        .theme-btn span:last-child {
            font-size: 0.9rem;
        }

        .app-info {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .nav-btn:hover {
            color: var(--text-primary);
        }

        .nav-btn.active {
            color: var(--accent-green);
        }

        .nav-icon {
            font-size: 1.5rem;
        }

        .nav-label {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.3rem;
            text-align: left;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
            line-height: 1.8;
        }

        .modal-body h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--accent-green);
        }

        .modal-body p {
            margin-bottom: 12px;
        }

        .modal-body ul {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .modal-actions {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-actions .btn {
            width: auto;
            min-width: 100px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 16px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .pain-scale {
                gap: 6px;
            }

            .pain-btn {
                min-height: 44px;
                font-size: 0.95rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .theme-options {
                flex-direction: column;
            }

            .theme-btn {
                flex-direction: row;
                justify-content: flex-start;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div id="log-page" class="page active">
            <h1>Aiding Migraine</h1>
            
            <div id="active-episode-section" style="display: none;">
                <div class="active-episode-card">
                    <div class="active-header">
                        <span class="pulse-indicator">‚ö°</span>
                        <h2>Active Episode</h2>
                    </div>
                    <div class="active-stats">
                        <div class="stat-item">
                            <span class="stat-label">Duration</span>
                            <span id="active-duration" class="stat-value">0h 0m</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Pain Level</span>
                            <span id="active-pain-display" class="stat-value">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Category</span>
                            <span id="active-category" class="stat-value">-</span>
                        </div>
                    </div>
                    <div class="active-actions">
                        <button id="update-pain-btn" class="btn btn-secondary">Update Pain Level</button>
                        <button id="end-episode-btn" class="btn btn-primary">End Episode</button>
                    </div>
                </div>
            </div>

            <div id="logging-section">
                <div class="section-card">
                    <h2>Log New Episode</h2>
                    
                    <div class="form-group">
                        <label>Pain Intensity</label>
                        <div class="pain-scale">
                            <button class="pain-btn" data-pain="0">0</button>
                            <button class="pain-btn" data-pain="1">1</button>
                            <button class="pain-btn" data-pain="2">2</button>
                            <button class="pain-btn" data-pain="3">3</button>
                            <button class="pain-btn" data-pain="4">4</button>
                            <button class="pain-btn" data-pain="5">5</button>
                            <button class="pain-btn" data-pain="6">6</button>
                            <button class="pain-btn" data-pain="7">7</button>
                            <button class="pain-btn" data-pain="8">8</button>
                            <button class="pain-btn" data-pain="9">9</button>
                            <button class="pain-btn" data-pain="10">10</button>
                        </div>
                        <div class="pain-labels">
                            <span>No Pain</span>
                            <span>Worst Pain</span>
                        </div>
                    </div>

                    <div class="optional-details">
                        <button id="toggle-details-btn" class="toggle-details-btn">
                            <span id="details-arrow">‚ñº</span> Optional Details
                        </button>
                        <div id="optional-details-content" class="optional-details-content" style="display: none;">
                            <div class="form-group">
                                <label>üíä Medication (optional)</label>
                                <input type="text" id="medication-input" placeholder="e.g. Sumatriptan 100mg" />
                            </div>
                            
                            <div class="form-group">
                                <label>Quick Notes (optional)</label>
                                <textarea id="notes-input" placeholder="Add any notes about this episode..." rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button id="clear-btn" class="btn btn-secondary">Clear</button>
                        <button id="log-btn" class="btn btn-primary">Log Episode</button>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h2>Your Stats</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-number" id="total-episodes">0</div>
                        <div class="stat-label">Episodes</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="avg-pain">0</div>
                        <div class="stat-label">Avg Pain</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="week-count">0</div>
                        <div class="stat-label">This Week</div>
                        <div class="stat-comparison" id="week-comparison"></div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="last-episode">-</div>
                        <div class="stat-label">Last Episode</div>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h2>Calendar View</h2>
                <div class="calendar-header">
                    <button id="prev-month" class="calendar-nav-btn">‚Üê</button>
                    <h3 id="current-month"></h3>
                    <button id="next-month" class="calendar-nav-btn">‚Üí</button>
                </div>
                <div id="calendar-grid" class="calendar-grid"></div>
                <div class="calendar-legend">
                    <span><span class="legend-dot mild"></span> Mild (0-3)</span>
                    <span><span class="legend-dot moderate"></span> Moderate (4-6)</span>
                    <span><span class="legend-dot severe"></span> Severe (7-10)</span>
                </div>
            </div>
        </div>

        <div id="history-page" class="page">
            <h1>Episode History</h1>
            <div id="history-list"></div>
        </div>

        <div id="settings-page" class="page">
            <h1>Settings</h1>

            <div class="section-card">
                <h2>üìä Storage & Backup</h2>
                <div class="settings-info">
                    <div class="info-row">
                        <span class="info-label">Episodes:</span>
                        <span class="info-value" id="storage-episodes">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Storage Used:</span>
                        <span class="info-value" id="storage-size">0 KB</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">In Trash:</span>
                        <span class="info-value" id="trash-count">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Last Backup:</span>
                        <span class="info-value" id="last-backup">Never</span>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h2>üóëÔ∏è Recently Deleted</h2>
                <div class="settings-info" style="margin-bottom: 16px;">
                    <p style="text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                        Deleted episodes are kept for 30 days before being permanently removed.
                    </p>
                </div>
                <div class="settings-actions">
                    <button class="settings-btn" id="view-trash-btn">
                        <span>üóëÔ∏è View Trash</span>
                        <span class="btn-subtitle" id="trash-subtitle">0 items</span>
                    </button>
                </div>
            </div>

            <div class="section-card">
                <h2>üíæ Data Management</h2>
                <div class="settings-actions">
                    <button class="settings-btn" id="export-json-btn">
                        <span>üì§ Export as JSON</span>
                        <span class="btn-subtitle">Full backup</span>
                    </button>
                    <button class="settings-btn" id="export-pdf-btn">
                        <span>üìÑ Export as PDF</span>
                        <span class="btn-subtitle">Doctor report</span>
                    </button>
                    <button class="settings-btn" id="import-json-btn">
                        <span>üì• Import from JSON</span>
                        <span class="btn-subtitle">Restore backup</span>
                    </button>
                </div>
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
            </div>

            <div class="section-card">
                <h2>üé® Appearance</h2>
                <div class="settings-group">
                    <label class="settings-label">Theme</label>
                    <div class="theme-options">
                        <button class="theme-btn" data-theme="auto">
                            <span>üåì</span>
                            <span>Auto</span>
                        </button>
                        <button class="theme-btn active" data-theme="dark">
                            <span>üåô</span>
                            <span>Dark</span>
                        </button>
                        <button class="theme-btn" data-theme="light">
                            <span>‚òÄÔ∏è</span>
                            <span>Light</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h2>‚ÑπÔ∏è Information</h2>
                <div class="settings-actions">
                    <button class="settings-btn" id="tour-btn">
                        <span>üéØ Take a Tour</span>
                        <span class="btn-subtitle">Interactive walkthrough</span>
                    </button>
                    <button class="settings-btn" id="how-to-btn">
                        <span>üìñ How to Use</span>
                    </button>
                    <button class="settings-btn" id="about-btn">
                        <span>üì± About This App</span>
                    </button>
                    <button class="settings-btn" id="privacy-btn">
                        <span>üîí Privacy & Your Data</span>
                    </button>
                </div>
            </div>

            <div class="section-card">
                <h2>‚ö†Ô∏è Advanced</h2>
                <div class="settings-actions">
                    <button class="settings-btn danger" id="clear-all-btn">
                        <span>üóëÔ∏è Clear All Data</span>
                        <span class="btn-subtitle">Cannot be undone</span>
                    </button>
                </div>
            </div>

            <div class="app-info">
                <p>Aiding Migraine v1.5.0</p>
                <p>Built with care for migraine sufferers</p>
            </div>
        </div>

        <nav class="bottom-nav">
            <button class="nav-btn active" data-page="log">
                <span class="nav-icon">üìù</span>
                <span class="nav-label">Log</span>
            </button>
            <button class="nav-btn" data-page="history">
                <span class="nav-icon">üìä</span>
                <span class="nav-label">History</span>
            </button>
            <button class="nav-btn" data-page="settings">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-label">Settings</span>
            </button>
        </nav>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-actions" id="modal-actions"></div>
        </div>
    </div>

    <script>
        let migraines = [];
        let selectedPain = null;
        let activeMigraine = null;
        let durationInterval = null;
        let currentMonth = new Date();
        let currentPage = 'log';

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            purgeOldDeletedEpisodes();
            initializeTheme();
            initializeNavigation();
            initializePainScale();
            initializeLogging();
            initializeHistory();
            initializeCalendar();
            initializeSettings();
            checkActiveMigraine();
            updateDashboard();
            renderHistory();
            renderCalendar();
            checkFirstTimeUser();
        });

        function loadData() {
            const stored = localStorage.getItem('migraines');
            if (stored) {
                migraines = JSON.parse(stored);
            }
            const active = localStorage.getItem('activeMigraine');
            if (active) {
                activeMigraine = JSON.parse(active);
            }
        }

        function saveData() {
            localStorage.setItem('migraines', JSON.stringify(migraines));
            if (activeMigraine) {
                localStorage.setItem('activeMigraine', JSON.stringify(activeMigraine));
            } else {
                localStorage.removeItem('activeMigraine');
            }
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
            
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === savedTheme) {
                    btn.classList.add('active');
                }
            });

            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const theme = btn.dataset.theme;
                    applyTheme(theme);
                    localStorage.setItem('theme', theme);
                    
                    document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
        }

        function applyTheme(theme) {
            if (theme === 'auto') {
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }
        }

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            const currentTheme = localStorage.getItem('theme') || 'dark';
            if (currentTheme === 'auto') {
                applyTheme('auto');
            }
        });

        function initializeNavigation() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const page = btn.dataset.page;
                    showPage(page);
                });
            });
        }

        function showPage(pageName) {
            currentPage = pageName;
            
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`${pageName}-page`).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.page === pageName) {
                    btn.classList.add('active');
                }
            });
            
            if (pageName === 'history') {
                renderHistory();
            } else if (pageName === 'settings') {
                updateStorageInfo();
            } else if (pageName === 'log') {
                renderCalendar();
            }
        }

        function initializePainScale() {
            document.querySelectorAll('.pain-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectedPain = parseInt(btn.dataset.pain);
                    document.querySelectorAll('.pain-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                });
            });
        }

        document.getElementById('toggle-details-btn')?.addEventListener('click', () => {
            const content = document.getElementById('optional-details-content');
            const arrow = document.getElementById('details-arrow');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.classList.add('rotated');
            } else {
                content.style.display = 'none';
                arrow.classList.remove('rotated');
            }
        });

        function initializeLogging() {
            document.getElementById('log-btn').addEventListener('click', logEpisode);
            document.getElementById('clear-btn').addEventListener('click', clearForm);
            document.getElementById('update-pain-btn')?.addEventListener('click', updateActivePain);
            document.getElementById('end-episode-btn')?.addEventListener('click', endActiveMigraine);
        }

        function logEpisode() {
            if (selectedPain === null) {
                showModal('Error', 'Please select a pain level.');
                return;
            }

            if (activeMigraine) {
                showModal('Error', 'You already have an active episode. Please end it first.');
                return;
            }

            const medication = document.getElementById('medication-input').value.trim();
            const notes = document.getElementById('notes-input').value.trim();

            const migraine = {
                id: Date.now(),
                startTime: new Date().toISOString(),
                painLevel: selectedPain,
                painHistory: [{ timestamp: new Date().toISOString(), level: selectedPain }],
                status: 'active',
                notes: notes,
                medication: medication || null,
                category: getPainCategory(selectedPain)
            };

            activeMigraine = migraine;
            saveData();
            startDurationTracking();
            checkActiveMigraine();
            clearForm();
            updateDashboard();
            renderCalendar();
            
            showModal('Episode Logged', 'Your migraine episode has been logged and is now being tracked.');
        }

        function clearForm() {
            selectedPain = null;
            document.querySelectorAll('.pain-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('notes-input').value = '';
            document.getElementById('medication-input').value = '';
        }

        function updateActivePain() {
            if (!activeMigraine) return;

            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            
            body.innerHTML = `
                <div class="form-group">
                    <label>New Pain Level</label>
                    <div class="pain-scale">
                        ${[0,1,2,3,4,5,6,7,8,9,10].map(i => 
                            `<button class="pain-btn" data-pain="${i}">${i}</button>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="confirm-pain-update">Update</button>
            `;
            
            document.getElementById('modal-title').textContent = 'Update Pain Level';
            modal.classList.add('active');
            
            body.querySelectorAll('.pain-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    body.querySelectorAll('.pain-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                });
            });
            
            document.getElementById('confirm-pain-update').addEventListener('click', () => {
                const selected = body.querySelector('.pain-btn.selected');
                if (selected) {
                    const newPain = parseInt(selected.dataset.pain);
                    activeMigraine.painHistory.push({
                        timestamp: new Date().toISOString(),
                        level: newPain
                    });
                    activeMigraine.painLevel = newPain;
                    activeMigraine.category = getPainCategory(newPain);
                    saveData();
                    updateActiveMigraineeDisplay();
                    closeModal();
                    showModal('Pain Updated', `Pain level updated to ${newPain}/10`);
                }
            });
        }

        function endActiveMigraine() {
            if (!activeMigraine) return;

            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            
            body.innerHTML = `
                <p>End this migraine episode?</p>
                <div class="form-group" style="margin-top: 16px;">
                    <label>Final Notes (optional)</label>
                    <textarea id="end-notes" placeholder="How did it resolve? What helped?" rows="3"></textarea>
                </div>
            `;
            
            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="confirm-end">End Episode</button>
            `;
            
            document.getElementById('modal-title').textContent = 'End Episode';
            modal.classList.add('active');
            
            document.getElementById('confirm-end').addEventListener('click', () => {
                const endNotes = document.getElementById('end-notes').value.trim();
                
                activeMigraine.endTime = new Date().toISOString();
                activeMigraine.status = 'completed';
                activeMigraine.endNotes = endNotes;
                activeMigraine.duration = Math.floor((new Date(activeMigraine.endTime) - new Date(activeMigraine.startTime)) / 1000);
                
                migraines.push(activeMigraine);
                activeMigraine = null;
                
                stopDurationTracking();
                saveData();
                checkActiveMigraine();
                updateDashboard();
                renderHistory();
                renderCalendar();
                closeModal();
                
                showModal('Episode Ended', 'Your migraine episode has been saved to history.');
            });
        }

        function checkActiveMigraine() {
            const section = document.getElementById('active-episode-section');
            const logging = document.getElementById('logging-section');
            
            if (activeMigraine) {
                section.style.display = 'block';
                logging.style.display = 'none';
                updateActiveMigraineeDisplay();
                startDurationTracking();
            } else {
                section.style.display = 'none';
                logging.style.display = 'block';
                stopDurationTracking();
            }
        }

        function updateActiveMigraineeDisplay() {
            if (!activeMigraine) return;
            
            document.getElementById('active-pain-display').textContent = `${activeMigraine.painLevel}/10`;
            document.getElementById('active-category').textContent = activeMigraine.category;
            updateDuration();
        }

        function startDurationTracking() {
            stopDurationTracking();
            updateDuration();
            durationInterval = setInterval(updateDuration, 60000);
        }

        function stopDurationTracking() {
            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }
        }

        function updateDuration() {
            if (!activeMigraine) return;
            
            const start = new Date(activeMigraine.startTime);
            const now = new Date();
            const diff = now - start;
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            document.getElementById('active-duration').textContent = `${hours}h ${minutes}m`;
        }

        function updateDashboard() {
            const activeMigraines = getActiveMigraines();
            const total = activeMigraines.length;
            const avgPain = total > 0
                ? (activeMigraines.reduce((sum, m) => sum + m.painLevel, 0) / total).toFixed(1)
                : 0;

            const now = new Date();
            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            const twoWeeksAgo = new Date(now - 14 * 24 * 60 * 60 * 1000);

            const thisWeek = activeMigraines.filter(m => new Date(m.startTime) >= weekAgo).length;
            const lastWeek = activeMigraines.filter(m => {
                const date = new Date(m.startTime);
                return date >= twoWeeksAgo && date < weekAgo;
            }).length;

            const lastEpisode = total > 0
                ? formatRelativeTime(activeMigraines[activeMigraines.length - 1].startTime)
                : '-';
            
            document.getElementById('total-episodes').textContent = total;
            document.getElementById('avg-pain').textContent = avgPain;
            document.getElementById('week-count').textContent = thisWeek;
            document.getElementById('last-episode').textContent = lastEpisode;
            
            const comparison = document.getElementById('week-comparison');
            if (lastWeek > 0) {
                const diff = thisWeek - lastWeek;
                if (diff > 0) {
                    comparison.textContent = `‚Üë +${diff} from last week`;
                    comparison.style.color = 'var(--accent-red)';
                } else if (diff < 0) {
                    comparison.textContent = `‚Üì ${diff} from last week`;
                    comparison.style.color = 'var(--accent-green)';
                } else {
                    comparison.textContent = `‚Üí Same as last week`;
                    comparison.style.color = 'var(--text-secondary)';
                }
            } else {
                comparison.textContent = '';
            }
        }

        function initializeHistory() {}

        function renderHistory() {
            const list = document.getElementById('history-list');
            const activeMigraines = getActiveMigraines();

            if (activeMigraines.length === 0) {
                list.innerHTML = `
                    <div class="section-card" style="text-align: center; padding: 40px;">
                        <h2>üìä No Episodes Yet</h2>
                        <p style="color: var(--text-secondary); margin-top: 12px;">
                            Your migraine history will appear here after you log your first episode.
                        </p>
                    </div>
                `;
                return;
            }

            const sorted = [...activeMigraines].reverse();
            
            list.innerHTML = sorted.map(m => {
                const start = new Date(m.startTime);
                const painProgress = getPainProgression(m);
                
                return `
                    <div class="history-item">
                        <div class="history-header">
                            <div>
                                <div class="history-date">${formatDate(start)}</div>
                                <div class="history-time">${formatTime(start)}</div>
                            </div>
                        </div>
                        <div class="history-details">
                            <div class="history-detail">
                                <span class="detail-label">Pain</span>
                                <span class="detail-value">${painProgress}</span>
                            </div>
                            <div class="history-detail">
                                <span class="detail-label">Duration</span>
                                <span class="detail-value">${formatDuration(m.duration)}</span>
                            </div>
                            <div class="history-detail">
                                <span class="detail-label">Category</span>
                                <span class="detail-value">${m.category}</span>
                            </div>
                        </div>
                        ${m.notes ? `<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 8px;">${m.notes}</p>` : ''}
                        <div class="history-actions">
                            <button class="btn btn-secondary" onclick="viewEpisode(${m.id})">View Details</button>
                            <button class="btn btn-secondary" onclick="editEpisode(${m.id})">Edit</button>
                            <button class="btn btn-secondary" onclick="deleteEpisode(${m.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewEpisode(id) {
            const migraine = migraines.find(m => m.id === id);
            if (!migraine) return;
            
            const start = new Date(migraine.startTime);
            const end = migraine.endTime ? new Date(migraine.endTime) : null;
            
            let content = `
                <p><strong>Started:</strong> ${formatDate(start)} at ${formatTime(start)}</p>
                ${end ? `<p><strong>Ended:</strong> ${formatDate(end)} at ${formatTime(end)}</p>` : ''}
                <p><strong>Duration:</strong> ${formatDuration(migraine.duration)}</p>
                <p><strong>Pain Level:</strong> ${migraine.painLevel}/10 (${migraine.category})</p>
                ${migraine.medication ? `<p><strong>Medication:</strong> ${migraine.medication}</p>` : ''}
            `;
            
            if (migraine.painHistory && migraine.painHistory.length > 1) {
                content += `<h3>Pain Progression</h3><ul>`;
                migraine.painHistory.forEach(p => {
                    content += `<li>${formatTime(new Date(p.timestamp))}: ${p.level}/10</li>`;
                });
                content += `</ul>`;
            }
            
            if (migraine.notes) {
                content += `<h3>Notes</h3><p>${migraine.notes}</p>`;
            }
            
            if (migraine.endNotes) {
                content += `<h3>Resolution Notes</h3><p>${migraine.endNotes}</p>`;
            }
            
            showModal('Episode Details', content);
        }

        function editEpisode(id) {
            const migraine = migraines.find(m => m.id === id);
            if (!migraine) return;

            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            body.innerHTML = `
                <div class="form-group">
                    <label>üíä Medication</label>
                    <input type="text" id="edit-medication" value="${migraine.medication || ''}"
                           placeholder="e.g. Sumatriptan 100mg"
                           style="width: 100%; padding: 12px; background: var(--bg-tertiary);
                                  border: 1px solid var(--border-color); border-radius: 8px;
                                  color: var(--text-primary); font-size: 1rem;">
                </div>
                <div class="form-group">
                    <label>üìù Notes</label>
                    <textarea id="edit-notes" rows="4" placeholder="Add any notes about this episode..."
                              style="width: 100%; padding: 12px; background: var(--bg-tertiary);
                                     border: 1px solid var(--border-color); border-radius: 8px;
                                     color: var(--text-primary); font-size: 1rem; resize: vertical; min-height: 80px;">${migraine.notes || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>üèÅ Resolution Notes</label>
                    <textarea id="edit-end-notes" rows="3" placeholder="How did it resolve? What helped?"
                              style="width: 100%; padding: 12px; background: var(--bg-tertiary);
                                     border: 1px solid var(--border-color); border-radius: 8px;
                                     color: var(--text-primary); font-size: 1rem; resize: vertical; min-height: 80px;">${migraine.endNotes || ''}</textarea>
                </div>
            `;

            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEpisodeEdit(${id})">Save Changes</button>
            `;

            document.getElementById('modal-title').textContent = 'Edit Episode';
            modal.classList.add('active');
        }

        function saveEpisodeEdit(id) {
            const migraine = migraines.find(m => m.id === id);
            if (!migraine) return;

            const medication = document.getElementById('edit-medication').value.trim();
            const notes = document.getElementById('edit-notes').value.trim();
            const endNotes = document.getElementById('edit-end-notes').value.trim();

            migraine.medication = medication || null;
            migraine.notes = notes || null;
            migraine.endNotes = endNotes || null;

            saveData();
            renderHistory();
            closeModal();
            showModal('Changes Saved', 'Episode has been updated successfully.');
        }

        function deleteEpisode(id) {
            const modal = document.getElementById('modal');
            document.getElementById('modal-title').textContent = 'Delete Episode?';
            document.getElementById('modal-body').innerHTML = '<p>This episode will be moved to trash and can be recovered within 30 days.</p>';
            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmDelete(${id})">Move to Trash</button>
            `;
            modal.classList.add('active');
        }

        function confirmDelete(id) {
            const migraine = migraines.find(m => m.id === id);
            if (migraine) {
                migraine.deleted = true;
                migraine.deletedAt = new Date().toISOString();
                saveData();
                renderHistory();
                updateDashboard();
                renderCalendar();
                closeModal();
                showModal('Moved to Trash', 'Episode moved to trash. You can restore it from Settings within 30 days.');
            }
        }

        function getActiveMigraines() {
            return migraines.filter(m => !m.deleted);
        }

        function getDeletedMigraines() {
            // Auto-purge episodes older than 30 days
            const now = new Date();
            const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);

            return migraines.filter(m => {
                if (!m.deleted) return false;
                const deletedDate = new Date(m.deletedAt);
                return deletedDate >= thirtyDaysAgo;
            });
        }

        function purgeOldDeletedEpisodes() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);

            const beforeCount = migraines.length;
            migraines = migraines.filter(m => {
                if (!m.deleted) return true;
                const deletedDate = new Date(m.deletedAt);
                return deletedDate >= thirtyDaysAgo;
            });

            const purgedCount = beforeCount - migraines.length;
            if (purgedCount > 0) {
                saveData();
            }
        }

        function viewTrash() {
            const deletedMigraines = getDeletedMigraines();

            if (deletedMigraines.length === 0) {
                showModal('Trash Empty', '<p style="text-align: center;">No recently deleted episodes.</p>');
                return;
            }

            const now = new Date();

            let content = `
                <div style="margin-bottom: 20px;">
                    <p style="text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                        Episodes are automatically deleted after 30 days.
                    </p>
                </div>
            `;

            deletedMigraines
                .sort((a, b) => new Date(b.deletedAt) - new Date(a.deletedAt))
                .forEach(m => {
                    const deletedDate = new Date(m.deletedAt);
                    const daysRemaining = Math.ceil(30 - (now - deletedDate) / (1000 * 60 * 60 * 24));
                    const startDate = new Date(m.startTime);

                    content += `
                        <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border-left: 4px solid ${
                            m.category === 'Severe' ? 'var(--pain-severe)' :
                            m.category === 'Moderate' ? 'var(--pain-moderate)' :
                            'var(--pain-mild)'
                        };">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div>
                                    <p style="font-weight: 600; margin-bottom: 4px;">${formatDate(startDate)}</p>
                                    <p style="font-size: 0.9rem; color: var(--text-secondary);">
                                        ${formatTime(startDate)} ‚Ä¢ ${m.category} (${m.painLevel}/10)
                                    </p>
                                </div>
                                <span style="font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap;">
                                    ${daysRemaining} day${daysRemaining !== 1 ? 's' : ''} left
                                </span>
                            </div>
                            ${m.medication ? `<p style="font-size: 0.9rem; margin-bottom: 4px;">üíä ${m.medication}</p>` : ''}
                            ${m.notes ? `<p style="font-size: 0.9rem; margin-bottom: 4px;">üìù ${m.notes}</p>` : ''}
                            <div style="display: flex; gap: 8px; margin-top: 12px;">
                                <button class="btn btn-primary" style="flex: 1; padding: 8px;" onclick="restoreEpisode(${m.id})">
                                    ‚ôªÔ∏è Restore
                                </button>
                                <button class="btn btn-danger" style="flex: 1; padding: 8px;" onclick="permanentlyDelete(${m.id})">
                                    üóëÔ∏è Delete Forever
                                </button>
                            </div>
                        </div>
                    `;
                });

            content += `
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                    <button class="btn btn-danger" style="width: 100%;" onclick="emptyTrash()">
                        üóëÔ∏è Empty Trash (Delete All)
                    </button>
                </div>
            `;

            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            const actions = document.getElementById('modal-actions');

            document.getElementById('modal-title').textContent = `Trash (${deletedMigraines.length})`;
            body.innerHTML = content;
            actions.innerHTML = '<button class="btn btn-secondary" onclick="closeModal()">Close</button>';
            modal.classList.add('active');
        }

        function restoreEpisode(id) {
            const migraine = migraines.find(m => m.id === id);
            if (migraine && migraine.deleted) {
                delete migraine.deleted;
                delete migraine.deletedAt;
                saveData();
                renderHistory();
                updateDashboard();
                renderCalendar();
                updateStorageInfo();
                viewTrash(); // Refresh trash view
                showModal('Episode Restored', 'The episode has been restored successfully.');
            }
        }

        function permanentlyDelete(id) {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            const actions = document.getElementById('modal-actions');

            body.innerHTML = `
                <p style="text-align: center;">Are you sure you want to permanently delete this episode?</p>
                <p style="text-align: center; color: var(--accent-red); font-weight: 600;">This action cannot be undone.</p>
            `;

            actions.innerHTML = `
                <button class="btn btn-secondary" onclick="viewTrash()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmPermanentDelete(${id})">Delete Forever</button>
            `;

            document.getElementById('modal-title').textContent = 'Confirm Permanent Deletion';
        }

        function confirmPermanentDelete(id) {
            const index = migraines.findIndex(m => m.id === id);
            if (index !== -1) {
                migraines.splice(index, 1);
                saveData();
                updateStorageInfo();
                viewTrash(); // Refresh trash view
            }
        }

        function emptyTrash() {
            const deletedCount = getDeletedMigraines().length;

            if (deletedCount === 0) {
                showModal('Trash Empty', '<p style="text-align: center;">No episodes to delete.</p>');
                return;
            }

            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            const actions = document.getElementById('modal-actions');

            body.innerHTML = `
                <p style="text-align: center;">Are you sure you want to permanently delete all ${deletedCount} episode${deletedCount !== 1 ? 's' : ''} from trash?</p>
                <p style="text-align: center; color: var(--accent-red); font-weight: 600;">This action cannot be undone.</p>
            `;

            actions.innerHTML = `
                <button class="btn btn-secondary" onclick="viewTrash()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmEmptyTrash()">Empty Trash</button>
            `;

            document.getElementById('modal-title').textContent = 'Empty Trash';
        }

        function confirmEmptyTrash() {
            migraines = migraines.filter(m => !m.deleted);
            saveData();
            renderHistory();
            updateDashboard();
            renderCalendar();
            updateStorageInfo();
            closeModal();
            showModal('Trash Emptied', 'All deleted episodes have been permanently removed.');
        }

        function initializeCalendar() {
            document.getElementById('prev-month').addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() - 1);
                renderCalendar();
            });
            
            document.getElementById('next-month').addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
                renderCalendar();
            });
        }

        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            document.getElementById('current-month').textContent = 
                new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            let html = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => 
                `<div class="calendar-day empty" style="font-weight: 600;">${d}</div>`
            ).join('');
            
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            const activeMigraines = getActiveMigraines();

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];

                const dayMigraines = activeMigraines.filter(m => {
                    const mDate = new Date(m.startTime).toISOString().split('T')[0];
                    return mDate === dateStr;
                });
                
                let classes = 'calendar-day';
                if (dayMigraines.length > 0) {
                    classes += ' has-episode';
                    
                    const maxStartingPain = Math.max(...dayMigraines.map(m => {
                        if (m.painHistory && m.painHistory.length > 0) {
                            return m.painHistory[0].level;
                        }
                        return m.painLevel;
                    }));
                    
                    if (maxStartingPain <= 3) classes += ' mild';
                    else if (maxStartingPain <= 6) classes += ' moderate';
                    else classes += ' severe';
                }
                
                if (date.toDateString() === today.toDateString()) {
                    classes += ' today';
                }
                
                if (activeMigraine) {
                    const activeDate = new Date(activeMigraine.startTime).toISOString().split('T')[0];
                    if (dateStr === activeDate) {
                        classes += ' active-indicator';
                    }
                }
                
                html += `<div class="${classes}" onclick="showDayDetails('${dateStr}')">${day}</div>`;
            }
            
            document.getElementById('calendar-grid').innerHTML = html;
        }

        function showDayDetails(dateStr) {
            const activeMigraines = getActiveMigraines();
            const dayMigraines = activeMigraines.filter(m => {
                const mDate = new Date(m.startTime).toISOString().split('T')[0];
                return mDate === dateStr;
            });
            
            const date = new Date(dateStr + 'T00:00:00');
            
            if (dayMigraines.length === 0) {
                showModal(formatDate(date), '<p>No episodes logged on this day.</p>');
                return;
            }
            
            let content = dayMigraines.map(m => `
                <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                    <p><strong>${formatTime(new Date(m.startTime))}</strong></p>
                    <p>Pain: ${m.painLevel}/10 (${m.category})</p>
                    <p>Duration: ${formatDuration(m.duration)}</p>
                    ${m.medication ? `<p>Medication: ${m.medication}</p>` : ''}
                </div>
            `).join('');
            
            showModal(formatDate(date), content);
        }

        function initializeSettings() {
            updateStorageInfo();

            document.getElementById('export-json-btn').addEventListener('click', exportJSON);

            document.getElementById('export-pdf-btn').addEventListener('click', showPDFDateRangeModal);

            document.getElementById('import-json-btn').addEventListener('click', () => {
                document.getElementById('import-file-input').click();
            });

            document.getElementById('import-file-input').addEventListener('change', handleImport);

            document.getElementById('view-trash-btn').addEventListener('click', viewTrash);

            document.getElementById('tour-btn').addEventListener('click', () => {
                switchPage('log');
                startGuidedTour();
            });

            document.getElementById('how-to-btn').addEventListener('click', showHowTo);
            document.getElementById('about-btn').addEventListener('click', showAbout);
            document.getElementById('privacy-btn').addEventListener('click', showPrivacy);

            document.getElementById('clear-all-btn').addEventListener('click', clearAllData);
        }

        function updateStorageInfo() {
            const activeMigraines = getActiveMigraines();
            const deletedMigraines = getDeletedMigraines();
            const episodes = activeMigraines.length;
            const dataStr = JSON.stringify(migraines);
            const sizeBytes = new Blob([dataStr]).size;
            const sizeKB = (sizeBytes / 1024).toFixed(2);
            const lastBackup = localStorage.getItem('lastBackup') || 'Never';

            document.getElementById('storage-episodes').textContent = episodes;
            document.getElementById('storage-size').textContent = `${sizeKB} KB`;
            document.getElementById('last-backup').textContent = lastBackup;

            const trashCount = document.getElementById('trash-count');
            const trashSubtitle = document.getElementById('trash-subtitle');
            if (trashCount) {
                trashCount.textContent = deletedMigraines.length;
            }
            if (trashSubtitle) {
                const itemText = deletedMigraines.length === 1 ? 'item' : 'items';
                trashSubtitle.textContent = `${deletedMigraines.length} ${itemText}`;
            }
        }

        function exportJSON() {
            const activeMigraines = getActiveMigraines();
            const data = {
                appVersion: '1.5.0',
                exportDate: new Date().toISOString(),
                totalEpisodes: activeMigraines.length,
                migraines: activeMigraines
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aiding-migraine-backup-${formatDateFile(new Date())}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            localStorage.setItem('lastBackup', formatDate(new Date()));
            updateStorageInfo();
            
            showModal('Export Complete', 'Your data has been exported successfully.');
        }

        function handleImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);

                    if (!data.migraines || !Array.isArray(data.migraines)) {
                        throw new Error('Invalid backup file format');
                    }

                    // Analyze import data
                    const analysis = analyzeImportData(data.migraines);

                    // Show import review UI
                    showImportReviewModal(data.migraines, analysis);

                } catch (error) {
                    showModal('Import Failed', 'The file you selected is not a valid backup file.');
                }
            };
            reader.readAsText(file);

            e.target.value = '';
        }

        function analyzeImportData(importedEpisodes) {
            const newEpisodes = [];
            const duplicates = [];
            const conflicts = [];

            importedEpisodes.forEach(imported => {
                // Check for exact ID match
                const exactMatch = migraines.find(m => m.id === imported.id);

                if (exactMatch) {
                    // Check if data is identical or different
                    const isDifferent = JSON.stringify(exactMatch) !== JSON.stringify(imported);

                    if (isDifferent) {
                        conflicts.push({
                            imported: imported,
                            existing: exactMatch,
                            matchType: 'id'
                        });
                    } else {
                        duplicates.push({
                            imported: imported,
                            existing: exactMatch,
                            matchType: 'exact'
                        });
                    }
                } else {
                    // Check for timestamp proximity (within 1 minute)
                    const importTime = new Date(imported.startTime).getTime();
                    const proximityMatch = migraines.find(m => {
                        const existingTime = new Date(m.startTime).getTime();
                        const diff = Math.abs(importTime - existingTime);
                        return diff < 60000; // 1 minute
                    });

                    if (proximityMatch) {
                        // Similar timing - could be duplicate
                        conflicts.push({
                            imported: imported,
                            existing: proximityMatch,
                            matchType: 'time'
                        });
                    } else {
                        // Truly new episode
                        newEpisodes.push(imported);
                    }
                }
            });

            return {
                total: importedEpisodes.length,
                new: newEpisodes,
                duplicates: duplicates,
                conflicts: conflicts
            };
        }

        function showImportReviewModal(importedEpisodes, analysis) {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            let summaryHTML = `
                <p style="margin-bottom: 16px;">Found <strong>${analysis.total} episodes</strong> in backup file:</p>
                <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;">
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; display: flex; justify-content: space-between;">
                        <span>‚úÖ New Episodes:</span>
                        <strong style="color: var(--accent-green);">${analysis.new.length}</strong>
                    </div>
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; display: flex; justify-content: space-between;">
                        <span>üìã Exact Duplicates:</span>
                        <strong>${analysis.duplicates.length}</strong>
                    </div>
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; display: flex; justify-content: space-between;">
                        <span>‚ö†Ô∏è Conflicts:</span>
                        <strong style="color: var(--accent-red);">${analysis.conflicts.length}</strong>
                    </div>
                </div>
            `;

            if (analysis.conflicts.length > 0) {
                summaryHTML += `
                    <p style="color: var(--accent-red); margin-bottom: 12px;">
                        <strong>‚ö†Ô∏è Conflicts Detected</strong><br>
                        Some episodes have the same ID or similar timing but different data.
                    </p>
                `;
            }

            if (analysis.new.length === 0 && analysis.conflicts.length === 0) {
                summaryHTML += `<p style="color: var(--text-secondary);">All episodes already exist. Nothing new to import.</p>`;
            }

            body.innerHTML = summaryHTML;

            // Action buttons
            const actions = document.getElementById('modal-actions');

            if (analysis.new.length === 0 && analysis.conflicts.length === 0) {
                actions.innerHTML = `
                    <button class="btn btn-primary" onclick="closeModal()">Close</button>
                `;
            } else if (analysis.conflicts.length > 0) {
                actions.innerHTML = `
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-secondary" onclick="reviewConflicts(${JSON.stringify(analysis).replace(/"/g, '&quot;')})">Review Conflicts</button>
                    <button class="btn btn-primary" onclick="importWithStrategy(${JSON.stringify(analysis).replace(/"/g, '&quot;')}, 'skipConflicts')">Import New Only</button>
                `;
            } else {
                actions.innerHTML = `
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmImport(${JSON.stringify(analysis.new).replace(/"/g, '&quot;')})">Import ${analysis.new.length} Episodes</button>
                `;
            }

            document.getElementById('modal-title').textContent = 'Import Review';
            modal.classList.add('active');
        }

        function reviewConflicts(analysis) {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            let conflictsHTML = `
                <p style="margin-bottom: 16px;">Review ${analysis.conflicts.length} conflicting episodes:</p>
                <div style="max-height: 400px; overflow-y: auto;">
            `;

            analysis.conflicts.forEach((conflict, index) => {
                const imported = conflict.imported;
                const existing = conflict.existing;
                const matchLabel = conflict.matchType === 'id' ? 'Same ID' : 'Similar Time';

                conflictsHTML += `
                    <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--accent-red);">
                        <div style="margin-bottom: 8px; font-weight: 600; color: var(--accent-red);">
                            Conflict #${index + 1} (${matchLabel})
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.9rem;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px; color: var(--accent-green);">üì• Importing:</div>
                                <div>Date: ${formatDate(new Date(imported.startTime))}</div>
                                <div>Time: ${formatTime(new Date(imported.startTime))}</div>
                                <div>Pain: ${imported.painLevel}/10</div>
                                <div>Duration: ${formatDuration(imported.duration || 0)}</div>
                                ${imported.medication ? `<div>Med: ${imported.medication}</div>` : ''}
                            </div>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px; color: var(--accent-blue);">üíæ Existing:</div>
                                <div>Date: ${formatDate(new Date(existing.startTime))}</div>
                                <div>Time: ${formatTime(new Date(existing.startTime))}</div>
                                <div>Pain: ${existing.painLevel}/10</div>
                                <div>Duration: ${formatDuration(existing.duration || 0)}</div>
                                ${existing.medication ? `<div>Med: ${existing.medication}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            conflictsHTML += `</div>`;

            body.innerHTML = conflictsHTML;

            const actions = document.getElementById('modal-actions');
            actions.innerHTML = `
                <button class="btn btn-secondary" onclick="showImportReviewModal([], ${JSON.stringify(analysis).replace(/"/g, '&quot;')})">Back</button>
                <button class="btn btn-secondary" onclick="importWithStrategy(${JSON.stringify(analysis).replace(/"/g, '&quot;')}, 'skipConflicts')">Skip Conflicts</button>
                <button class="btn btn-primary" onclick="importWithStrategy(${JSON.stringify(analysis).replace(/"/g, '&quot;')}, 'replaceConflicts')">Replace Existing</button>
            `;

            document.getElementById('modal-title').textContent = 'Review Conflicts';
        }

        function importWithStrategy(analysis, strategy) {
            let importedCount = 0;

            // Always import new episodes
            analysis.new.forEach(episode => {
                migraines.push(episode);
                importedCount++;
            });

            // Handle conflicts based on strategy
            if (strategy === 'replaceConflicts') {
                analysis.conflicts.forEach(conflict => {
                    // Remove existing and add new
                    const index = migraines.findIndex(m => m.id === conflict.existing.id);
                    if (index !== -1) {
                        migraines[index] = conflict.imported;
                        importedCount++;
                    }
                });
            }
            // If 'skipConflicts', we just don't import them

            // Sort migraines by startTime
            migraines.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

            saveData();
            renderHistory();
            updateDashboard();
            renderCalendar();
            updateStorageInfo();

            closeModal();

            let message = `Successfully imported ${importedCount} episodes.`;
            if (strategy === 'skipConflicts' && analysis.conflicts.length > 0) {
                message += `\n\nSkipped ${analysis.conflicts.length} conflicting episodes.`;
            }

            showModal('Import Complete', message);
        }

        function confirmImport(newEpisodes) {
            newEpisodes.forEach(episode => {
                migraines.push(episode);
            });

            // Sort migraines by startTime
            migraines.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

            saveData();
            renderHistory();
            updateDashboard();
            renderCalendar();
            updateStorageInfo();

            closeModal();
            showModal('Import Complete', `Successfully imported ${newEpisodes.length} episodes.`);
        }

        function showPDFDateRangeModal() {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            body.innerHTML = `
                <p style="margin-bottom: 20px; color: var(--text-secondary);">Select a date range for your doctor report:</p>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="settings-btn" onclick="exportPDF('7days')">
                        <span>üìÖ Last 7 Days</span>
                    </button>
                    <button class="settings-btn" onclick="exportPDF('30days')">
                        <span>üìÖ Last 30 Days</span>
                    </button>
                    <button class="settings-btn" onclick="exportPDF('90days')">
                        <span>üìÖ Last 90 Days</span>
                    </button>
                    <button class="settings-btn" onclick="showCustomDateRange()">
                        <span>üìÖ Custom Range</span>
                    </button>
                </div>
            `;

            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            `;

            document.getElementById('modal-title').textContent = 'Export PDF Report';
            modal.classList.add('active');
        }

        function showCustomDateRange() {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');

            const today = new Date().toISOString().split('T')[0];
            const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            body.innerHTML = `
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="custom-start-date" value="${monthAgo}" max="${today}"
                           style="width: 100%; padding: 12px; background: var(--bg-tertiary);
                                  border: 1px solid var(--border-color); border-radius: 8px;
                                  color: var(--text-primary); font-size: 1rem;">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="custom-end-date" value="${today}" max="${today}"
                           style="width: 100%; padding: 12px; background: var(--bg-tertiary);
                                  border: 1px solid var(--border-color); border-radius: 8px;
                                  color: var(--text-primary); font-size: 1rem;">
                </div>
            `;

            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="showPDFDateRangeModal()">Back</button>
                <button class="btn btn-primary" onclick="exportCustomPDF()">Generate PDF</button>
            `;

            document.getElementById('modal-title').textContent = 'Custom Date Range';
        }

        function exportCustomPDF() {
            const startDate = document.getElementById('custom-start-date').value;
            const endDate = document.getElementById('custom-end-date').value;

            if (!startDate || !endDate) {
                showModal('Error', 'Please select both start and end dates.');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showModal('Error', 'Start date must be before end date.');
                return;
            }

            exportPDF('custom', startDate, endDate);
        }

        function exportPDF(rangeType, customStart, customEnd) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Calculate date range
            let startDate, endDate;
            const now = new Date();

            if (rangeType === 'custom') {
                startDate = new Date(customStart);
                endDate = new Date(customEnd);
                endDate.setHours(23, 59, 59, 999);
            } else {
                endDate = now;
                const days = rangeType === '7days' ? 7 : rangeType === '30days' ? 30 : 90;
                startDate = new Date(now - days * 24 * 60 * 60 * 1000);
            }

            // Filter episodes in range
            const activeMigraines = getActiveMigraines();
            const episodesInRange = activeMigraines.filter(m => {
                const episodeDate = new Date(m.startTime);
                return episodeDate >= startDate && episodeDate <= endDate;
            });

            // Generate PDF
            let yPos = 20;

            // Title
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('Migraine Report', 105, yPos, { align: 'center' });
            yPos += 10;

            // Date range
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            const dateRangeStr = `${formatDate(startDate)} - ${formatDate(endDate)}`;
            doc.text(dateRangeStr, 105, yPos, { align: 'center' });
            yPos += 15;

            // Patient Information Section (blank for handwriting)
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Patient Information', 20, yPos);
            yPos += 8;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Name: _______________________________________', 20, yPos);
            yPos += 7;
            doc.text('Date of Birth: _______________', 20, yPos);
            doc.text('Visit Date: _______________', 120, yPos);
            yPos += 15;

            // Summary Statistics
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Summary Statistics', 20, yPos);
            yPos += 8;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');

            const totalEpisodes = episodesInRange.length;
            const avgPain = totalEpisodes > 0
                ? (episodesInRange.reduce((sum, m) => sum + m.painLevel, 0) / totalEpisodes).toFixed(1)
                : 0;
            const avgDuration = totalEpisodes > 0
                ? episodesInRange.reduce((sum, m) => sum + (m.duration || 0), 0) / totalEpisodes
                : 0;

            const severeCount = episodesInRange.filter(m => m.painLevel >= 7).length;
            const moderateCount = episodesInRange.filter(m => m.painLevel >= 4 && m.painLevel < 7).length;
            const mildCount = episodesInRange.filter(m => m.painLevel < 4).length;

            doc.text(`Total Episodes: ${totalEpisodes}`, 20, yPos);
            yPos += 6;
            doc.text(`Average Pain Level: ${avgPain}/10`, 20, yPos);
            yPos += 6;
            doc.text(`Average Duration: ${formatDuration(Math.floor(avgDuration))}`, 20, yPos);
            yPos += 6;
            doc.text(`Severity Distribution: Severe (${severeCount}), Moderate (${moderateCount}), Mild (${mildCount})`, 20, yPos);
            yPos += 15;

            // Episode Details
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Episode Details', 20, yPos);
            yPos += 8;

            if (totalEpisodes === 0) {
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('No episodes recorded in this date range.', 20, yPos);
            } else {
                // Table header
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text('Date', 20, yPos);
                doc.text('Time', 50, yPos);
                doc.text('Pain', 75, yPos);
                doc.text('Duration', 95, yPos);
                doc.text('Medication', 125, yPos);
                yPos += 5;

                // Line under header
                doc.line(20, yPos, 190, yPos);
                yPos += 5;

                // Episode rows
                doc.setFont(undefined, 'normal');
                const sortedEpisodes = [...episodesInRange].sort((a, b) =>
                    new Date(b.startTime) - new Date(a.startTime)
                );

                for (const episode of sortedEpisodes) {
                    // Check if we need a new page
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }

                    const epStart = new Date(episode.startTime);
                    const painStr = episode.painHistory && episode.painHistory.length > 1
                        ? `${episode.painHistory[0].level}‚Üí${episode.painLevel}`
                        : `${episode.painLevel}/10`;

                    doc.text(formatDate(epStart), 20, yPos);
                    doc.text(formatTime(epStart), 50, yPos);
                    doc.text(painStr, 75, yPos);
                    doc.text(formatDuration(episode.duration || 0), 95, yPos);

                    const medText = episode.medication || 'None';
                    const maxMedWidth = 65;
                    if (doc.getTextWidth(medText) > maxMedWidth) {
                        doc.text(medText.substring(0, 25) + '...', 125, yPos);
                    } else {
                        doc.text(medText, 125, yPos);
                    }

                    yPos += 5;

                    // Add notes if present
                    if (episode.notes) {
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'italic');
                        const noteLines = doc.splitTextToSize(`Notes: ${episode.notes}`, 170);
                        doc.text(noteLines, 25, yPos);
                        yPos += noteLines.length * 4;
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                    }

                    yPos += 2;
                }
            }

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setFont(undefined, 'italic');
                doc.text(`Generated by Aiding Migraine on ${formatDate(new Date())}`, 105, 285, { align: 'center' });
                doc.text(`Page ${i} of ${pageCount}`, 190, 285, { align: 'right' });
            }

            // Save PDF
            const startDateStr = formatDateFile(startDate);
            const endDateStr = formatDateFile(endDate);
            const filename = `migraine-report-${startDateStr}-to-${endDateStr}.pdf`;
            doc.save(filename);

            closeModal();
            showModal('PDF Exported', `Your migraine report has been saved as ${filename}`);
        }

        function showHowTo() {
            const content = `
                <h3>Logging Episodes</h3>
                <p>1. Select your pain level (0-10)</p>
                <p>2. Optionally add medication and notes</p>
                <p>3. Tap "Log Episode"</p>
                
                <h3>Active Episodes</h3>
                <p>‚Ä¢ Update pain as it changes</p>
                <p>‚Ä¢ End episode when resolved</p>
                <p>‚Ä¢ Duration tracked automatically</p>
                
                <h3>Viewing History</h3>
                <p>‚Ä¢ All episodes listed in History tab</p>
                <p>‚Ä¢ Calendar shows severity by color</p>
                <p>‚Ä¢ Stats dashboard shows trends</p>
                
                <h3>Backing Up Data</h3>
                <p>‚Ä¢ Export regularly from Settings</p>
                <p>‚Ä¢ Keep backup file safe</p>
                <p>‚Ä¢ Import on new device</p>
            `;
            showModal('How to Use', content);
        }

        function showAbout() {
            const content = `
                <p><strong>Aiding Migraine v1.5.0</strong></p>
                <p>Built with care for migraine sufferers.</p>
                
                <h3>Features</h3>
                <ul>
                    <li>Easy pain tracking</li>
                    <li>Duration monitoring</li>
                    <li>Pattern visualization</li>
                    <li>Privacy-focused</li>
                    <li>Export & backup</li>
                </ul>
                
                <p style="margin-top: 20px; color: var(--text-secondary);">
                    Created by someone who understands the struggle of managing migraines.
                </p>
            `;
            showModal('About This App', content);
        }

        function showPrivacy() {
            const content = `
                <h3>Your Privacy Matters</h3>
                
                <p><strong>‚úì All data stored locally</strong><br>
                Your information never leaves your device.</p>
                
                <p><strong>‚úì No cloud uploads</strong><br>
                No servers, no tracking, no analytics.</p>
                
                <p><strong>‚úì No account required</strong><br>
                Start using immediately, privately.</p>
                
                <p><strong>‚úì You own your data</strong><br>
                Export anytime, delete anytime.</p>
                
                <h3>Data Storage</h3>
                <p>Your migraine data is stored only on this device using browser storage.</p>
                
                <h3>Backup Recommendation</h3>
                <p>Export your data regularly to prevent loss if you clear browser data.</p>
                
                <p style="margin-top: 20px; color: var(--text-secondary); font-size: 0.9rem;">
                    <strong>Note:</strong> This app is not HIPAA compliant and should not be used for official medical records. Always consult healthcare providers.
                </p>
            `;
            showModal('Privacy & Your Data', content);
        }

        function clearAllData() {
            const modal = document.getElementById('modal');
            document.getElementById('modal-title').textContent = '‚ö†Ô∏è Delete All Data?';
            document.getElementById('modal-body').innerHTML = `
                <p><strong>This will permanently delete ALL ${migraines.length} episodes and cannot be undone.</strong></p>
                <p style="margin-top: 12px;">We recommend exporting a backup first.</p>
            `;
            document.getElementById('modal-actions').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-secondary" onclick="exportJSON(); closeModal();">Export First</button>
                <button class="btn btn-primary" style="background: var(--accent-red);" onclick="confirmClearAll()">Delete All</button>
            `;
            modal.classList.add('active');
        }

        function confirmClearAll() {
            migraines = [];
            activeMigraine = null;
            localStorage.clear();
            
            saveData();
            renderHistory();
            updateDashboard();
            renderCalendar();
            updateStorageInfo();
            checkActiveMigraine();
            
            closeModal();
            showModal('Data Cleared', 'All data has been deleted.');
        }

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal-actions').innerHTML = '<button class="btn btn-primary" onclick="closeModal()">Close</button>';
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function showWelcomeModal() {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            const actions = document.getElementById('modal-actions');

            body.innerHTML = `
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">ü§ï</div>
                    <h2 style="margin-bottom: 16px; font-size: 1.5rem;">Welcome to Aiding Migraine</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 20px; line-height: 1.8;">
                        Your personal migraine tracking companion. Log episodes, track patterns,
                        and generate professional reports for your healthcare provider.
                    </p>
                    <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 20px; margin: 24px 0; text-align: left;">
                        <h3 style="font-size: 1.1rem; margin-bottom: 12px; text-align: center;">‚ú® Key Features</h3>
                        <ul style="list-style: none; padding: 0; color: var(--text-secondary); line-height: 2;">
                            <li>üìù <strong>Easy Logging:</strong> Track pain levels, triggers, and medications</li>
                            <li>üìä <strong>Visual History:</strong> Calendar view and detailed statistics</li>
                            <li>üìÑ <strong>PDF Reports:</strong> Professional reports for doctor visits</li>
                            <li>üíæ <strong>Secure Backup:</strong> Import/export your data safely</li>
                            <li>üóëÔ∏è <strong>Smart Recovery:</strong> 30-day trash for deleted episodes</li>
                        </ul>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 16px;">
                        All your data stays private on your device. Nothing is sent to any server.
                    </p>
                </div>
            `;

            actions.innerHTML = `
                <button class="btn btn-secondary" onclick="closeWelcome()">Get Started</button>
                <button class="btn btn-primary" onclick="startGuidedTour()">Take a Tour</button>
            `;

            document.getElementById('modal-title').textContent = '';
            modal.classList.add('active');
        }

        function closeWelcome() {
            localStorage.setItem('hasSeenWelcome', 'true');
            closeModal();
        }

        function checkFirstTimeUser() {
            const hasSeenWelcome = localStorage.getItem('hasSeenWelcome');
            if (!hasSeenWelcome) {
                // Small delay to let the page load first
                setTimeout(() => {
                    showWelcomeModal();
                }, 500);
            }
        }

        let tourStep = 0;
        const tourSteps = [
            {
                title: 'Log a Migraine Episode',
                description: 'Select your pain level (1-10) and click "Start Episode" to begin tracking. You can update pain levels and add notes during the episode.',
                target: '.pain-scale',
                page: 'log',
                position: 'bottom'
            },
            {
                title: 'Episode History',
                description: 'View all your past episodes here. You can edit notes, view details, or delete episodes. Deleted episodes go to trash for 30 days.',
                target: '.nav-btn[data-page="history"]',
                page: 'log',
                position: 'top'
            },
            {
                title: 'Calendar View',
                description: 'The Dashboard shows your migraine patterns over time. Click any day to see episodes logged that day.',
                target: '.calendar-header',
                page: 'log',
                position: 'bottom'
            },
            {
                title: 'Export & Backup',
                description: 'Export your data as PDF for doctor visits or JSON for backups. You can also import data to restore or merge from another device.',
                target: '.nav-btn[data-page="settings"]',
                page: 'log',
                position: 'top'
            },
            {
                title: 'Your Data is Private',
                description: 'Everything is stored locally on your device. No data is sent to any server. Remember to export backups regularly!',
                target: null,
                page: 'log',
                position: 'center'
            }
        ];

        function startGuidedTour() {
            localStorage.setItem('hasSeenWelcome', 'true');
            closeModal();
            tourStep = 0;
            showTourStep();
        }

        function showTourStep() {
            const step = tourSteps[tourStep];

            // Switch to the required page
            if (step.page !== currentPage) {
                switchPage(step.page);
            }

            // Create or update tour overlay
            let overlay = document.getElementById('tour-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'tour-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.75);
                    z-index: 9998;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: fadeIn 0.3s ease;
                `;
                document.body.appendChild(overlay);
            }

            // Create tour tooltip
            let tooltip = document.getElementById('tour-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'tour-tooltip';
                document.body.appendChild(tooltip);
            }

            tooltip.style.cssText = `
                position: fixed;
                background: var(--bg-secondary);
                border: 2px solid var(--accent-blue);
                border-radius: 12px;
                padding: 24px;
                max-width: 400px;
                z-index: 9999;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
                animation: fadeIn 0.3s ease;
            `;

            tooltip.innerHTML = `
                <div style="margin-bottom: 8px; color: var(--accent-blue); font-size: 0.9rem; font-weight: 600;">
                    Step ${tourStep + 1} of ${tourSteps.length}
                </div>
                <h3 style="margin-bottom: 12px; font-size: 1.3rem;">${step.title}</h3>
                <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px;">
                    ${step.description}
                </p>
                <div style="display: flex; gap: 12px; justify-content: space-between;">
                    <button class="btn btn-secondary" onclick="skipTour()" style="flex: 1;">
                        Skip Tour
                    </button>
                    <button class="btn btn-primary" onclick="nextTourStep()" style="flex: 1;">
                        ${tourStep === tourSteps.length - 1 ? 'Finish' : 'Next'}
                    </button>
                </div>
            `;

            // Position tooltip
            if (step.target) {
                const targetEl = document.querySelector(step.target);
                if (targetEl) {
                    const rect = targetEl.getBoundingClientRect();

                    // Highlight the target element
                    targetEl.style.position = 'relative';
                    targetEl.style.zIndex = '9999';
                    targetEl.style.boxShadow = '0 0 0 4px var(--accent-blue), 0 0 20px rgba(107, 139, 184, 0.5)';
                    targetEl.style.borderRadius = '8px';
                    targetEl.setAttribute('data-tour-highlight', 'true');

                    if (step.position === 'bottom') {
                        tooltip.style.top = `${rect.bottom + 20}px`;
                        tooltip.style.left = `${rect.left + rect.width / 2}px`;
                        tooltip.style.transform = 'translateX(-50%)';
                    } else if (step.position === 'top') {
                        tooltip.style.bottom = `${window.innerHeight - rect.top + 20}px`;
                        tooltip.style.left = `${rect.left + rect.width / 2}px`;
                        tooltip.style.transform = 'translateX(-50%)';
                    }
                }
            } else {
                // Center tooltip
                tooltip.style.top = '50%';
                tooltip.style.left = '50%';
                tooltip.style.transform = 'translate(-50%, -50%)';
            }
        }

        function nextTourStep() {
            // Remove highlight from previous step
            const highlighted = document.querySelector('[data-tour-highlight]');
            if (highlighted) {
                highlighted.style.position = '';
                highlighted.style.zIndex = '';
                highlighted.style.boxShadow = '';
                highlighted.style.borderRadius = '';
                highlighted.removeAttribute('data-tour-highlight');
            }

            tourStep++;
            if (tourStep < tourSteps.length) {
                showTourStep();
            } else {
                endTour();
            }
        }

        function skipTour() {
            endTour();
        }

        function endTour() {
            // Remove highlight
            const highlighted = document.querySelector('[data-tour-highlight]');
            if (highlighted) {
                highlighted.style.position = '';
                highlighted.style.zIndex = '';
                highlighted.style.boxShadow = '';
                highlighted.style.borderRadius = '';
                highlighted.removeAttribute('data-tour-highlight');
            }

            // Remove overlay and tooltip
            const overlay = document.getElementById('tour-overlay');
            const tooltip = document.getElementById('tour-tooltip');
            if (overlay) overlay.remove();
            if (tooltip) tooltip.remove();

            tourStep = 0;
        }

        document.querySelector('.modal-close').addEventListener('click', closeModal);

        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') {
                closeModal();
            }
        });

        function getPainCategory(level) {
            if (level <= 3) return 'Mild';
            if (level <= 6) return 'Moderate';
            return 'Severe';
        }

        function getPainProgression(migraine) {
            if (!migraine.painHistory || migraine.painHistory.length <= 1) {
                return `${migraine.painLevel}/10`;
            }
            
            const first = migraine.painHistory[0].level;
            const last = migraine.painHistory[migraine.painHistory.length - 1].level;
            
            if (last < first) {
                return `${first} ‚Üí ${last} ‚Üì Improving`;
            } else if (last > first) {
                return `${first} ‚Üí ${last} ‚Üë Worsening`;
            } else {
                return `${first} ‚Üí Stable`;
            }
        }

        function formatDuration(seconds) {
            if (!seconds) return '0m';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
        }

        function formatDateFile(date) {
            return date.toISOString().split('T')[0];
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }

        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return formatDate(date);
        }
    </script>
</body>
</html>